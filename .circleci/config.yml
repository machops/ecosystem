# IndestructibleEco v1.0 â€” CircleCI Configuration
# URI: indestructibleeco://ci/circleci
# Note: Primary CI/CD is GitHub Actions (.github/workflows/ci.yaml)
#       This CircleCI config is a secondary/fallback pipeline.

version: 2.1

jobs:
  lint-and-test:
    docker:
      - image: cimg/python:3.11-node
    steps:
      - checkout
      - run:
          name: "Python lint"
          command: |
            python3 -m py_compile backend/ai/src/app.py
            python3 -m py_compile backend/ai/src/config.py
            python3 -m py_compile backend/ai/src/routes.py
            python3 -m py_compile backend/ai/src/governance.py
            python3 -m py_compile backend/shared/models/__init__.py
            python3 -m py_compile backend/shared/utils/__init__.py
            echo "Python lint passed"
      - run:
          name: "JS syntax check"
          command: |
            node --check tools/yaml-toolkit/bin/cli.js
            echo "JS syntax check passed"
      - run:
          name: "YAML governance lint"
          command: |
            FAIL=0
            for f in $(find backend/k8s k8s -name "*.qyaml" -type f 2>/dev/null); do
              echo "Checking $f"
              for block in document_metadata governance_info registry_binding vector_alignment_map; do
                if ! grep -q "${block}:" "$f"; then
                  echo "FAIL: Missing $block in $f"
                  FAIL=1
                fi
              done
            done
            if [ "$FAIL" -eq 1 ]; then exit 1; fi
            echo "All .qyaml files passed governance validation"

workflows:
  indestructibleeco-ci:
    jobs:
      - lint-and-test