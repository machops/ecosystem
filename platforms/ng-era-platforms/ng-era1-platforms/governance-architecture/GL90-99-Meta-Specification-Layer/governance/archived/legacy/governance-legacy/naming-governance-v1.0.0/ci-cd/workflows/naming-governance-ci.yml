# @GL-governed
# @GL-layer: GL90-99
# @GL-semantic: governed-configuration
# @GL-audit-trail: engine/governance/GL_SEMANTIC_ANCHOR.json

# ==============================================================================
# MachineNativeOps Naming Governance CI/CD Pipeline
# ==============================================================================
# Metadata:
#   version: v1.0.0
metadata:
  name: ""
  description: ""
  labels: {}

#   description: CI/CD pipeline for naming governance validation and compliance
#   author: MachineNativeOps DevOps Team
#   last_updated: 2026-01-23
#   review_date: 2027-01-23
# ==============================================================================

name: å‘½åæ²»ç† CI/CD ç®¡é“ v1.0.0

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'k8s/**'
      - 'helm/**'
      - 'templates/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'k8s/**'
      - 'helm/**'
      - 'templates/**'
  schedule:
    # æ¯æ—¥ UTC 02:00 åŸ·è¡Œå®šæœŸç¨½æ ¸
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'æƒæé¡å‹'
        required: true
        type: choice
        options:
          - validation
          - compliance
          - full

env:
  PYTHON_VERSION: '3.11'
  SPEC_VERSION: 'v1.0.0'

jobs:
  # Job 1: å‘½åè¦ç¯„é©—è­‰
  naming-validation:
    name: å‘½åè¦ç¯„é©—è­‰
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£ä¾è³´
        run: |
          pip install pyyaml jsonschema
          chmod +x naming-governance-v1.0.0/scripts/validation/naming_validator.py
      
      - name: åŸ·è¡Œå‘½åé©—è­‰
        run: |
          python naming-governance-v1.0.0/scripts/validation/naming_validator.py \
            --spec naming-governance-v1.0.0/config/machine-spec.yaml \
            --directory k8s \
            --pattern "*.yaml" \
            --format json \
            --output validation-report.json \
            --strict
      
      - name: ä¸Šå‚³é©—è­‰å ±å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: naming-validation-report
          path: validation-report.json
          retention-days: 30
      
      - name: ç™¼å¸ƒé©—è­‰çµæœæ‘˜è¦
        if: always()
        run: |
          if [ -f validation-report.json ]; then
            echo "## å‘½åé©—è­‰çµæœ" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat validation-report.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # Job 2: åˆè¦æ€§æª¢æŸ¥
  compliance-check:
    name: åˆè¦æ€§æª¢æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: naming-validation
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
      
      - name: è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£ä¾è³´
        run: |
          pip install pyyaml requests
          chmod +x naming-governance-v1.0.0/scripts/validation/naming_validator.py
      
      - name: åŸ·è¡Œåˆè¦æ€§æª¢æŸ¥
        run: |
          python naming-governance-v1.0.0/scripts/validation/naming_validator.py \
            --spec naming-governance-v1.0.0/config/machine-spec.yaml \
            --directory helm \
            --pattern "*.yaml" \
            --format yaml \
            --output compliance-report.yaml
      
      - name: ç”Ÿæˆåˆè¦æ€§æŒ‡æ¨™
        run: |
          python << 'EOF'
          import yaml
          import json
          
          try:
            with open('compliance-report.yaml', 'r') as f:
              report = yaml.safe_load(f)
            
            if report and 'violations' in report:
              total = len(report['violations'])
              critical = sum(1 for v in report['violations'] if v['severity'] == 'critical')
              high = sum(1 for v in report['violations'] if v['severity'] == 'high')
              
              compliance_rate = ((total - critical - high) / max(total, 1)) * 100
              
              metrics = {
                "compliance_rate": round(compliance_rate, 2),
                "total_violations": total,
                "critical_violations": critical,
                "high_violations": high,
                "status": "compliant" if compliance_rate >= 95 else "non-compliant"
              }
              
              with open('compliance-metrics.json', 'w') as f:
                json.dump(metrics, f, indent=2)
              
              print(f"åˆè¦ç‡: {metrics['compliance_rate']}%")
              print(f"ç‹€æ…‹: {metrics['status']}")
              
              if compliance_rate < 95:
                exit(1)
          except Exception as e:
            print(f"éŒ¯èª¤: {e}")
            exit(1)
          EOF
      
      - name: ä¸Šå‚³åˆè¦æ€§å ±å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: |
            compliance-report.yaml
            compliance-metrics.json
          retention-days: 30

  # Job 3: æ¨™ç±¤é©—è­‰
  labels-validation:
    name: æ¨™ç±¤é©—è­‰
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: naming-validation
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
      
      - name: è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£ä¾è³´
        run: pip install pyyaml kubernetes
      
      - name: é©—è­‰å¿…è¦æ¨™ç±¤
        run: |
          python << 'EOF'
          import yaml
          import sys
          from pathlib import Path
          
          required_labels = [
            'app.kubernetes.io/name',
            'app.kubernetes.io/managed-by',
            'environment',
            'tenant',
            'version'
          ]
          
          violations = []
          
          for yaml_file in Path('k8s').rglob('*.yaml'):
            try:
              with open(yaml_file, 'r') as f:
                docs = list(yaml.safe_load_all(f))
              
              for doc in docs:
                if not doc or 'metadata' not in doc:
                  continue
                
                metadata = doc['metadata']
                labels = metadata.get('labels', {})
                name = metadata.get('name', 'unknown')
                
                missing = [label for label in required_labels if label not in labels]
                if missing:
                  violations.append({
                    'file': str(yaml_file),
                    'resource': name,
                    'missing_labels': missing
                  })
            except Exception as e:
              print(f"è­¦å‘Š: ç„¡æ³•è§£æ {yaml_file}: {e}")
          
          if violations:
            print("âŒ æ¨™ç±¤é©—è­‰å¤±æ•—:")
            for v in violations:
              print(f"  {v['file']} - {v['resource']}: ç¼ºå°‘ {', '.join(v['missing_labels'])}")
            sys.exit(1)
          else:
            print("âœ… æ¨™ç±¤é©—è­‰é€šé")
          EOF

  # Job 4: ç”Ÿæˆå‘½åå ±å‘Š
  generate-report:
    name: ç”Ÿæˆæ²»ç†å ±å‘Š
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [compliance-check, labels-validation]
    if: always()
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
      
      - name: ä¸‹è¼‰æ‰€æœ‰å ±å‘Š
        uses: actions/download-artifact@v4
        with:
          path: reports
      
      - name: ç”Ÿæˆç¶œåˆå ±å‘Š
        run: |
          cat << 'EOF' > governance-report.md
          # å‘½åæ²»ç†å ±å‘Š
          
          **ç”Ÿæˆæ™‚é–“**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **è¦ç¯„ç‰ˆæœ¬**: ${{ env.SPEC_VERSION }}
          **è§¸ç™¼æ–¹å¼**: ${{ github.event_name }}
          
          ## é©—è­‰æ‘˜è¦
          
          - å‘½åé©—è­‰: ${{ needs.naming-validation.result }}
          - åˆè¦æ€§æª¢æŸ¥: ${{ needs.compliance-check.result }}
          - æ¨™ç±¤é©—è­‰: ${{ needs.labels-validation.result }}
          
          ## è©³ç´°å ±å‘Š
          
          è«‹æŸ¥çœ‹ä¸‹è¼‰çš„å ±å‘Šæ–‡ä»¶ä»¥ç²å–è©³ç´°è³‡è¨Šã€‚
          EOF
      
      - name: ä¸Šå‚³ç¶œåˆå ±å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: governance-report
          path: governance-report.md
          retention-days: 90

  # Job 5: å®‰å…¨æƒæ
  security-scan:
    name: å®‰å…¨æƒæ
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
      
      - name: é‹è¡Œ Trivy æƒæ
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'k8s'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: ä¸Šå‚³æƒæçµæœ
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Job 6: å®šæœŸç¨½æ ¸ (åƒ…åœ¨å®šæ™‚è§¸ç™¼æ™‚åŸ·è¡Œ)
  scheduled-audit:
    name: å®šæœŸç¨½æ ¸
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'schedule'
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
      
      - name: è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£ä¾è³´
        run: |
          pip install pyyaml requests
          chmod +x naming-governance-v1.0.0/scripts/validation/naming_validator.py
      
      - name: åŸ·è¡Œå®Œæ•´ç¨½æ ¸
        run: |
          python naming-governance-v1.0.0/scripts/validation/naming_validator.py \
            --spec naming-governance-v1.0.0/config/machine-spec.yaml \
            --directory . \
            --pattern "*.yaml" \
            --format json \
            --output scheduled-audit-report.json
      
      - name: å‰µå»ºç¨½æ ¸ Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('scheduled-audit-report.json', 'utf8'));
            
            const body = `## å®šæœŸå‘½åç¨½æ ¸å ±å‘Š
            
            **åŸ·è¡Œæ™‚é–“**: ${new Date().toISOString()}
            **é•è¦æ•¸é‡**: ${report.summary.total_violations}
            
            ### åš´é‡ç¨‹åº¦åˆ†å¸ƒ
            - ğŸ”´ CRITICAL: ${report.summary.critical}
            - ğŸŸ  HIGH: ${report.summary.high}
            - ğŸŸ¡ MEDIUM: ${report.summary.medium}
            - ğŸŸ¢ LOW: ${report.summary.low}
            
            ### é•è¦è©³æƒ…
            
            ${report.violations.slice(0, 10).map((v, i) => `
            ${i + 1}. **${v.resource_name}** (${v.resource_type})
               - è¦å‰‡: ${v.rule}
               - æè¿°: ${v.description}
               - å»ºè­°: ${v.suggested_fix}
            `).join('\n')}
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `å‘½åç¨½æ ¸å ±å‘Š - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['audit', 'naming-governance', 'compliance']
            });

  # Job 7: é€šçŸ¥
  notify:
    name: ç™¼é€é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [generate-report, security-scan]
    if: always()
    
    steps:
      - name: ç™¼é€å¤±æ•—é€šçŸ¥
        if: |
          needs.generate-report.result == 'failure' ||
          needs.security-scan.result == 'failure'
        run: |
          echo "âŒ CI/CD ç®¡é“åŸ·è¡Œå¤±æ•—"
          echo "è«‹æª¢æŸ¥æ—¥èªŒä»¥ç²å–è©³ç´°è³‡è¨Š"
          exit 1
      
      - name: ç™¼é€æˆåŠŸé€šçŸ¥
        if: |
          needs.generate-report.result == 'success' &&
          needs.security-scan.result == 'success'
        run: |
          echo "âœ… CI/CD ç®¡é“åŸ·è¡ŒæˆåŠŸ"
          echo "æ‰€æœ‰æª¢æŸ¥å‡å·²é€šé"