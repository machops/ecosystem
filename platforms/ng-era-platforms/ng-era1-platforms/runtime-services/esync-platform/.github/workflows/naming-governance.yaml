# @ECO-governed
# @ECO-layer: GL90-99
# @ECO-semantic: naming-governance
# @ECO-audit-trail: gl-enterprise-architecture/governance/audit-trails/GL90_99-audit.json
#
# GL Unified Charter Activated
# GL Root Semantic Anchor: gl-enterprise-architecture/governance/ECO-ROOT-SEMANTIC-ANCHOR.yaml
# GL Unified Naming Charter: gl-enterprise-architecture/governance/ECO-UNIFIED-NAMING-CHARTER.yaml


name: Naming Governance Enforcement

on:
  push:
    paths:
      - 'deploy/**'
      - '.config/**'
  pull_request:
    paths:
      - 'deploy/**'
      - '.config/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: naming-governance-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-naming:
    name: Validate Naming Conventions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Set up Python
        uses: actions/setup-python@v5  # v5.0.0
        with:
          python-version: '3.11'

  labels:
    eco-base/part-of: eco-base
    eco-base/governance: aligned {}

          cache: 'pip'

      - name: Install Conftest
        run: pip install -q conftest

      - name: Run Conftest Validation
        run: |
          conftest test deploy/ -p .config/conftest/policies/ --output json > artifacts/reports/naming/validation-results.json

      - name: Generate Report
        if: always()
        run: |
          cat > artifacts/reports/naming/validation-report.md << 'EOF'
          # Naming Convention Validation Report
          
          ## Validation Summary
          - **Run ID**: ${{ github.run_id }}
          - **Triggered by**: ${{ github.event_name }}
          - **Timestamp**: ${{ github.event.head_commit.timestamp }}
          
          ## Results
          ```json
          $(cat artifacts/reports/naming/validation-results.json)
          ```
          
          ## Actions Required
          - [ ] Review any naming violations
          - [ ] Apply migration playbook if needed
          - [ ] Update documentation
          
          ---
          
          ðŸ¤– *Generated by Naming Governance Workflow*
          EOF

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7  # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('artifacts/reports/naming/validation-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  auto-remediate:
    name: Auto-Remediate Naming Issues
    runs-on: ubuntu-latest
    needs: validate-naming
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Run Discovery
        run: |
          bash scripts/naming/discover.sh

      - name: Run Remediation
        run: |
          bash scripts/naming/remediate.sh

      - name: Check for Changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has-changes == 'true'
        uses: peter-evans/create-pull-request@b1ddad2c994a25fbc81a28b5ec28e3948fa99e77  # v6.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "[Auto-fix] Apply naming convention remediations"
          title: "[Auto-fix] Apply naming convention remediations"
          body: |
            ## Naming Convention Remediation
            
            This PR automatically applies naming convention fixes.
            
            ### Changes
            - Added required labels to Kubernetes resources
            - Ensured naming convention compliance
            - Generated migration plan
            
            ### Verification
            - [x] Conftest validation passed
            - [x] Policy checks passed
            
            ---
            
            ðŸ¤– *Generated by Naming Governance Workflow*
          branch: auto-fix/naming-${{ github.run_number }}
          labels:
    eco-base/part-of: eco-base
    eco-base/governance: aligned auto-fix, naming
          draft: false