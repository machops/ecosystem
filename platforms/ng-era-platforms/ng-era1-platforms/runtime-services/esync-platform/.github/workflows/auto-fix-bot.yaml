# @ECO-governed
# @ECO-layer: GL00-09
# @ECO-semantic: general-component
# @ECO-audit-trail: gl-enterprise-architecture/governance/audit-trails/GL00_09-audit.json
#
# GL Unified Charter Activated
# GL Root Semantic Anchor: gl-enterprise-architecture/governance/ECO-ROOT-SEMANTIC-ANCHOR.yaml
# GL Unified Naming Charter: gl-enterprise-architecture/governance/ECO-UNIFIED-NAMING-CHARTER.yaml


name: Auto-Fix Bot

on:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
  repository_dispatch:
    types: [trigger-auto-fix]

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write

concurrency:
  group: auto-fix-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect-issues:
    name: Detect Issues
    runs-on: ubuntu-latest
    outputs:
      has-issues: ${{ steps.detect.outputs.has-issues }}
      issues-count: ${{ steps.detect.outputs.issues-count }}
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Set up Python
        uses: actions/setup-python@v5  # v5.0.0
        with:
          python-version: '3.11'
metadata:
  annotations:
    eco-base/urn: "urn:eco-base:platform:resource:ng-era-platforms:ng-era1-platforms:runtime-services:esync-platform:.github:workflows:auto-fix-bot.yaml"
    eco-base/uri: "eco-base://platform/resource/ng-era-platforms/ng-era1-platforms/runtime-services/esync-platform/.github/workflows/auto-fix-bot.yaml"
  name: ""
  description: ""
  labels:
    eco-base/part-of: eco-base
    eco-base/governance: aligned {}

          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install -q conftest yamllint
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

      - name: Run Detection Scripts
        id: detect
        run: |
          bash scripts/auto-fix/collect-issues.sh > artifacts/reports/auto-fix/detected-issues.json
          
          ISSUES_COUNT=$(jq '.issues | length' artifacts/reports/auto-fix/detected-issues.json)
          echo "issues-count=$ISSUES_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$ISSUES_COUNT" -gt 0 ]; then
            echo "has-issues=true" >> $GITHUB_OUTPUT
          else
            echo "has-issues=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Detection Report
        uses: actions/upload-artifact@1eb3cb2b3e0f296241caca2a7ab8ed34950fe83f  # v4.0.0
        with:
          name: detected-issues
          path: artifacts/reports/auto-fix/detected-issues.json
          retention-days: 7

  apply-fixes:
    name: Apply Fixes
    runs-on: ubuntu-latest
    needs: detect-issues
    if: needs.detect-issues.outputs.has-issues == 'true'
    strategy:
      matrix:
        fix-type: [actions-hardening, lint-format, deps-go, deps-node, docker-base]
      max-parallel: 3
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Set up Go
        uses: actions/setup-go@0c52d547c9bc32b1aa3301fd7a9cb496313a4491  # v5.0.0
        with:
          go-version: '1.21'
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4  # v4.0.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Download Detection Report
        uses: actions/download-artifact@v4  # v4.0.0
        with:
          name: detected-issues

      - name: Apply ${{ matrix.fix-type }} Fix
        run: |
          bash scripts/auto-fix/${{ matrix.fix-type }}.sh || true

      - name: Verify Fixes
        run: |
          make lint
          make test

      - name: Check for Changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has-changes == 'true'
        uses: peter-evans/create-pull-request@b1ddad2c994a25fbc81a28b5ec28e3948fa99e77  # v6.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "[Auto-fix] Apply ${{ matrix.fix-type }} fixes"
          title: "[Auto-fix] Apply ${{ matrix.fix-type }} fixes"
          body: |
            ## Auto-Fix Summary
            
            This PR automatically fixes issues detected by the auto-fix bot.
            
            **Fix Type**: ${{ matrix.fix-type }}
            **Triggered by**: ${{ github.event_name }}
            
            ### Changes
            - Applied automated fixes for ${{ matrix.fix-type }}
            
            ### Verification
            - [x] Lint passed
            - [x] Tests passed
            
            ---
            
            ðŸ¤– *This PR was automatically generated by the Auto-Fix Bot*
          branch: auto-fix/${{ matrix.fix-type }}-${{ github.run_number }}
          labels:
    eco-base/part-of: eco-base
    eco-base/governance: aligned auto-fix, automated
          draft: false

  generate-report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [detect-issues, apply-fixes]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Generate Report
        run: |
          cat > artifacts/reports/auto-fix/summary.md << 'EOF'
          # Auto-Fix Bot Execution Report
          
          ## Execution Summary
          - **Run ID**: ${{ github.run_id }}
          - **Triggered by**: ${{ github.event_name }}
          - **Timestamp**: ${{ github.event.head_commit.timestamp }}
          
          ## Issues Detected
          - Total Issues: ${{ needs.detect-issues.outputs.issues-count }}
          
          ## Fixes Applied
          - Actions Hardening: ${{ jobs.apply-fixes.result }}
          - Lint/Format: ${{ jobs.apply-fixes.result }}
          - Dependencies (Go): ${{ jobs.apply-fixes.result }}
          - Dependencies (Node): ${{ jobs.apply-fixes.result }}
          - Docker Base: ${{ jobs.apply-fixes.result }}
          
          ## Next Steps
          - Review the auto-generated PRs
          - Merge fixes after validation
          - Monitor for any issues
          
          ---
          
          ðŸ¤– *Generated by Auto-Fix Bot*
          EOF

      - name: Upload Report
        uses: actions/upload-artifact@1eb3cb2b3e0f296241caca2a7ab8ed34950fe83f  # v4.0.0
        with:
          name: auto-fix-report
          path: artifacts/reports/auto-fix/summary.md
          retention-days: 30