#!/bin/bash
#
# Git Pre-commit Hook for Naming Governance
# Validates all new/modified resource names before allowing commit
#

set -e

echo "[HOOK] Running naming governance validation..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(yaml|yml)$')

if [ -z "$STAGED_FILES" ]; then
    echo "[HOOK] No YAML files to validate"
    exit 0
fi

# Check if governance agent exists
if [ ! -f "tools/python/governance_agent.py" ]; then
    echo "[HOOK] WARNING: Governance agent not found, skipping validation"
    exit 0
fi

VALIDATION_FAILED=0

# Validate each staged file
for FILE in $STAGED_FILES; do
    echo "[HOOK] Validating: $FILE"
    
    # Extract resource names and validate
    grep -h "name:" "$FILE" 2>/dev/null | sed 's/.*name: *//' | while read -r NAME; do
        if [ -n "$NAME" ]; then
            # Try to infer resource type from file path
            RESOURCE_TYPE="generic"
            
            if [[ "$FILE" == *"k8s"* ]]; then
                if [[ "$FILE" == *"deployment"* ]]; then
                    RESOURCE_TYPE="k8s-deployment"
                elif [[ "$FILE" == *"service"* ]]; then
                    RESOURCE_TYPE="k8s-service"
                fi
            fi
            
            # Infer environment from file path or branch
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            if [[ "$BRANCH" == *"prod"* ]]; then
                ENV="prod"
            elif [[ "$BRANCH" == *"staging"* ]]; then
                ENV="staging"
            else
                ENV="dev"
            fi
            
            # Validate the name
            RESULT=$(python tools/python/governance_agent.py validate "$NAME" "$RESOURCE_TYPE" "$ENV" 2>&1 || true)
            
            # Check if validation passed
            if echo "$RESULT" | grep -q '"valid": false'; then
                echo "[HOOK] ❌ VALIDATION FAILED: $NAME"
                echo "$RESULT" | jq -r '.violations[]? | "\(.severity): \(.message)"' 2>/dev/null || echo "$RESULT"
                VALIDATION_FAILED=1
            fi
        fi
    done
done

if [ $VALIDATION_FAILED -eq 1 ]; then
    echo ""
    echo "[HOOK] ❌ Naming governance validation failed!"
    echo "[HOOK] Please fix the naming violations before committing."
    echo "[HOOK] Use 'git commit --no-verify' to bypass (not recommended)"
    exit 1
fi

echo "[HOOK] ✅ All names validated successfully"
exit 0