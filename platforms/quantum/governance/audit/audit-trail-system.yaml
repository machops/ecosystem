# @ECO-layer: GQS-L0
# @ECO-governed
# @ECO-layer: GL90-99
# @ECO-semantic: governance-core
# @ECO-audit-trail: gov-enterprise-architecture/governance/audit-trails/GL90_99-audit.json
#
# GL Unified Architecture Governance Framework Activated
# GL Root Semantic Anchor: gov-enterprise-architecture/governance/ECO-ROOT-SEMANTIC-ANCHOR.yaml
# GL Unified Naming Charter: gov-enterprise-architecture/governance/ECO-UNIFIED-NAMING-CHARTER.yaml


apiVersion: audit.machinenativeops.io/v1
kind: AuditTrailSystem
metadata:
  name: gov-quantum-audit-trail
  namespace: governance
  labels:
    eco-base/part-of: eco-base
    eco-base/governance: aligned
    gov-version: v10.0.0
    tier: quantum-audit
spec:
  enabled: true
  retention: 365d
  
  auditFields:
    - timestamp
    - actor_id
    - actor_name
    - actor_type
    - action
    - resource_type
    - resource_id
    - resource_name
    - operation
    - status
    - exit_code
    - duration_ms
    - environment
    - namespace
    - git_commit
    - git_branch
    - pr_number
    - workflow_id
    - job_id
    - step_id
    - changes
    - before
    - after
    - reason
    - justification
    - approval_status
    - approvers
    - ip_address
    - user_agent
    - metadata
    
  capture:
    sources:
      - name: github-events
        type: webhook
        enabled: true
        events:
          - push
          - pull_request
          - pull_request_review
          - workflow_dispatch
          - workflow_run
          
      - name: kubernetes-events
        type: kubernetes
        enabled: true
        resources:
          - deployments
          - services
          - configmaps
          - secrets
          - pods
          
      - name: ci-cd-events
        type: pipeline
        enabled: true
        stages:
          - validation
          - build
          - test
          - deploy
          - verification
          
      - name: governance-events
        type: governance
        enabled: true
        events:
          - policy-violation
          - compliance-check
          - naming-violation
          - security-scan
          
    filters:
      - name: exclude-test-events
        condition: environment != "test"
        
      - name: include-critical-events
        condition: severity == "critical"
        
  storage:
    primary:
      type: elasticsearch
      endpoint: ${{ secrets.ELASTICSEARCH_ENDPOINT }}
      index: gov-quantum-audit
      retention: 365d
      
    backup:
      type: s3
      bucket: gov-audit-backup
      prefix: audit/
      retention: 365d
      
  search:
    enabled: true
    indices:
      - name: audit-index
        fields:
          - timestamp
          - actor_name
          - action
          - resource_type
          - status
          - severity
          
    queries:
      - name: recent-violations
        query: |
          {
            "query": {
              "bool": {
                "must": [
                  {"range": {"timestamp": {"gte": "now-24h"}}},
                  {"term": {"status": "violation"}}
                ]
              }
            }
          }
          
      - name: actor-actions
        query: |
          {
            "query": {
              "term": {"actor_name": "{{ actor }}"}
            }
          }
          
  reporting:
    enabled: true
    schedules:
      - name: daily-report
        cron: "0 0 * * *"
        format: json
        recipients: ["platform-team@machinenativeops.com"]
        
      - name: weekly-summary
        cron: "0 0 * * 1"
        format: pdf
        recipients: ["management@machinenativeops.com"]
        
  retention:
    policy:
      - name: immediate-deletion
        condition: status == "success" && duration_ms < 1000
        retention: 30d
        
      - name: standard-retention
        condition: true
        retention: 365d
        
      - name: critical-retention
        condition: severity == "critical"
        retention: 730d