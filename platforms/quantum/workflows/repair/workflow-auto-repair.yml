# @GL-layer: GQS-L0
# @GL-governed
# @GL-layer: GL00-09
# @GL-semantic: general-component
# @GL-audit-trail: gov-enterprise-architecture/governance/audit-trails/GL00_09-audit.json
#
# GL Unified Architecture Governance Framework Activated
# GL Root Semantic Anchor: gov-enterprise-architecture/governance/GL-ROOT-SEMANTIC-ANCHOR.yaml
# GL Unified Naming Charter: gov-enterprise-architecture/governance/GL-UNIFIED-NAMING-CHARTER.yaml


apiVersion: repair.machinenativeops.io/v1
kind: WorkflowAutoRepair
metadata:
  name: gov-quantum-workflow-auto-repair
  namespace: github-actions
  labels:
    gov-version: v10.0.0
    tier: quantum-repair
spec:
  repairEngine:
    enabled: true
    mode: automatic
    
  policies:
    - name: critical-repair-policy
      severity: critical
      autoApply: true
      requireApproval: false
      repairs:
        - type: fix-syntax-error
          enabled: true
          
        - type: fix-indentation
          enabled: true
          
        - type: add-missing-required-sections
          enabled: true
          
    - name: security-repair-policy
      severity: high
      autoApply: true
      requireApproval: false
      repairs:
        - type: enforce-minimum-permissions
          enabled: true
          
        - type: pin-action-sha
          enabled: true
          
        - type: remove-secrets-from-logs
          enabled: true
          
    - name: optimization-repair-policy
      severity: medium
      autoApply: false
      requireApproval: true
      repairs:
        - type: add-cache-strategy
          enabled: true
          
        - type: optimize-docker-layers
          enabled: true
          
        - type: parallelize-independent-jobs
          enabled: true
          
  repairStrategies:
    actions-hardening:
      permissions:
        contents: read
        issues: write
        pull-requests: write
        checks: write
        statuses: write
        
      pinnedActions:
        actions/checkout@v3: 8ade135a41bc03ea155e62e844d188df1ea18608
        actions/setup-node@v3: 64ed1c7eab4cce3362f8c9dea7d51af4b31a064d
        actions/setup-python@v4: b55c28f9c9bbb6369b725b2853c1275c637c5f1b
        actions/setup-go@v4: 93397bea11091af506dff004f7f4b0c0cdddaad8
        docker/build-push-action@v4: 3b5e8027fcad23fda58b3178a31e17a45a250b11
        
      concurrency:
        enabled: true
        group: ${{ github.workflow }}-${{ github.ref }}
        cancel-in-progress: true
        
      retry:
        enabled: true
        maxAttempts: 3
        delay: 5000
        
    cache-optimization:
      pnpm:
        enabled: true
        path: ~/.pnpm-store
        key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
        
      go:
        enabled: true
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        
      docker:
        enabled: true
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        
  validation:
    preRepair:
      - type: syntax-check
        enabled: true
        
      - type: schema-validation
        enabled: true
        schemaPath: .github/schemas/workflow-schema.json
        
    postRepair:
      - type: lint-check
        enabled: true
        linter: actionlint
        
      - type: dry-run
        enabled: true
        dryRun: true
        
  rollback:
    enabled: true
    strategy: git-restore
    backupPath: .repair-backups