# @GL-layer: GQS-L0
# @GL-governed
# @GL-layer: GL00-09
# @GL-semantic: general-component
# @GL-audit-trail: gov-enterprise-architecture/governance/audit-trails/GL00_09-audit.json
#
# GL Unified Architecture Governance Framework Activated
# GL Root Semantic Anchor: gov-enterprise-architecture/governance/GL-ROOT-SEMANTIC-ANCHOR.yaml
# GL Unified Naming Charter: gov-enterprise-architecture/governance/GL-UNIFIED-NAMING-CHARTER.yaml


apiVersion: monitoring.machinenativeops.io/v1
kind: WorkflowMonitor
metadata:
  name: gov-quantum-workflow-monitor
  namespace: github-actions
  labels:
    gov-version: v10.0.0
    tier: quantum-monitoring
spec:
  monitoring:
    enabled: true
    scanInterval: 5m
    retention: 90d
    
  workflows:
    scanPaths:
      - .github/workflows/*.yml
      - .github/workflows/*.yaml
      
    classification:
      enabled: true
      categories:
        - ci/cd
        - security
        - testing
        - deployment
        - monitoring
        - governance
        
  detection:
    rules:
      - name: workflow-failure-detection
        severity: critical
        pattern: |
          jobs.*.outcome: 'failure'
        action: trigger-repair
        
      - name: workflow-timeout-detection
        severity: warning
        pattern: |
          jobs.*.outcome: 'timed_out'
        action: analyze-timeout
        
      - name: permission-broadness
        severity: high
        pattern: |
          permissions: 'write-all'
        action: enforce-minimum-permissions
        
      - name: unpinned-action
        severity: medium
        pattern: |
          uses: '.*@v[0-9]+'
        action: pin-action-sha
        
      - name: missing-cache
        severity: low
        pattern: |
          jobs.*.steps.*.uses: 'actions/checkout@v3'
        action: add-cache-strategy
        
      - name: no-retry-policy
        severity: medium
        pattern: |
          jobs.*.steps.*.retry-on: null
        action: add-retry-strategy
        
  repair:
    strategies:
      - name: actions-hardening
        priority: critical
        autoApply: true
        repairs:
          - type: enforce-minimum-permissions
            description: Enforce minimum permissions for all workflows
            permissions:
              contents: read
              pull-requests: write
              checks: write
              
          - type: pin-action-sha
            description: Pin all third-party actions to specific commit SHA
            enforcePinnedSHA: true
            
          - type: add-concurrency
            description: Add concurrency groups to prevent duplicate runs
            concurrency:
              group: ${{ github.workflow }}-${{ github.ref }}
              cancel-in-progress: true
              
          - type: add-retry-strategy
            description: Add retry strategy with exponential backoff
            retry:
              maxAttempts: 3
              delay: 5000
              
      - name: cache-optimization
        priority: high
        autoApply: true
        repairs:
          - type: add-pnpm-cache
            description: Add pnpm package caching
            cachePath: ~/.pnpm-store
            
          - type: add-go-cache
            description: Add Go module caching
            cachePath: ~/go/pkg/mod
            
          - type: add-docker-cache
            description: Add Docker layer caching
            cachePath: /tmp/.buildx-cache
            
      - name: security-hardening
        priority: critical
        autoApply: false
        repairs:
          - type: add-token-permissions
            description: Restrict token permissions
            tokenPermissions:
              GITHUB_TOKEN: read
              
          - type: add-secrets-handling
            description: Add secrets handling best practices
            secretsPolicy: strict
            
  alerting:
    enabled: true
    channels:
      - type: github-issue
        enabled: true
        labels:
          severity: critical
          type: workflow-alert
          
      - type: slack
        enabled: false
        webhook: ${{ secrets.SLACK_WEBHOOK }}
        
      - type: email
        enabled: false
        recipients:
          - platform-team@machinenativeops.com
          
  reporting:
    enabled: true
    format: json
    retention: 90d
    exportPath: artifacts/reports/workflow-monitoring