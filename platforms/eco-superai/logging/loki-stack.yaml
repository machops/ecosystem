---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/statefulset/loki
    eco-base/urn: urn:eco-base:k8s:core:statefulset:loki:sha256-0e68eb2be0948943afd40883075b847bfcf212d89ce41b26215fd81d5ae07f5a
  labels:
    app: superai-platform
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: loki
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    component: loki
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: loki
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: superai-platform
      component: loki
  serviceName: loki-headless
  template:
    metadata:
      annotations:
        prometheus.io/port: '3100'
        prometheus.io/scrape: 'true'
      labels:
        app: superai-platform
        component: loki
    spec:
      containers:
      - args:
        - -config.file=/etc/loki/local-config.yaml
        - -table-manager.retention-periods=72h
        image: grafana/loki:2.9.2
        livenessProbe:
          httpGet:
            path: /ready
            port: http-metrics
          initialDelaySeconds: 45
          periodSeconds: 10
        name: loki
        ports:
        - containerPort: 3100
          name: http-metrics
        - containerPort: 9096
          name: grpc
        readinessProbe:
          httpGet:
            path: /ready
            port: http-metrics
          initialDelaySeconds: 45
          periodSeconds: 10
        resources:
          limits:
            cpu: 1000m
            memory: 2Gi
          requests:
            cpu: 200m
            memory: 500Mi
        volumeMounts:
        - mountPath: /etc/loki
          name: config
        - mountPath: /loki
          name: storage
      serviceAccountName: superai-monitoring
      volumes:
      - configMap:
          name: loki-config
        name: config
      - emptyDir: {}
        name: storage
---
apiVersion: v1
data:
  local-config.yaml: "auth_enabled: false\n\nserver:\n  http_listen_port: 3100\n \
    \ grpc_listen_port: 9096\n\ncommon:\n  path_prefix: /loki\n  storage:\n    filesystem:\n\
    \      chunks_directory: /loki/chunks\n      rules_directory: /loki/rules\n  replication_factor:\
    \ 1\n  ring:\n    kvstore:\n      store: inmemory\n\nquery_range:\n  results_cache:\n\
    \    cache:\n      embedded_cache:\n        enabled: true\n        max_size_mb:\
    \ 100\n\nschema_config:\n  configs:\n    - from: 2020-10-24\n      store: boltdb-shipper\n\
    \      object_store: filesystem\n      schema: v11\n      index:\n        prefix:\
    \ index_\n        period: 24h\n\nlimits_config:\n  enforce_metric_name: false\n\
    \  reject_old_samples: true\n  reject_old_samples_max_age: 168h\n  max_entries_limit_per_query:\
    \ 5000\n  split_queries_by_interval: 30m\n\nruler:\n  alertmanager_url: http://alertmanager.default.svc.cluster.local:9093\n\
    \  \n  # Security-specific alert rules\n  rules:\n    - alert: SecurityEventDetected\n\
    \      expr: |\n        sum(rate({namespace=\"default\", container=~\".*\"} |~\
    \ \"Security|Attack|Breach|Compromise\" [5m])) by (container, namespace)\n   \
    \   for: 1m\n      labels:\n        severity: critical\n        team: security\n\
    \      annotations:\n        summary: \"Security event detected in {{ $labels.container\
    \ }}\"\n      \n    - alert: HighErrorRate\n      expr: |\n        sum(rate({namespace=\"\
    default\", level=\"error\"}[5m])) by (container) > 0.1\n      for: 5m\n      labels:\n\
    \        severity: warning\n        team: platform\n      annotations:\n     \
    \   summary: \"High error rate in {{ $labels.container }}\"\n      \n    - alert:\
    \ ContainerCrashLoop\n      expr: |\n        sum(rate({namespace=\"default\"}\
    \ |~ \"CrashLoopBackOff|Error:.*failed\" [5m])) by (pod) > 0\n      for: 1m\n\
    \      labels:\n        severity: critical\n        team: ops\n      annotations:\n\
    \        summary: \"Container {{ $labels.pod }} is crash looping\"\n"
kind: ConfigMap
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/configmap/loki-config
    eco-base/urn: urn:eco-base:k8s:core:configmap:loki-config:sha256-6ff276934045b6a0a47e4041b80704eba575e3db29cb4fdf920671529f01a5da
  labels:
    app: superai-platform
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: loki-config
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    component: loki
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: loki-config
  namespace: monitoring
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/service/loki
    eco-base/urn: urn:eco-base:k8s:core:service:loki:sha256-485c011f926ca2bb8d127fd0588c21dd4f9b41a1f39107ca946fb4e79cbdbcbc
  labels:
    app: superai-platform
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: loki
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    component: loki
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: loki
  namespace: monitoring
spec:
  ports:
  - name: http-metrics
    port: 3100
    targetPort: http-metrics
  - name: grpc
    port: 9096
    targetPort: grpc
  selector:
    app: superai-platform
    component: loki
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/service/loki-headless
    eco-base/urn: urn:eco-base:k8s:core:service:loki-headless:sha256-b53f9984c50e6f78807e28a57e9467433be93790c50a3e5d71e3704ba228ff77
  labels:
    app: superai-platform
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: loki-headless
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    component: loki
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: loki-headless
  namespace: monitoring
spec:
  clusterIP: None
  ports:
  - name: http-metrics
    port: 3100
    targetPort: http-metrics
  selector:
    app: superai-platform
    component: loki
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/daemonset/promtail
    eco-base/urn: urn:eco-base:k8s:core:daemonset:promtail:sha256-996eb1e584d1c7893eb4800c36ae611c00e589db0f1c32b17006ba27bd2f7b43
  labels:
    app: superai-platform
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: promtail
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    component: promtail
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: promtail
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: superai-platform
      component: promtail
  template:
    metadata:
      labels:
        app: superai-platform
        component: promtail
    spec:
      containers:
      - args:
        - -config.file=/etc/promtail/config.yml
        - -client.url=http://loki:3100/loki/api/v1/push
        image: grafana/promtail:2.9.2
        name: promtail
        ports:
        - containerPort: 3101
          name: http-metrics
        resources:
          limits:
            cpu: 500m
            memory: 500Mi
          requests:
            cpu: 100m
            memory: 200Mi
        volumeMounts:
        - mountPath: /etc/promtail
          name: config
        - mountPath: /var/log/pods
          name: pods
          readOnly: true
        - mountPath: /var/log/containers
          name: containers
          readOnly: true
        - mountPath: /var/lib/docker/containers
          name: docker
          readOnly: true
      serviceAccountName: superai-monitoring
      volumes:
      - configMap:
          name: promtail-config
        name: config
      - hostPath:
          path: /var/log/pods
        name: pods
      - hostPath:
          path: /var/log/containers
        name: containers
      - hostPath:
          path: /var/lib/docker/containers
        name: docker
---
apiVersion: v1
data:
  config.yml: "server:\n  http_listen_port: 3101\n  grpc_listen_port: 0\n\nclients:\n\
    \  - url: http://loki:3100/loki/api/v1/push\n\nscrape_configs:\n  # SuperAI Platform\
    \ Application Logs\n  - job_name: superai-platform\n    kubernetes_sd_configs:\n\
    \      - role: pod\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_label_app]\n\
    \        regex: superai-platform\n        action: keep\n      - source_labels:\
    \ [__meta_kubernetes_pod_label_component]\n        target_label: component\n \
    \     - source_labels: [__meta_kubernetes_pod_node_name]\n        target_label:\
    \ node\n      - source_labels: [__meta_kubernetes_namespace]\n        target_label:\
    \ namespace\n      - source_labels: [__meta_kubernetes_pod_name]\n        target_label:\
    \ pod\n      - source_labels: [__meta_kubernetes_pod_container_name]\n       \
    \ target_label: container\n      - replacement: /var/log/pods/*$1/*.log\n    \
    \    separator: /\n        source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]\n\
    \        target_label: __path__\n  \n  # System Logs\n  - job_name: system\n \
    \   static_configs:\n      - targets:\n          - localhost\n        labels:\n\
    \          job: varlogs\n          __path__: /var/log/*.log\n  \n  # Kubernetes\
    \ Events\n  - job_name: kubernetes-events\n    kubernetes_sd_configs:\n      -\
    \ role: pod\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_label_app]\n\
    \        regex: superai-platform\n        action: keep\n    pipeline_stages:\n\
    \      - cri: {}\n  \n  # Security Logs (Falco)\n  - job_name: falco\n    kubernetes_sd_configs:\n\
    \      - role: pod\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_label_app]\n\
    \        regex: falco\n        action: keep\n      - source_labels: [__meta_kubernetes_pod_name]\n\
    \        target_label: pod\n  \n# Pipeline stages for log processing\npipeline_stages:\n\
    \  - json:\n      expressions:\n        level: level\n        message: message\n\
    \        user: user\n        container: container\n  - labels:\n      level:\n\
    \      user:\n      container:\n  - match:\n      selector: '{level=\"error\"\
    }'\n      action: drop\n      drop_counter_reason: \"error_logs_dropped\"\n"
kind: ConfigMap
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/configmap/promtail-config
    eco-base/urn: urn:eco-base:k8s:core:configmap:promtail-config:sha256-b17304fc5e06034b80aeee61e2054279ed9a19a8c8ed1460c2bdfe014572cfe2
  labels:
    app: superai-platform
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: promtail-config
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    component: promtail
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: promtail-config
  namespace: monitoring
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app: superai-platform
    component: loki
  name: loki
  namespace: monitoring
spec:
  endpoints:
  - interval: 30s
    path: /metrics
    port: http-metrics
  selector:
    matchLabels:
      app: superai-platform
      component: loki
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app: superai-platform
    component: promtail
  name: promtail
  namespace: monitoring
spec:
  endpoints:
  - interval: 30s
    path: /metrics
    port: http-metrics
  selector:
    matchLabels:
      app: superai-platform
      component: promtail
---
apiVersion: v1
data:
  datasource.yaml: "apiVersion: 1\ndatasources:\n  - name: Loki\n    type: loki\n\
    \    access: proxy\n    url: http://loki:3100\n    isDefault: false\n    editable:\
    \ true\n    jsonData:\n      maxLines: 1000\n      derivedFields:\n        - datasourceUid:\
    \ jaeger\n          matcherRegex: \"traceID=(\\\\w+)\"\n          name: TraceID\n\
    \          url: \"$${__value.raw}\""
kind: ConfigMap
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/configmap/grafana-datasource-loki
    eco-base/urn: urn:eco-base:k8s:core:configmap:grafana-datasource-loki:sha256-baf20e64add5f8656fdb327b2b2d7e6256c760363f280485fc0fbe5608171255
  labels:
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: grafana-datasource-loki
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
    grafana_datasource: '1'
  name: grafana-datasource-loki
  namespace: monitoring
