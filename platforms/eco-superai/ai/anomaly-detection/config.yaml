---
apiVersion: v1
data:
  config.yaml: "# Anomaly Detection Configuration\n\nmodels:\n  # Metrics Anomaly\
    \ Detection\n  metrics:\n    enabled: true\n    algorithm: isolation_forest\n\
    \    threshold: 0.95\n    sliding_window: 3600  # 1 hour\n    features:\n    \
    \  - cpu_usage\n      - memory_usage\n      - request_rate\n      - error_rate\n\
    \      - latency_p95\n      - latency_p99\n    ensemble:\n      enabled: true\n\
    \      models:\n        - isolation_forest\n        - one_class_svm\n        -\
    \ local_outlier_factor\n      voting: hard\n  \n  # Log Anomaly Detection\n  logs:\n\
    \    enabled: true\n    algorithm: autoencoder\n    threshold: 0.92\n    features:\n\
    \      - log_frequency\n      - error_patterns\n      - timestamp_anomalies\n\
    \      - user_agent_anomalies\n      - path_anomalies\n    preprocessing:\n  \
    \    - tokenization\n      - embedding\n      - normalization\n    model:\n  \
    \    type: lstm_autoencoder\n      hidden_layers: [128, 64, 128]\n      dropout:\
    \ 0.2\n  \n  # Network Traffic Anomaly Detection\n  network:\n    enabled: true\n\
    \    algorithm: spectral_anomaly\n    threshold: 0.90\n    features:\n      -\
    \ packet_rate\n      - byte_rate\n      - connection_count\n      - port_distribution\n\
    \      - protocol_distribution\n      - geo_location_anomalies\n    sliding_window:\
    \ 300  # 5 minutes\n  \n  # User Behavior Analytics\n  user_behavior:\n    enabled:\
    \ true\n    algorithm: markov_chain\n    threshold: 0.88\n    features:\n    \
    \  - login_patterns\n      - access_patterns\n      - time_patterns\n      - location_patterns\n\
    \      - resource_access\n    behavioral_profiles:\n      enabled: true\n    \
    \  update_interval: 86400  # 24 hours\n\nalerting:\n  enabled: true\n  severity_levels:\n\
    \    critical:\n      threshold: 0.98\n      min_duration: 60  # seconds\n   \
    \   channels: [pagerduty, slack, email]\n    warning:\n      threshold: 0.95\n\
    \      min_duration: 300  # seconds\n      channels: [slack, email]\n    info:\n\
    \      threshold: 0.90\n      min_duration: 600  # seconds\n      channels: [email]\n\
    \  correlation:\n    enabled: true\n    time_window: 900  # 15 minutes\n    min_anomalies:\
    \ 3\n  suppression:\n    enabled: true\n    suppression_period: 1800  # 30 minutes\n\
    \ntraining:\n  enabled: true\n  schedule: \"0 2 * * *\"  # Daily at 2 AM\n  training_data_retention:\
    \ 90  # days\n  model_retention: 30  # days\n  retrain_threshold: 0.85  # Retrain\
    \ if accuracy drops below this\n  validation:\n    enabled: true\n    split_ratio:\
    \ 0.2  # 20% for validation\n    cross_validation_folds: 5\n\nstorage:\n  features_backend:\
    \ \"redis\"\n  models_backend: \"s3://eco-ml-models\"\n  metrics_backend:\
    \ \"prometheus\"\n  logs_backend: \"loki\"\n  \nperformance:\n  batch_size: 1000\n\
    \  max_concurrent_predictions: 10\n  prediction_timeout: 5  # seconds\n  model_loading_timeout:\
    \ 30  # seconds\n\nsecurity:\n  encryption:\n    enabled: true\n    algorithm:\
    \ AES-256-GCM\n    key_rotation: 2592000  # 30 days\n  access_control:\n    enabled:\
    \ true\n    role_based: true\n    audit_logging: true\n"
kind: ConfigMap
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/configmap/anomaly-detection-config
    eco-base/urn: urn:eco-base:k8s:core:configmap:anomaly-detection-config:sha256-b15f50d85e837be29b097308652fc5dc17898b5dad51e1d696c7bf6b62baab45
  labels:
    app: eco-base
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: anomaly-detection-config
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    component: ai-anomaly-detection
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: anomaly-detection-config
  namespace: default
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/cronjob/anomaly-model-training
    eco-base/urn: urn:eco-base:k8s:core:cronjob:anomaly-model-training:sha256-af238090c0eedcb4101b39359a10f6d25609fd95b0ff0e5314e6ebd3eb97dec6
  labels:
    app: eco-base
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: anomaly-model-training
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    component: ai-anomaly-detection
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: anomaly-model-training
  namespace: default
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      activeDeadlineSeconds: 3600
      backoffLimit: 3
      template:
        spec:
          containers:
          - args:
            - "python train_models.py \\\n  --config /etc/config/config.yaml \\\n\
              \  --metrics-backend http://prometheus.monitoring.svc.cluster.local:9090\
              \ \\\n  --logs-backend http://loki.monitoring.svc.cluster.local:3100\
              \ \\\n  --output s3://eco-ml-models/anomaly-detection\n"
            command:
            - /bin/sh
            - -c
            env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  key: aws_access_key_id
                  name: anomaly-detection-secrets
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  key: aws_secret_access_key
                  name: anomaly-detection-secrets
            envFrom:
            - secretRef:
                name: anomaly-detection-secrets
            image: ghcr.io/eco-base/anomaly-detection-trainer:v0.1.0
            name: trainer
            resources:
              limits:
                cpu: 8000m
                memory: 32Gi
              requests:
                cpu: 2000m
                memory: 8Gi
            volumeMounts:
            - mountPath: /etc/config
              name: config
              readOnly: true
            - mountPath: /models
              name: models
          restartPolicy: OnFailure
          serviceAccountName: eco-monitoring
          volumes:
          - configMap:
              name: anomaly-detection-config
            name: config
          - emptyDir: {}
            name: models
  schedule: 0 2 * * *
  successfulJobsHistoryLimit: 3
---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/deployment/anomaly-detection-service
    eco-base/urn: urn:eco-base:k8s:core:deployment:anomaly-detection-service:sha256-068f2a0ccb03d6df119504c42c2c27813622b432f502bfb57a7820dbe7cb343c
  labels:
    app: eco-base
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: anomaly-detection-service
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    component: ai-anomaly-detection
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: anomaly-detection-service
  namespace: default
spec:
  replicas: 3
  selector:
    matchLabels:
      app: anomaly-detection-service
  template:
    metadata:
      labels:
        app: eco-base
        component: ai-anomaly-detection
    spec:
      containers:
      - args:
        - --config=/etc/config/config.yaml
        - --metrics-address=:8080
        - --api-address=:8443
        env:
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        image: ghcr.io/eco-base/anomaly-detection-service:v0.1.0
        livenessProbe:
          httpGet:
            path: /healthz
            port: metrics
          initialDelaySeconds: 30
          periodSeconds: 10
        name: detector
        ports:
        - containerPort: 8080
          name: metrics
        - containerPort: 8443
          name: api
        readinessProbe:
          httpGet:
            path: /readyz
            port: metrics
          initialDelaySeconds: 30
          periodSeconds: 10
        resources:
          limits:
            cpu: 2000m
            memory: 8Gi
          requests:
            cpu: 500m
            memory: 2Gi
        volumeMounts:
        - mountPath: /etc/config
          name: config
          readOnly: true
      serviceAccountName: eco-monitoring
      volumes:
      - configMap:
          name: anomaly-detection-config
        name: config
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/service/anomaly-detection-service
    eco-base/urn: urn:eco-base:k8s:core:service:anomaly-detection-service:sha256-1add5408b350091fdc46997600d5fd6934d33dcd62f7176efe709fa5dac80e03
  labels:
    app: eco-base
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: anomaly-detection-service
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    component: ai-anomaly-detection
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: anomaly-detection-service
  namespace: default
spec:
  ports:
  - name: metrics
    port: 8080
    targetPort: metrics
  - name: api
    port: 8443
    targetPort: api
  selector:
    app: anomaly-detection-service
  type: ClusterIP
---
apiVersion: v1
kind: Secret
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/secret/anomaly-detection-secrets
    eco-base/urn: urn:eco-base:k8s:core:secret:anomaly-detection-secrets:sha256-5690ed0e228feb3c37a88a16e853d6abaee2dedd31b125951bc715e9339a942a
  labels:
    app: eco-base
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: anomaly-detection-secrets
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    component: ai-anomaly-detection
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: anomaly-detection-secrets
  namespace: default
stringData:
  aws_access_key_id: YOUR_AWS_ACCESS_KEY_ID
  aws_secret_access_key: YOUR_AWS_SECRET_ACCESS_KEY
  encryption_key: YOUR_AES_256_GCM_KEY
type: Opaque
