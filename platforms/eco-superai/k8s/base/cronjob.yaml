---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/cronjob/eco-db-backup
    eco-base/urn: urn:eco-base:k8s:core:cronjob:eco-db-backup:sha256-30b36645288ce0ceac6c45110532f95dd882a7c6fbf4eb4cc3f18e0dabb23c74
  labels:
    app.kubernetes.io/component: backup
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: eco-base
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: eco-db-backup
  namespace: eco-eco-base
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      activeDeadlineSeconds: 1800
      backoffLimit: 2
      template:
        metadata:
          labels:
            app.kubernetes.io/component: backup
            app.kubernetes.io/name: eco-base
        spec:
          containers:
          - command:
            - /bin/sh
            - -c
            - "set -euo pipefail\nTIMESTAMP=$(date +%Y%m%d_%H%M%S)\nBACKUP_FILE=\"\
              /backups/eco-base_db_${TIMESTAMP}.sql.gz\"\necho \"[backup] Starting\
              \ database backup...\"\npg_dump -h \"${DB_HOST}\" -U \"${DB_USER}\"\
              \ -d \"${DB_NAME}\" \\\n  --no-owner --no-privileges --clean --if-exists\
              \ \\\n  | gzip > \"${BACKUP_FILE}\"\nFILESIZE=$(stat -f%z \"${BACKUP_FILE}\"\
              \ 2>/dev/null || stat -c%s \"${BACKUP_FILE}\")\necho \"[backup] Completed:\
              \ ${BACKUP_FILE} (${FILESIZE} bytes)\"\n# Prune backups older than 30\
              \ days\nfind /backups -name \"eco-base_db_*.sql.gz\" -mtime +30 -delete\n\
              echo \"[backup] Pruned old backups\"\n"
            env:
            - name: DB_HOST
              value: postgres.eco-base
            - name: DB_NAME
              value: eco-base_db
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  key: POSTGRES_USER
                  name: eco-db-credentials
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  key: POSTGRES_PASSWORD
                  name: eco-db-credentials
            image: postgres:16-alpine
            name: db-backup
            resources:
              limits:
                cpu: 500m
                memory: 512Mi
              requests:
                cpu: 100m
                memory: 256Mi
            volumeMounts:
            - mountPath: /backups
              name: backup-storage
          restartPolicy: OnFailure
          securityContext:
            runAsGroup: 1000
            runAsNonRoot: true
            runAsUser: 1000
          serviceAccountName: eco-worker
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: eco-backup-pvc
  schedule: 0 2 * * *
  startingDeadlineSeconds: 600
  successfulJobsHistoryLimit: 3
  timeZone: UTC
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/cronjob/eco-cleanup
    eco-base/urn: urn:eco-base:k8s:core:cronjob:eco-cleanup:sha256-a1e0d3ee0206c5f14420b0670826c8c4fd0c5d4f955525ffaa50ce114e9f6425
  labels:
    app.kubernetes.io/component: maintenance
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: eco-base
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: eco-cleanup
  namespace: eco-eco-base
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      activeDeadlineSeconds: 900
      backoffLimit: 1
      template:
        metadata:
          labels:
            app.kubernetes.io/component: maintenance
            app.kubernetes.io/name: eco-base
        spec:
          containers:
          - command:
            - python
            - -c
            - 'import asyncio

              from src.infrastructure.tasks.worker import cleanup_expired_jobs

              result = cleanup_expired_jobs()

              print(f"Cleanup result: {result}")

              '
            envFrom:
            - configMapRef:
                name: eco-config
            - secretRef:
                name: eco-secrets
            image: ghcr.io/indestructibleautoops/eco-base:v0.1.0
            name: cleanup
            resources:
              limits:
                cpu: 200m
                memory: 256Mi
              requests:
                cpu: 50m
                memory: 128Mi
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
          serviceAccountName: eco-worker
  schedule: 30 3 * * *
  successfulJobsHistoryLimit: 3
  timeZone: UTC
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    app.kubernetes.io/component: backup
    app.kubernetes.io/name: eco-base
  name: eco-backup-pvc
  namespace: eco-eco-base
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard
