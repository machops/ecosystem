# @ECO-governed
# @ECO-layer: GL20-29
# @ECO-semantic: rke2-production-config
# @ECO-audit-trail: ../../../engine/governance/GL_SEMANTIC_ANCHOR.json

# RKE2 Production Configuration
# MachineNativeOps - CIS Hardened Cluster

# ============================================================================
# CIS Profile Configuration
# ============================================================================
# Enables CIS 1.29 benchmark compliance
# Reference: https://www.cisecurity.org/benchmark/kubernetes
version: \"1.0.0\"
labels:
    eco-base/part-of: eco-base
    eco-base/governance: aligned

profile: cis-1.29

# ============================================================================
# SELinux Configuration
# ============================================================================
# Security-Enhanced Linux mandatory access control
# Requires SELinux-enabled OS kernel (RHEL/CentOS/Oracle Linux)
selinux: true

# ============================================================================
# Kernel Protection
# ============================================================================
# Exits if kernel parameters don't match secure defaults
# Ensures runtime integrity against kernel tampering
protect-kernel-defaults: true

# ============================================================================
# Secrets Encryption
# ============================================================================
# Encrypts Kubernetes secrets at rest in etcd
# Provider configuration: encryption-provider-config.yaml
secrets-encryption: true
encryption-provider-config: /etc/rancher/rke2/encryption-provider-config.yaml

# ============================================================================
# Network Policies
# ============================================================================
# Enables default network policies for pod isolation
# Applied to kube-system, kube-public, and default namespaces
network-policies: true

# ============================================================================
# Pod Security Admission
# ============================================================================
# Replaces deprecated Pod Security Policies (PSP)
# Enforces restricted PSA mode across all namespaces
# PSA config file: psa-config.yaml
pod-security-admission-config-file: /etc/rancher/rke2/psa-config.yaml

# ============================================================================
# Audit Logging
# ============================================================================
# Comprehensive audit logging for compliance
audit-policy-file: /etc/rancher/rke2/audit-policy.yaml
audit-log-path: /var/log/rke2/audit.log
audit-log-maxage: 30
audit-log-maxbackup: 10
audit-log-maxsize: 100

# ============================================================================
# etcd Configuration
# ============================================================================
# Automated snapshots and retention
etcd-snapshot-schedule-cron: "0 */4 * * *"
etcd-snapshot-retention: 72

# etcd user (CIS 1.1.12)
# Ensure etcd runs as non-root user
etcd-user: etcd

# ============================================================================
# Cluster Configuration
# ============================================================================
cluster-name: machine-native-ops-production
cluster-domain: cluster.local
cluster-cidr: 10.42.0.0/16
service-cidr: 10.43.0.0/16

# ============================================================================
# API Server Configuration
# ============================================================================
# CIS 1.2.0 - Control Plane Configuration
# Disable anonymous authentication
disable-anonymous-authentication: true

# Enable service account issuer
service-account-issuer: https://kubernetes.default.svc.cluster.local

# Enable service account signing
service-account-signing-key: /var/lib/rancher/rke2/server/tls/service.key
service-account-issuer-discovery-url: https://kubernetes.default.svc.cluster.local

# ============================================================================
# Controller Manager Configuration
# ============================================================================
# CIS 1.3.0 - Controller Manager
# Terminated pod garbage collection threshold
terminated-pod-gc-threshold: 1000

# Use service account credentials
use-service-account-credentials: true

# ============================================================================
# Scheduler Configuration
# ============================================================================
# Enable scheduler metrics
scheduler-metrics-bind-address: 0.0.0.0:10259

# ============================================================================
# Node Configuration
# ============================================================================
# CIS 4.2.7 - Ensure kubelet is running
# kubelet configuration
kubelet-arg:
  - "protect-kernel-defaults=true"
  - "event-qps=0"
  - "max-pods=110"
  - "network-plugin=cni"
  - "cni-conf-dir=/etc/cni/net.d"
  - "resolv-conf=/etc/resolv.conf"
  - "cluster-dns=10.43.0.10"
  - "cluster-domain=cluster.local"
  - "authentication-token-webhook=true"
  - "authorization-mode=Webhook"
  - "client-ca-file=/var/lib/rancher/rke2/server/tls/client-ca.crt"
  - "tls-cert-file=/var/lib/rancher/rke2/server/tls/server-node.crt"
  - "tls-private-key-file=/var/lib/rancher/rke2/server/tls/server-node.key"

# ============================================================================
# Additional CIS Controls
# ============================================================================
# CIS 5.1.1 - Ensure the Linux Kernel's Hardening is in place
# Applied via sysctl configuration file

# CIS 5.2.1 - Ensure minimal container capabilities
# Configured via PSP/PSA

# CIS 5.4.1 - Ensure Runtime Class is set correctly
# Configured via RuntimeClass resources

# CIS 5.7.1 - Ensure sensitive host system files are not mounted
# Configured via PodSecurityPolicy/PSA

# ============================================================================
# Monitoring and Observability
# ============================================================================
# Enable metrics server
disable-scheduler: false
disable-cloud-controller: true
disable-controller-manager: false
disable-apiserver: false

# ============================================================================
# GL Compliance Tracking
# ============================================================================
# This configuration adheres to:
# - GL00-09: Strategic Layer - Security policies
# - GL10-19: Risk & Metrics - CIS compliance tracking
# - GL20-29: Resource & Standards - Configuration standards
# - GL30-39: Process & Control - Audit processes
# - GL40-49: Monitoring & Optimization - Security monitoring
# - GL50-59: Observability Layer - Audit logging
# - GL90-99: Meta-Specification - Documentation governance