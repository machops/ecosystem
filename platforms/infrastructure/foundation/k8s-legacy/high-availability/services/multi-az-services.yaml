--- null
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/service/machine-native-ops
    eco-base/urn: urn:eco-base:k8s:core:service:machine-native-ops:sha256-8314c37cb3239386e6e9b173357533b5fd2c1f53fc74078482654d4df5c23900
    prometheus.io/port: '9090'
    prometheus.io/scrape: 'true'
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: 'true'
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-healthy-threshold: '2'
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval-seconds: '30'
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-path: /health
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol: HTTP
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-timeout-seconds: '5'
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-unhealthy-threshold: '3'
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
    service.beta.kubernetes.io/aws-load-balancer-type: nlb
  labels:
    app.kubernetes.io/component: application
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: machine-native-ops
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
  name: machine-native-ops
  namespace: platform-03
spec:
  externalTrafficPolicy: Local
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 8080
  - name: https
    port: 443
    protocol: TCP
    targetPort: 8080
  - name: metrics
    port: 9090
    protocol: TCP
    targetPort: 9090
  selector:
    app.kubernetes.io/name: machine-native-ops
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800
  type: LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/service/machine-native-ops-api
    eco-base/urn: urn:eco-base:k8s:core:service:machine-native-ops-api:sha256-f645304d72d0f2e5a9c329906bd5895c106ed380dd15c5a9c80b8bb1d0ab5db3
    prometheus.io/port: '9090'
    prometheus.io/scrape: 'true'
  labels:
    app.kubernetes.io/component: api
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: machine-native-ops-api
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
  name: machine-native-ops-api
  namespace: platform-03
spec:
  ports:
  - name: http
    port: 8080
    protocol: TCP
    targetPort: 8080
  - name: metrics
    port: 9090
    protocol: TCP
    targetPort: 9090
  selector:
    app.kubernetes.io/name: machine-native-ops-api
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/service/machine-native-ops-worker
    eco-base/urn: urn:eco-base:k8s:core:service:machine-native-ops-worker:sha256-7880b55f4063e256a1acd721dbc0f28bdb3e9e90e5a3f2574cbbbcdfb674bbb4
  labels:
    app.kubernetes.io/component: worker
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: machine-native-ops-worker
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
  name: machine-native-ops-worker
  namespace: platform-03
spec:
  clusterIP: None
  ports:
  - name: metrics
    port: 9090
    protocol: TCP
    targetPort: 9090
  selector:
    app.kubernetes.io/name: machine-native-ops-worker
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/service/redis-cluster
    eco-base/urn: urn:eco-base:k8s:core:service:redis-cluster:sha256-e61375d26cb3dc778b2ed97ef04c32ee095707fb0b88f618458502d1977bcee8
  labels:
    app.kubernetes.io/component: cache
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: redis-cluster
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
  name: redis-cluster
  namespace: platform-03
spec:
  ports:
  - name: redis
    port: 6379
    protocol: TCP
    targetPort: 6379
  - name: metrics
    port: 9121
    protocol: TCP
    targetPort: 9121
  selector:
    app.kubernetes.io/name: rediscluster
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/service/postgres
    eco-base/urn: urn:eco-base:k8s:core:service:postgres:sha256-563a88fc96874b64d6194ae8a50af54515ba853ca59691b57056fe1ccabd1377
    prometheus.io/port: '9187'
    prometheus.io/scrape: 'true'
  labels:
    app.kubernetes.io/component: database
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: postgres
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
  name: postgres
  namespace: platform-03
spec:
  ports:
  - name: postgres
    port: 5432
    protocol: TCP
    targetPort: 5432
  - name: metrics
    port: 9187
    protocol: TCP
    targetPort: 9187
  selector:
    app.kubernetes.io/name: postgres
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/service/monitoring
    eco-base/urn: urn:eco-base:k8s:core:service:monitoring:sha256-a53e38ed77bf58401400928acf8191f4d206be824fe84bf9533080e1e01394f8
  labels:
    app.kubernetes.io/component: observability
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: monitoring
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
  name: monitoring
  namespace: monitoring
spec:
  externalTrafficPolicy: Local
  ports:
  - name: prometheus
    port: 9090
    protocol: TCP
    targetPort: 9090
  - name: grafana
    port: 3000
    protocol: TCP
    targetPort: 3000
  selector:
    app.kubernetes.io/name: prometheus
  type: LoadBalancer
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/name: machine-native-ops
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    release: prometheus
  name: machine-native-ops
  namespace: platform-03
spec:
  endpoints:
  - interval: 30s
    path: /metrics
    port: metrics
    scheme: http
  selector:
    matchLabels:
      app.kubernetes.io/name: machine-native-ops
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/name: machine-native-ops-api
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    release: prometheus
  name: machine-native-ops-api
  namespace: platform-03
spec:
  endpoints:
  - interval: 15s
    path: /metrics
    port: metrics
    scheme: http
  selector:
    matchLabels:
      app.kubernetes.io/name: machine-native-ops-api
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/name: machine-native-ops-worker
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    release: prometheus
  name: machine-native-ops-worker
  namespace: platform-03
spec:
  endpoints:
  - interval: 60s
    path: /metrics
    port: metrics
    scheme: http
  selector:
    matchLabels:
      app.kubernetes.io/name: machine-native-ops-worker
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/name: redis-cluster
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    release: prometheus
  name: redis-cluster
  namespace: platform-03
spec:
  endpoints:
  - interval: 30s
    path: /metrics
    port: metrics
    scheme: http
  selector:
    matchLabels:
      app.kubernetes.io/name: rediscluster
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/name: postgres
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    release: prometheus
  name: postgres
  namespace: platform-03
spec:
  endpoints:
  - interval: 30s
    path: /metrics
    port: metrics
    scheme: http
  selector:
    matchLabels:
      app.kubernetes.io/name: postgres
---
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: machine-native-ops-gateway
  namespace: platform-03
spec:
  selector:
    istio: ingressgateway
  servers:
  - hosts:
    - machine-native-ops.example.com
    - '*.machine-native-ops.example.com'
    port:
      name: http
      number: 80
      protocol: HTTP
  - hosts:
    - machine-native-ops.example.com
    - '*.machine-native-ops.example.com'
    port:
      name: https
      number: 443
      protocol: HTTPS
    tls:
      mode: SIMPLE
      privateKey: /etc/certs/tls.key
      serverCertificate: /etc/certs/tls.crt
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: machine-native-ops-vs
  namespace: platform-03
spec:
  gateways:
  - machine-native-ops-gateway
  hosts:
  - machine-native-ops.example.com
  - '*.machine-native-ops.example.com'
  http:
  - match:
    - uri:
        prefix: /
    retries:
      attempts: 3
      perTryTimeout: 10s
      retryOn: 5xx,connect-failure,refused-stream
    route:
    - destination:
        host: machine-native-ops
        port:
          number: 80
    timeout: 30s
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: machine-native-ops-dr
  namespace: platform-03
spec:
  host: machine-native-ops
  subsets:
  - labels:
      eco-base/governance: aligned
      eco-base/part-of: eco-base
      version: v1.0.0
    name: stable
  - labels:
      eco-base/governance: aligned
      eco-base/part-of: eco-base
      version: v1.1.0
    name: canary
  trafficPolicy:
    connectionPool:
      http:
        http1MaxPendingRequests: 50
        idleTimeout: 300s
        maxRequestsPerConnection: 3
      tcp:
        connectTimeout: 10s
        maxConnections: 100
    loadBalancer:
      localityLbSetting:
        distribute:
        - from: us-east-1a/us-east-1a/*
          to:
            us-east-1a/us-east-1a/*: 80
            us-east-1b/us-east-1b/*: 10
            us-east-1c/us-east-1c/*: 10
        - from: us-east-1b/us-east-1b/*
          to:
            us-east-1a/us-east-1a/*: 10
            us-east-1b/us-east-1b/*: 80
            us-east-1c/us-east-1c/*: 10
        - from: us-east-1c/us-east-1c/*
          to:
            us-east-1a/us-east-1a/*: 10
            us-east-1b/us-east-1b/*: 10
            us-east-1c/us-east-1c/*: 80
        enabled: true
      simple: LEAST_CONN
    outlierDetection:
      baseEjectionTime: 60s
      consecutive5xxErrors: 3
      interval: 30s
      maxEjectionPercent: 50
      minHealthPercent: 50
    tls:
      mode: ISTIO_MUTUAL
