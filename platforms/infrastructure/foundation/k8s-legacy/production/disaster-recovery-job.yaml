---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/cronjob/dr-health-check
    eco-base/urn: urn:eco-base:k8s:core:cronjob:dr-health-check:sha256-aa9aac2987abb810a881e41cea4095a424c712970a69d9dc3fa38775ab762637
  labels:
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: disaster-recovery
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
    environment: production
    test-type: health-check
  name: dr-health-check
  namespace: production
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        spec:
          containers:
          - command:
            - /bin/sh
            - -c
            - "echo \"Starting DR health check at $(date)\"\n\n# Check backup status\n\
              echo \"Checking backup status...\"\nvelero backup get --output json\
              \ > /tmp/backup-status.json\nBACKUP_STATUS=$(cat /tmp/backup-status.json\
              \ | jq -r '.[0].status.phase')\necho \"Latest backup status: $BACKUP_STATUS\"\
              \n\nif [ \"$BACKUP_STATUS\" != \"Completed\" ]; then\n  echo \"ERROR:\
              \ Backup status is not Completed\"\n  exit 1\nfi\n\n# Check database\
              \ health\necho \"Checking database health...\"\nkubectl exec -it deployment/postgresql\
              \ -n production -- \\\n  psql -h localhost -U ${POSTGRES_USER} -d ${POSTGRES_DB}\
              \ -c \"SELECT 1;\" > /tmp/db-health.txt\nDB_HEALTH=$(cat /tmp/db-health.txt\
              \ | grep -c \"1\")\n\nif [ \"$DB_HEALTH\" -ne 1 ]; then\n  echo \"ERROR:\
              \ Database health check failed\"\n  exit 1\nfi\n\n# Check cache health\n\
              echo \"Checking cache health...\"\nkubectl exec -it deployment/redis-master\
              \ -n production -- \\\n  redis-cli ping > /tmp/cache-health.txt\nCACHE_HEALTH=$(cat\
              \ /tmp/cache-health.txt | grep -c \"PONG\")\n\nif [ \"$CACHE_HEALTH\"\
              \ -ne 1 ]; then\n  echo \"ERROR: Cache health check failed\"\n  exit\
              \ 1\nfi\n\n# Check application health\necho \"Checking application health...\"\
              \nkubectl exec -it deployment/machine-native-ops -n production -- \\\
              \n  curl http://localhost:8000/health > /tmp/app-health.txt\nAPP_HEALTH=$(cat\
              \ /tmp/app-health.txt | grep -c \"OK\")\n\nif [ \"$APP_HEALTH\" -ne\
              \ 1 ]; then\n  echo \"ERROR: Application health check failed\"\n  exit\
              \ 1\nfi\n\necho \"DR health check completed successfully at $(date)\"\
              \n"
            env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  key: postgres-user
                  name: machine-native-ops-secrets
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  key: postgres-db
                  name: machine-native-ops-secrets
            image: ghcr.io/machinenativeops/dr-testing:v0.1.0
            name: dr-health-check
            resources:
              limits:
                cpu: 200m
                memory: 256Mi
              requests:
                cpu: 100m
                memory: 128Mi
            volumeMounts:
            - mountPath: /tmp
              name: results
          restartPolicy: OnFailure
          volumes:
          - emptyDir: {}
            name: results
  schedule: '*/15 * * * *'
  successfulJobsHistoryLimit: 3
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/cronjob/dr-backup-verification
    eco-base/urn: urn:eco-base:k8s:core:cronjob:dr-backup-verification:sha256-0c2a776e6129cecfe9327dbfb2d470afa5094f855eb613bc14f13156db26d147
  labels:
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: disaster-recovery
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
    environment: production
    test-type: backup-verification
  name: dr-backup-verification
  namespace: production
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        spec:
          containers:
          - command:
            - /bin/sh
            - -c
            - "echo \"Starting DR backup verification at $(date)\"\n\n# Create test\
              \ backup\necho \"Creating test backup...\"\nvelero backup create dr-verification-$(date\
              \ +%Y%m%d-%H%M%S) \\\n  --include-namespaces production \\\n  --wait\n\
              \n# Verify backup was created\necho \"Verifying backup creation...\"\
              \nBACKUP_NAME=$(velero backup get -o json | jq -r '.[0].name')\nBACKUP_STATUS=$(velero\
              \ backup get -o json | jq -r '.[0].status.phase')\n\nif [ \"$BACKUP_STATUS\"\
              \ != \"Completed\" ]; then\n  echo \"ERROR: Backup verification failed\"\
              \n  exit 1\nfi\n\n# Test restore (dry-run)\necho \"Testing restore (dry-run)...\"\
              \nvelero restore create dr-verification-restore \\\n  --from-backup\
              \ $BACKUP_NAME \\\n  --dry-run \\\n  --wait\n\necho \"DR backup verification\
              \ completed successfully at $(date)\"\n\n# Clean up\nvelero backup delete\
              \ $BACKUP_NAME --confirm\n"
            image: ghcr.io/machinenativeops/dr-testing:v0.1.0
            name: dr-backup-verification
            resources:
              limits:
                cpu: 500m
                memory: 512Mi
              requests:
                cpu: 200m
                memory: 256Mi
          restartPolicy: OnFailure
  schedule: 0 */6 * * *
  successfulJobsHistoryLimit: 3
