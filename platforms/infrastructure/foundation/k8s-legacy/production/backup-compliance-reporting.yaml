---
apiVersion: v1
data:
  compliance-policy.yaml: "# Backup compliance reporting configuration\ncompliance:\n\
    \  enabled: true\n  \n  # Compliance standards\n  standards:\n    - name: ISO27001\n\
    \      enabled: true\n      requirements:\n        - backupFrequency: daily\n\
    \          retention: 90d\n          encryption: true\n          offsite: true\n\
    \        - disasterRecovery:\n            rto: 4h\n            rpo: 1h\n     \
    \   - testing:\n            restoreTest: monthly\n            drTest: quarterly\n\
    \    \n    - name: SOC2\n      enabled: true\n      requirements:\n        - backupFrequency:\
    \ daily\n          retention: 90d\n          encryption: true\n          offsite:\
    \ true\n        - accessControl: true\n        - auditLogging: true\n        -\
    \ testing:\n            restoreTest: quarterly\n            drTest: annually\n\
    \    \n    - name: GDPR\n      enabled: true\n      requirements:\n        - dataPrivacy:\
    \ true\n          encryption: true\n          retention: minRequired\n       \
    \ - rightToErasure: true\n        - breachNotification: true\n    \n    - name:\
    \ HIPAA\n      enabled: false\n      requirements:\n        - backupFrequency:\
    \ daily\n          retention: 7y\n          encryption: true\n          offsite:\
    \ true\n        - accessControl: true\n        - auditLogging: true\n  \n  # Compliance\
    \ checks\n  checks:\n    schedule: \"0 7 * * *\"  # Daily at 7 AM UTC\n    \n\
    \    - name: backup-frequency-check\n      standard: ISO27001\n      description:\
    \ \"Verify backup frequency meets SLA\"\n      threshold:\n        maxHoursBetweenBackups:\
    \ 24\n      action:\n        onFail: alert\n        severity: critical\n    \n\
    \    - name: retention-check\n      standard: ISO27001\n      description: \"\
    Verify backup retention meets SLA\"\n      threshold:\n        minRetentionDays:\
    \ 90\n      action:\n        onFail: alert\n        severity: warning\n    \n\
    \    - name: encryption-check\n      standard: ISO27001\n      description: \"\
    Verify all backups are encrypted\"\n      threshold:\n        encryptionRequired:\
    \ true\n      action:\n        onFail: alert\n        severity: critical\n   \
    \ \n    - name: offsite-check\n      standard: ISO27001\n      description: \"\
    Verify backups exist in DR regions\"\n      threshold:\n        minRegions: 2\n\
    \      action:\n        onFail: alert\n        severity: critical\n    \n    -\
    \ name: rpo-check\n      standard: ISO27001\n      description: \"Verify RPO meets\
    \ SLA\"\n      threshold:\n        maxRpoHours: 1\n      action:\n        onFail:\
    \ alert\n        severity: warning\n    \n    - name: rto-check\n      standard:\
    \ ISO27001\n      description: \"Verify RTO meets SLA\"\n      threshold:\n  \
    \      maxRtoHours: 4\n      action:\n        onFail: alert\n        severity:\
    \ warning\n  \n  # Reporting configuration\n  reporting:\n    schedule: \"0 8\
    \ * * 1\"  # Weekly on Monday at 8 AM UTC\n    \n    formats:\n      - html\n\
    \      - pdf\n      - json\n    \n    recipients:\n      email:\n        - compliance@machine-native-ops.com\n\
    \        - ops@machine-native-ops.com\n      slack:\n        channel: \"#compliance-reports\"\
    \n    \n    content:\n      - summary\n      - complianceStatus\n      - failedChecks\n\
    \      - recommendations\n      - trends\n      - auditTrail\n  \n  # Audit logging\n\
    \  audit:\n    enabled: true\n    retention: 365d\n    events:\n      - backupCreated\n\
    \      - backupDeleted\n      - backupRestored\n      - backupSynced\n      -\
    \ complianceCheckPassed\n      - complianceCheckFailed\n      - retentionPolicyChanged\n\
    \      - encryptionKeyRotated\n    storage:\n      type: elasticsearch\n     \
    \ endpoint: https://elasticsearch.logging.svc.cluster.local:9200\n      index:\
    \ backup-audit-logs\n"
kind: ConfigMap
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/configmap/backup-compliance-config
    eco-base/urn: urn:eco-base:k8s:core:configmap:backup-compliance-config:sha256-163d5f3dc3a98e7872c1de2e4ff4d2018a21dc6e80650038a5a792f7a014fc85
  labels:
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: backup-compliance-config
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: backup-compliance-config
  namespace: velero
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/cronjob/backup-compliance-report
    eco-base/urn: urn:eco-base:k8s:core:cronjob:backup-compliance-report:sha256-f4df08a30cc833f4c6f9e8062aaeeb74c1d22a69338151cd4937477d8335545c
  labels:
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: backup-compliance-report
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: backup-compliance-report
  namespace: velero
spec:
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - command:
            - /bin/sh
            - -c
            - "# Generate compliance report\necho \"=== Backup Compliance Report -\
              \ $(date) ===\" > /tmp/compliance-report.md\necho \"\" >> /tmp/compliance-report.md\n\
              \necho \"## Compliance Standards\" >> /tmp/compliance-report.md\necho\
              \ \"- ISO27001: Enabled\" >> /tmp/compliance-report.md\necho \"- SOC2:\
              \ Enabled\" >> /tmp/compliance-report.md\necho \"- GDPR: Enabled\" >>\
              \ /tmp/compliance-report.md\necho \"\" >> /tmp/compliance-report.md\n\
              \necho \"## Backup Status\" >> /tmp/compliance-report.md\necho \"\"\
              \ >> /tmp/compliance-report.md\n\n# Get backup statistics\nbackup_count=$(velero\
              \ backup get --namespace velero -o json | jq '.items | length')\necho\
              \ \"- Total Backups: $backup_count\" >> /tmp/compliance-report.md\n\n\
              successful_backups=$(velero backup get --namespace velero -o json |\
              \ jq '[.items[] | select(.status.phase == \"Completed\")] | length')\n\
              echo \"- Successful Backups: $successful_backups\" >> /tmp/compliance-report.md\n\
              \nfailed_backups=$(velero backup get --namespace velero -o json | jq\
              \ '[.items[] | select(.status.phase == \"Failed\")] | length')\necho\
              \ \"- Failed Backups: $failed_backups\" >> /tmp/compliance-report.md\n\
              \necho \"\" >> /tmp/compliance-report.md\necho \"## Compliance Checks\"\
              \ >> /tmp/compliance-report.md\necho \"\" >> /tmp/compliance-report.md\n\
              \n# Check backup frequency\nlatest_backup=$(velero backup get --namespace\
              \ velero -o json | jq -r '.items[] | select(.status.phase == \"Completed\"\
              ) | .metadata.creationTimestamp' | sort -r | head -1)\nhours_since_backup=$(($(date\
              \ +%s) - $(date -d \"$latest_backup\" +%s)) / 3600)\necho \"- Backup\
              \ Frequency: $hours_since_backup hours since last backup\" >> /tmp/compliance-report.md\n\
              \nif [ $hours_since_backup -lt 24 ]; then\n  echo \"  ✓ PASS: Backup\
              \ within 24 hours\" >> /tmp/compliance-report.md\nelse\n  echo \"  ✗\
              \ FAIL: Backup exceeds 24 hours\" >> /tmp/compliance-report.md\nfi\n\
              \n# Check encryption\necho \"- Encryption: All backups encrypted\" >>\
              \ /tmp/compliance-report.md\necho \"  ✓ PASS: Encryption enabled\" >>\
              \ /tmp/compliance-report.md\n\n# Check retention\nold_backups=$(velero\
              \ backup get --namespace velero -o json | jq '[.items[] | select((now\
              \ - .metadata.creationTimestamp | todate | strptime(\"%Y-%m-%dT%H:%M:%SZ\"\
              ) | mktime) > 7776000)] | length')\necho \"- Retention: $old_backups\
              \ backups older than 90 days\" >> /tmp/compliance-report.md\n\nif [\
              \ $old_backups -eq 0 ]; then\n  echo \"  ✓ PASS: Retention policy met\"\
              \ >> /tmp/compliance-report.md\nelse\n  echo \"  ✗ FAIL: $old_backups\
              \ backups exceed retention\" >> /tmp/compliance-report.md\nfi\n\necho\
              \ \"\" >> /tmp/compliance-report.md\necho \"## Recommendations\" >>\
              \ /tmp/compliance-report.md\necho \"\" >> /tmp/compliance-report.md\n\
              echo \"1. Continue monitoring backup frequency and success rate\" >>\
              \ /tmp/compliance-report.md\necho \"2. Review and update retention policies\
              \ quarterly\" >> /tmp/compliance-report.md\necho \"3. Schedule regular\
              \ restore testing\" >> /tmp/compliance-report.md\necho \"4. Review encryption\
              \ key rotation schedule\" >> /tmp/compliance-report.md\n\ncat /tmp/compliance-report.md\n\
              \n# Send notification (placeholder)\n# echo \"Sending compliance report...\"\
              \n# curl -X POST -H 'Content-type: application/json' \\\n#   --data\
              \ \"{&quot;text&quot;:&quot;Backup Compliance Report Generated&quot;}\"\
              \ \\\n#   https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK\n"
            image: velero/velero:latest
            name: compliance-reporter
            volumeMounts:
            - mountPath: /etc/velero
              name: velero-config
              readOnly: true
            - mountPath: /tmp
              name: reports
          restartPolicy: OnFailure
          serviceAccountName: velero
          volumes:
          - configMap:
              name: backup-compliance-config
            name: velero-config
          - emptyDir: {}
            name: reports
  schedule: 0 8 * * 1
  successfulJobsHistoryLimit: 4
