---
apiVersion: v1
data:
  lifecycle-policy.yaml: "# Backup lifecycle management policy\nlifecycle:\n  enabled:\
    \ true\n  \n  # Retention policies by backup type\n  retention:\n    fullCluster:\n\
    \      shortTerm:\n        duration: 7d\n        location: primary\n        count:\
    \ 7\n      mediumTerm:\n        duration: 30d\n        location: primary\n   \
    \     count: 30\n      longTerm:\n        duration: 90d\n        location: dr\n\
    \        count: 90\n      archival:\n        duration: 365d\n        location:\
    \ archive\n        count: 12\n    \n    incremental:\n      shortTerm:\n     \
    \   duration: 1d\n        location: primary\n        count: 24\n      mediumTerm:\n\
    \        duration: 7d\n        location: primary\n        count: 168\n    \n \
    \   database:\n      postgresql:\n        hourly:\n          duration: 24h\n \
    \         location: primary\n          count: 24\n        daily:\n          duration:\
    \ 30d\n          location: primary\n          count: 30\n        weekly:\n   \
    \       duration: 90d\n          location: dr\n          count: 12\n      redis:\n\
    \        hourly:\n          duration: 6h\n          location: primary\n      \
    \    count: 12\n        daily:\n          duration: 7d\n          location: primary\n\
    \          count: 7\n    \n    configuration:\n      shortTerm:\n        duration:\
    \ 30d\n        location: primary\n        count: 1440\n      longTerm:\n     \
    \   duration: 90d\n        location: dr\n        count: 4320\n  \n  # Lifecycle\
    \ transitions\n  transitions:\n    - name: primary-to-dr\n      sourceLocation:\
    \ primary\n      targetLocation: dr\n      schedule: \"0 4 * * *\"  # Daily at\
    \ 4 AM UTC\n      backupTypes:\n        - fullCluster\n        - database\n  \
    \      - configuration\n    \n    - name: dr-to-archive\n      sourceLocation:\
    \ dr\n      targetLocation: archive\n      schedule: \"0 5 1 * *\"  # Monthly\
    \ on 1st at 5 AM UTC\n      backupTypes:\n        - fullCluster\n        - database\n\
    \  \n  # Cleanup policies\n  cleanup:\n    enabled: true\n    schedule: \"0 3\
    \ * * *\"  # Daily at 3 AM UTC\n    policies:\n      - name: expired-backups\n\
    \        action: delete\n        condition:\n          age: exceeds\n        \
    \  value: retention\n        notification:\n          enabled: true\n        \
    \  channels:\n            - slack\n            - email\n      \n      - name:\
    \ failed-backups\n        action: delete\n        condition:\n          status:\
    \ failed\n          age: greaterThan\n          value: 7d\n        notification:\n\
    \          enabled: true\n      \n      - name: incomplete-backups\n        action:\
    \ verify\n        condition:\n          status: incomplete\n          age: greaterThan\n\
    \          value: 1h\n        actionOnVerifyFail: delete\n  \n  # Archive policies\n\
    \  archival:\n    enabled: true\n    schedule: \"0 5 1 * *\"  # Monthly on 1st\
    \ at 5 AM UTC\n    format: tar.gz\n    compression: true\n    encryption: true\n\
    \    \n      include: true\n      format: json\n    retention: 365d\n    notification:\n\
    \      enabled: true\n      channels:\n        - slack\n        - email\n"
kind: ConfigMap
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/configmap/backup-lifecycle-config
    eco-base/urn: urn:eco-base:k8s:core:configmap:backup-lifecycle-config:sha256-af73c7bec0eb98c95e69f46314864859c05a05ed21f402d36f9da40c3654b829
  labels:
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: backup-lifecycle-config
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: backup-lifecycle-config
  namespace: velero
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/cronjob/backup-lifecycle-manager
    eco-base/urn: urn:eco-base:k8s:core:cronjob:backup-lifecycle-manager:sha256-5801966bec4817337dc5ef2de65c9dddeb61ea2f0842c23ed187e2c6f649a642
  labels:
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: backup-lifecycle-manager
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: backup-lifecycle-manager
  namespace: velero
spec:
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - command:
            - /bin/sh
            - -c
            - "# Execute lifecycle policies\nvelero backup get --namespace velero\
              \ -o json | \\\n  jq -r '.items[] | select(.status.phase == \"Completed\"\
              ) | \"\\(.metadata.name) \\(.metadata.creationTimestamp)\"' | \\\n \
              \ while read backup_name creation_time; do\n    # Check retention policy\n\
              \    backup_age=$(($(date +%s) - $(date -d \"$creation_time\" +%s)))\n\
              \    retention_days=30\n    retention_seconds=$((retention_days * 24\
              \ * 3600))\n    \n    if [ $backup_age -gt $retention_seconds ]; then\n\
              \      echo \"Deleting expired backup: $backup_name\"\n      velero\
              \ backup delete $backup_name --namespace velero --confirm\n    fi\n\
              \  done\n\n# Sync to DR regions\necho \"Syncing backups to DR regions...\"\
              \nvelero backup-location sync --namespace velero\n\n# Verify backups\n\
              echo \"Verifying backups...\"\nvelero backup get --namespace velero\
              \ -o json | \\\n  jq -r '.items[] | select(.status.phase == \"Completed\"\
              ) | .metadata.name' | \\\n  while read backup_name; do\n    echo \"\
              Verifying backup: $backup_name\"\n    velero backup describe $backup_name\
              \ --namespace velero --details\n  done\n"
            image: velero/velero:latest
            name: lifecycle-manager
            volumeMounts:
            - mountPath: /etc/velero
              name: velero-config
              readOnly: true
          restartPolicy: OnFailure
          serviceAccountName: velero
          volumes:
          - configMap:
              name: backup-lifecycle-config
            name: velero-config
  schedule: 0 3 * * *
  successfulJobsHistoryLimit: 3
---
apiVersion: v1
kind: Secret
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/secret/backup-notification-config
    eco-base/urn: urn:eco-base:k8s:core:secret:backup-notification-config:sha256-435b97a1c180cdd9f20365d74e0d442accb0b41ba22a62aeed39543f0025c3cc
  labels:
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: backup-notification-config
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: backup-notification-config
  namespace: velero
stringData:
  email-from: backups@machine-native-ops.com
  email-smtp-port: '587'
  email-smtp-server: smtp.example.com
  email-to: ops-team@machine-native-ops.com
  slack-webhook-url: https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK
type: Opaque
