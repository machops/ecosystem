---
apiVersion: v1
data:
  alerting:
    alertmanagers:
    - static_configs:
      - targets:
        - alertmanager:9093
  prometheus.yml: "global:\n  scrape_interval: 15s\n  evaluation_interval: 15s\n \
    \ external_labels:\neco-base/part-of: eco-base\neco-base/governance: aligned\n\
    \    cluster: production\n    environment: production\n    region: us-east-1\n\
    \nscrape_configs:\n- job_name: 'machine-native-ops'\n  kubernetes_sd_configs:\n\
    \  - role: pod\n    namespaces:\n      names:\n      - production\n  relabel_configs:\n\
    \  - source_labels:\neco-base/part-of: eco-base\neco-base/governance: aligned\
    \ [__meta_kubernetes_pod_annotation_prometheus_io_scrape]\n    action: keep\n\
    \    regex: true\n  - source_labels:\neco-base/part-of: eco-base\neco-base/governance:\
    \ aligned [__meta_kubernetes_pod_annotation_prometheus_io_path]\n    action: replace\n\
    \    target_label: __metrics_path__\n    regex: (.+)\n  - source_labels:\neco-base/part-of:\
    \ eco-base\neco-base/governance: aligned [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]\n\
    \    action: replace\n    regex: ([^:]+)(?::\\d+)?;(\\d+)\n    replacement: $1:$2\n\
    \    target_label: __address__\n  - action: labelmap\n    regex: __meta_kubernetes_pod_label_(.+)\n\
    \  - source_labels:\neco-base/part-of: eco-base\neco-base/governance: aligned\
    \ [__meta_kubernetes_namespace]\n    action: replace\n    target_label: kubernetes_namespace\n\
    \  - source_labels:\neco-base/part-of: eco-base\neco-base/governance: aligned\
    \ [__meta_kubernetes_pod_name]\n    action: replace\n    target_label: kubernetes_pod_name\n\
    \n- job_name: 'istio-mesh'\n  kubernetes_sd_configs:\n  - role: endpoints\n  \
    \  namespaces:\n      names:\n      - istio-system\n  relabel_configs:\n  - source_labels:\n\
    eco-base/part-of: eco-base\neco-base/governance: aligned [__meta_kubernetes_service_name]\n\
    \    action: keep\n    regex: istio-telemetry\n  - source_labels:\neco-base/part-of:\
    \ eco-base\neco-base/governance: aligned [__meta_kubernetes_pod_annotation_prometheus_io_scrape]\n\
    \    action: keep\n    regex: true\n  - source_labels:\neco-base/part-of: eco-base\n\
    eco-base/governance: aligned [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]\n\
    \    action: replace\n    regex: ([^:]+)(?::\\d+)?;(\\d+)\n    replacement: $1:$2\n\
    \    target_label: __address__\n\n- job_name: 'kubernetes-pods'\n  kubernetes_sd_configs:\n\
    \  - role: pod\n  relabel_configs:\n  - source_labels:\neco-base/part-of: eco-base\n\
    eco-base/governance: aligned [__meta_kubernetes_pod_annotation_prometheus_io_scrape]\n\
    \    action: keep\n    regex: true\n  - source_labels:\neco-base/part-of: eco-base\n\
    eco-base/governance: aligned [__meta_kubernetes_pod_annotation_prometheus_io_path]\n\
    \    action: replace\n    target_label: __metrics_path__\n    regex: (.+)\n  -\
    \ source_labels:\neco-base/part-of: eco-base\neco-base/governance: aligned [__address__,\
    \ __meta_kubernetes_pod_annotation_prometheus_io_port]\n    action: replace\n\
    \    regex: ([^:]+)(?::\\d+)?;(\\d+)\n    replacement: $1:$2\n    target_label:\
    \ __address__\n\n- job_name: 'kubernetes-nodes'\n  kubernetes_sd_configs:\n  -\
    \ role: node\n  relabel_configs:\n  - source_labels:\neco-base/part-of: eco-base\n\
    eco-base/governance: aligned [__address__]\n    regex: '(.*):10250'\n    replacement:\
    \ '${1}:9100'\n    target_label: __address__\n\n- job_name: 'kubernetes-services'\n\
    \  kubernetes_sd_configs:\n  - role: service\n  relabel_configs:\n  - source_labels:\n\
    eco-base/part-of: eco-base\neco-base/governance: aligned [__meta_kubernetes_service_annotation_prometheus_io_scrape]\n\
    \    action: keep\n    regex: true\n  - source_labels:\neco-base/part-of: eco-base\n\
    eco-base/governance: aligned [__meta_kubernetes_service_annotation_prometheus_io_path]\n\
    \    action: replace\n    target_label: __metrics_path__\n    regex: (.+)\n  -\
    \ source_labels:\neco-base/part-of: eco-base\neco-base/governance: aligned [__address__,\
    \ __meta_kubernetes_service_annotation_prometheus_io_port]\n    action: replace\n\
    \    regex: ([^:]+)(?::\\d+)?;(\\d+)\n    replacement: $1:$2\n    target_label:\
    \ __address__\n"
  rule_files:
  - /etc/prometheus/rules/*.yml
  - /etc/prometheus/rules/*.yaml
kind: ConfigMap
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/configmap/prometheus-config
    eco-base/urn: urn:eco-base:k8s:core:configmap:prometheus-config:sha256-8410dfe464cc450663eba654fcb134c762e463c24f52600675c1da66edd4a175
  labels:
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
    environment: production
  name: prometheus-config
  namespace: monitoring
---
apiVersion: v1
data:
  alerts.yml: "groups:\n- name: machine-native-ops-health\n  interval: 30s\n  rules:\n\
    \  - alert: HighErrorRate\n    expr: |\n      rate(http_requests_total{job=\"\
    machine-native-ops\",status=~\"5..\"}[5m]) /\n      rate(http_requests_total{job=\"\
    machine-native-ops\"}[5m]) > 0.05\n    for: 5m\n    labels:\neco-base/part-of:\
    \ eco-base\neco-base/governance: aligned\n      severity: critical\n      service:\
    \ machine-native-ops\n    annotations:\n      summary: \"High error rate detected\"\
    \n      description: \"Error rate is {{ $value | humanizePercentage }} for {{\
    \ $labels.instance }}\"\n\n  - alert: HighLatency\n    expr: |\n      histogram_quantile(0.95,\n\
    \        rate(http_request_duration_seconds_bucket{job=\"machine-native-ops\"\
    }[5m])\n      ) > 1\n    for: 5m\n    labels:\neco-base/part-of: eco-base\neco-base/governance:\
    \ aligned\n      severity: warning\n      service: machine-native-ops\n    annotations:\n\
    \      summary: \"High latency detected\"\n      description: \"P95 latency is\
    \ {{ $value }}s for {{ $labels.instance }}\"\n\n  - alert: HighMemoryUsage\n \
    \   expr: |\n      container_memory_usage_bytes{\n        namespace=\"production\"\
    ,\n        container=\"app\"\n      } / container_spec_memory_limit_bytes{\n \
    \       namespace=\"production\",\n        container=\"app\"\n      } > 0.9\n\
    \    for: 5m\n    labels:\neco-base/part-of: eco-base\neco-base/governance: aligned\n\
    \      severity: warning\n      service: machine-native-ops\n    annotations:\n\
    \      summary: \"High memory usage detected\"\n      description: \"Memory usage\
    \ is {{ $value | humanizePercentage }} for {{ $labels.pod }}\"\n\n  - alert: HighCPUUsage\n\
    \    expr: |\n      rate(container_cpu_usage_seconds_total{\n        namespace=\"\
    production\",\n        container=\"app\"\n      }[5m]) > 0.9\n    for: 5m\n  \
    \  labels:\neco-base/part-of: eco-base\neco-base/governance: aligned\n      severity:\
    \ warning\n      service: machine-native-ops\n    annotations:\n      summary:\
    \ \"High CPU usage detected\"\n      description: \"CPU usage is {{ $value | humanizePercentage\
    \ }} for {{ $labels.pod }}\"\n\n  - alert: PodRestartTooOften\n    expr: |\n \
    \     increase(kube_pod_container_status_restarts_total{\n        namespace=\"\
    production\",\n        pod=~\"machine-native-ops-.*\"\n      }[1h]) > 5\n    for:\
    \ 5m\n    labels:\neco-base/part-of: eco-base\neco-base/governance: aligned\n\
    \      severity: critical\n      service: machine-native-ops\n    annotations:\n\
    \      summary: \"Pod restarting too often\"\n      description: \"Pod {{ $labels.pod\
    \ }} has restarted {{ $value }} times in the last hour\"\n\n  - alert: TooManyPodsNotReady\n\
    \    expr: |\n      sum(kube_pod_status_ready{\n        namespace=\"production\"\
    ,\n        condition=\"true\"\n      }) != sum(kube_pod_status_ready{\n      \
    \  namespace=\"production\"\n      })\n    for: 5m\n    labels:\neco-base/part-of:\
    \ eco-base\neco-base/governance: aligned\n      severity: critical\n      service:\
    \ machine-native-ops\n    annotations:\n      summary: \"Pods not ready\"\n  \
    \    description: \"{{ $value }} pods in production namespace are not ready\"\n\
    \n  - alert: ReplicaCountMismatch\n    expr: |\n      count(kube_pod_status_phase{\n\
    \        namespace=\"production\",\n        phase=\"Running\"\n      }) < 3\n\
    \    for: 5m\n    labels:\neco-base/part-of: eco-base\neco-base/governance: aligned\n\
    \      severity: warning\n      service: machine-native-ops\n    annotations:\n\
    \      summary: \"Insufficient replicas running\"\n      description: \"Only {{\
    \ $value }} replicas are running, expected at least 3\"\n\n- name: istio-metrics\n\
    \  interval: 30s\n  rules:\n  - alert: IstioHighErrorRate\n    expr: |\n     \
    \ sum(rate(istio_requests_total{\n        destination_service_namespace=\"production\"\
    ,\n        response_code=~\"5..\"\n      }[5m])) /\n      sum(rate(istio_requests_total{\n\
    \        destination_service_namespace=\"production\"\n      }[5m])) > 0.05\n\
    \    for: 5m\n    labels:\neco-base/part-of: eco-base\neco-base/governance: aligned\n\
    \      severity: critical\n      service: istio\n    annotations:\n      summary:\
    \ \"Istio high error rate\"\n      description: \"Error rate is {{ $value | humanizePercentage\
    \ }}\"\n\n  - alert: IstioHighLatency\n    expr: |\n      histogram_quantile(0.95,\n\
    \        sum(rate(istio_request_duration_milliseconds_bucket{\n          destination_service_namespace=\"\
    production\"\n        }[5m])) by (le)\n      ) > 1000\n    for: 5m\n    labels:\n\
    eco-base/part-of: eco-base\neco-base/governance: aligned\n      severity: warning\n\
    \      service: istio\n    annotations:\n      summary: \"Istio high latency\"\
    \n      description: \"P95 latency is {{ $value }}ms\"\n\n- name: infrastructure-alerts\n\
    \  interval: 30s\n  rules:\n  - alert: NodeDiskSpaceLow\n    expr: |\n      (node_filesystem_avail_bytes{fstype!=\"\
    tmpfs\"} /\n       node_filesystem_size_bytes{fstype!=\"tmpfs\"}) < 0.1\n    for:\
    \ 5m\n    labels:\neco-base/part-of: eco-base\neco-base/governance: aligned\n\
    \      severity: warning\n      app.kubernetes.io/component: infrastructure\n\
    \    annotations:\n      summary: \"Node disk space low\"\n      description:\
    \ \"Disk space is {{ $value | humanizePercentage }} available on {{ $labels.instance\
    \ }}\"\n\n  - alert: NodeMemoryHigh\n    expr: |\n      (1 - (node_memory_MemAvailable_bytes\
    \ / node_memory_MemTotal_bytes)) > 0.9\n    for: 5m\n    labels:\neco-base/part-of:\
    \ eco-base\neco-base/governance: aligned\n      severity: critical\n      app.kubernetes.io/component:\
    \ infrastructure\n    annotations:\n      summary: \"Node memory high\"\n    \
    \  description: \"Memory usage is {{ $value | humanizePercentage }} on {{ $labels.instance\
    \ }}\""
kind: ConfigMap
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/configmap/prometheus-alerts
    eco-base/urn: urn:eco-base:k8s:core:configmap:prometheus-alerts:sha256-5c3bf8460bdbd090fa86d7b770e53af5423a6d8b3c4963deb440a193cd0f165e
  labels:
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
    environment: production
  name: prometheus-alerts
  namespace: monitoring
