---
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: multi-cluster-services
  namespace: production
spec:
  addresses:
  - 10.0.0.0/16
  hosts:
  - cluster1.machine-native-ops.svc.cluster.local
  - cluster2.machine-native-ops.svc.cluster.local
  - cluster3.machine-native-ops.svc.cluster.local
  location: MESH_INTERNAL
  ports:
  - name: http
    number: 80
    protocol: HTTP
  - name: https
    number: 443
    protocol: HTTPS
  resolution: DNS
---
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: multi-cluster-gateway
  namespace: istio-system
spec:
  selector:
    istio: ingressgateway
  servers:
  - hosts:
    - '*.machine-native-ops.svc.cluster.local'
    port:
      name: tls
      number: 15443
      protocol: TLS
    tls:
      mode: AUTO_PASSTHROUGH
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: multi-cluster-routing
  namespace: production
spec:
  hosts:
  - machine-native-ops.production.svc.cluster.local
  http:
  - retries:
      attempts: 2
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream
    route:
    - destination:
        host: machine-native-ops-service
        subset: cluster1
      weight: 40
    - destination:
        host: machine-native-ops-service
        subset: cluster2
      weight: 40
    - destination:
        host: machine-native-ops-service
        subset: cluster3
      weight: 20
    timeout: 10s
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: multi-cluster-lb
  namespace: production
spec:
  host: machine-native-ops-service
  subsets:
  - labels:
      cluster: cluster1
      eco-base/governance: aligned
      eco-base/part-of: eco-base
      topology.istio.io/network: network1
    name: cluster1
  - labels:
      cluster: cluster2
      eco-base/governance: aligned
      eco-base/part-of: eco-base
      topology.istio.io/network: network2
    name: cluster2
  - labels:
      cluster: cluster3
      eco-base/governance: aligned
      eco-base/part-of: eco-base
      topology.istio.io/network: network3
    name: cluster3
  trafficPolicy:
    loadBalancer:
      localityLbSetting:
        enabled: true
        failover:
        - from: us-east-1
          to:
          - us-west-2
          - eu-west-1
        - from: us-west-2
          to:
          - us-east-1
          - eu-west-1
        - from: eu-west-1
          to:
          - us-east-1
          - us-west-2
      simple: ROUND_ROBIN
    outlierDetection:
      baseEjectionTime: 60s
      consecutiveGatewayFailure: 3
      interval: 10s
      maxEjectionPercent: 40
      minHealthPercent: 50
---
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: cross-cluster-auth
  namespace: production
spec:
  mtls:
    mode: STRICT
    overrides:
    - mtls:
        mode: PERMISSIVE
      selector:
        matchLabels:
          topology.istio.io/network: network1
    - mtls:
        mode: PERMISSIVE
      selector:
        matchLabels:
          topology.istio.io/network: network2
    - mtls:
        mode: PERMISSIVE
      selector:
        matchLabels:
          topology.istio.io/network: network3
  selector:
    matchLabels:
      app.kubernetes.io/name: machine-native-ops
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: cross-cluster-authorization
  namespace: production
spec:
  action: ALLOW
  rules:
  - from:
    - source:
        principals:
        - cluster1/ns/production/sa/machine-native-ops
        - cluster2/ns/production/sa/machine-native-ops
        - cluster3/ns/production/sa/machine-native-ops
  selector:
    matchLabels:
      app.kubernetes.io/name: machine-native-ops
  to:
  - operation:
      methods:
      - GET
      - POST
      - PUT
      - DELETE
---
apiVersion: v1
data:
  mesh: "networks:\n- networkID: network1\n  gateways:\n  - registryServiceName: istio-ingressgateway.istio-system.svc.cluster.local\n\
    \    port: 15443\n    locality: us-east-1\n- networkID: network2\n  gateways:\n\
    \  - registryServiceName: istio-ingressgateway.istio-system.svc.cluster.local\n\
    \    port: 15443\n    locality: us-west-2\n- networkID: network3\n  gateways:\n\
    \  - registryServiceName: istio-ingressgateway.istio-system.svc.cluster.local\n\
    \    port: 15443\n    locality: eu-west-1"
kind: ConfigMap
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/configmap/istio
    eco-base/urn: urn:eco-base:k8s:core:configmap:istio:sha256-ce8549dfcf31707a59141b58a97fbda8a713548ce4ae35a6a2daf50064a97429
  labels:
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: istio
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: istio
  namespace: istio-system
---
apiVersion: v1
data:
  health-check.yaml: "clusters:\n  cluster1:\n    endpoint: https://cluster1.machine-native-ops.svc.cluster.local/health\n\
    \    timeout: 5s\n    interval: 30s\n    unhealthyThreshold: 3\n    healthyThreshold:\
    \ 2\n  cluster2:\n    endpoint: https://cluster2.machine-native-ops.svc.cluster.local/health\n\
    \    timeout: 5s\n    interval: 30s\n    unhealthyThreshold: 3\n    healthyThreshold:\
    \ 2\n  cluster3:\n    endpoint: https://cluster3.machine-native-ops.svc.cluster.local/health\n\
    \    timeout: 5s\n    interval: 30s\n    unhealthyThreshold: 3\n    healthyThreshold:\
    \ 2\nfailover:\n  enabled: true\n  strategy: automatic\n  cooldown: 300s"
kind: ConfigMap
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/configmap/multi-cluster-health-config
    eco-base/urn: urn:eco-base:k8s:core:configmap:multi-cluster-health-config:sha256-31ecb013907d6579497f0268bb8b310570a4a3fdb3a65a55198671301713f3a1
  labels:
    app.kubernetes.io/component: eco-component
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: multi-cluster-health-config
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/owner: eco-system
    eco-base/platform: core
  name: multi-cluster-health-config
  namespace: production
