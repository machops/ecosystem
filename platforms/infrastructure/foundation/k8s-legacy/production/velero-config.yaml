---
apiVersion: v1
kind: Namespace
metadata:
  annotations:
    eco-base/uri: eco-base://platform/resource/infrastructure/foundation/k8s-legacy/production/velero-config.yaml
    eco-base/urn: urn:eco-base:platform:resource:infrastructure:foundation:k8s-legacy:production:velero-config.yaml
  labels:
    app.kubernetes.io/name: velero
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    environment: production
  name: velero
---
apiVersion: v1
kind: Secret
metadata:
  annotations:
    eco-base/uri: eco-base://k8s/core/secret/velero-s3-credentials
    eco-base/urn: urn:eco-base:k8s:core:secret:velero-s3-credentials:sha256-bcb7ab7bd84917773152064f9198bcc3b2a6a9614978670ed1237a52b147708b
  labels:
    app.kubernetes.io/name: velero
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    environment: production
  name: velero-s3-credentials
  namespace: velero
stringData:
  cloud: '[default]

    aws_access_key_id = ${AWS_ACCESS_KEY_ID}

    aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}

    '
type: Opaque
---
apiVersion: velero.io/v1
kind: BackupStorageLocation
metadata:
  annotations:
    eco-base/uri: eco-base://platform/resource/infrastructure/foundation/k8s-legacy/production/velero-config.yaml
    eco-base/urn: urn:eco-base:platform:resource:infrastructure:foundation:k8s-legacy:production:velero-config.yaml
  labels:
    app.kubernetes.io/name: velero
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    environment: production
  name: default
  namespace: velero
spec:
  accessMode: ReadWrite
  config:
    region: us-east-1
    s3ForcePathStyle: 'true'
    s3Url: https://s3.amazonaws.com
  objectStorage:
    bucket: machinenativeops-backups
    prefix: velero
  provider: aws
---
apiVersion: velero.io/v1
kind: VolumeSnapshotLocation
metadata:
  annotations:
    eco-base/uri: eco-base://platform/resource/infrastructure/foundation/k8s-legacy/production/velero-config.yaml
    eco-base/urn: urn:eco-base:platform:resource:infrastructure:foundation:k8s-legacy:production:velero-config.yaml
  labels:
    app.kubernetes.io/name: velero
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    environment: production
  name: default
  namespace: velero
spec:
  config:
    region: us-east-1
  provider: aws
---
apiVersion: velero.io/v1
kind: Schedule
metadata:
  annotations:
    eco-base/uri: eco-base://platform/resource/infrastructure/foundation/k8s-legacy/production/velero-config.yaml
    eco-base/urn: urn:eco-base:platform:resource:infrastructure:foundation:k8s-legacy:production:velero-config.yaml
  labels:
    app.kubernetes.io/name: velero
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    environment: production
  name: daily-cluster-backup
  namespace: velero
spec:
  schedule: 0 2 * * *
  template:
    excludedResources:
    - events
    - pods
    - endpoints
    hooks:
      resources:
      - includedNamespaces:
        - production
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: machine-native-ops
        name: pre-backup-hook
        pre:
        - exec:
            command:
            - /bin/sh
            - -c
            - echo 'Starting backup' && python -m pytest tests/backup_validation.py
            container: app
            onError: Continue
            timeout: 600s
    includedNamespaces:
    - production
    - istio-system
    - monitoring
    - velero
    storageLocation: default
    ttl: 720h
    volumeSnapshotLocations:
    - default
---
apiVersion: velero.io/v1
kind: Schedule
metadata:
  annotations:
    eco-base/uri: eco-base://platform/resource/infrastructure/foundation/k8s-legacy/production/velero-config.yaml
    eco-base/urn: urn:eco-base:platform:resource:infrastructure:foundation:k8s-legacy:production:velero-config.yaml
  labels:
    app.kubernetes.io/name: velero
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    environment: production
  name: hourly-incremental-backup
  namespace: velero
spec:
  schedule: 0 * * * *
  template:
    excludedResources:
    - events
    - pods
    - endpoints
    includedNamespaces:
    - production
    storageLocation: default
    ttl: 168h
    volumeSnapshotLocations:
    - default
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    eco-base/uri: eco-base://k8s/core/cronjob/postgres-backup
    eco-base/urn: urn:eco-base:k8s:core:cronjob:postgres-backup:sha256-35cf0c1ef29b0460cbfa7f2679189d1715c065c3153775deba75776f4f812155
  labels:
    app.kubernetes.io/name: postgres-backup
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    environment: production
  name: postgres-backup
  namespace: production
spec:
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - command:
            - /bin/sh
            - -c
            - "PGPASSWORD=\"${POSTGRES_PASSWORD}\" pg_dump \\\n  -h \"${POSTGRES_HOST}\"\
              \ \\\n  -p \"${POSTGRES_PORT}\" \\\n  -U \"${POSTGRES_USER}\" \\\n \
              \ -d \"${POSTGRES_DB}\" \\\n  --format=custom \\\n  --compress=9 \\\n\
              \  --file=/backup/postgres-$(date +%Y%m%d-%H%M%S).dump\n"
            env:
            - name: POSTGRES_HOST
              value: postgresql.production.svc.cluster.local
            - name: POSTGRES_PORT
              value: '5432'
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  key: postgres-db
                  name: machine-native-ops-secrets
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  key: postgres-user
                  name: machine-native-ops-secrets
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: postgres-password
                  name: machine-native-ops-secrets
            image: postgres:15-alpine
            name: postgres-backup
            volumeMounts:
            - mountPath: /backup
              name: backup
          restartPolicy: OnFailure
          volumes:
          - name: backup
            persistentVolumeClaim:
              claimName: postgres-backup-pvc
  schedule: 0 */4 * * *
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    eco-base/uri: eco-base://k8s/core/cronjob/redis-backup
    eco-base/urn: urn:eco-base:k8s:core:cronjob:redis-backup:sha256-e294796e6440739d0215c355a2c83f666b35a938f837d490337718d2fb931f94
  labels:
    app.kubernetes.io/name: redis-backup
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    environment: production
  name: redis-backup
  namespace: production
spec:
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - command:
            - /bin/sh
            - -c
            - "redis-cli -h \"${REDIS_HOST}\" -p \"${REDIS_PORT}\" \\\n  --rdb /backup/redis-$(date\
              \ +%Y%m%d-%H%M%S).rdb\n"
            env:
            - name: REDIS_HOST
              value: redis-master.production.svc.cluster.local
            - name: REDIS_PORT
              value: '6379'
            image: redis:7-alpine
            name: redis-backup
            volumeMounts:
            - mountPath: /backup
              name: backup
          restartPolicy: OnFailure
          volumes:
          - name: backup
            persistentVolumeClaim:
              claimName: redis-backup-pvc
  schedule: '*/30 * * * *'
