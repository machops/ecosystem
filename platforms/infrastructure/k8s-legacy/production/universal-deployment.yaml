---
apiVersion: v1
data:
  docker-compose.yaml: "version: '3.8'\n\nservices:\n  machine-native-ops:\n    image:\
    \ ${IMAGE_REGISTRY}/machine-native-ops:${VERSION:-latest}\n    container_name:\
    \ machine-native-ops\n    ports:\n      - \"8080:8080\"\n      - \"9090:9090\"\
    \n    environment:\n      - ENVIRONMENT=production\n      - LOG_LEVEL=${LOG_LEVEL:-info}\n\
    \      - DATABASE_URL=${DATABASE_URL}\n      - REDIS_URL=${REDIS_URL}\n      -\
    \ STORAGE_BACKEND=${STORAGE_BACKEND:-s3}\n      - S3_BUCKET=${S3_BUCKET}\n   \
    \   - S3_REGION=${S3_REGION}\n    volumes:\n      - ./config:/etc/config:ro\n\
    \      - /tmp:/tmp\n    networks:\n      - app-network\n    deploy:\n      replicas:\
    \ ${REPLICAS:-3}\n      resources:\n        limits:\n          cpus: '0.5'\n \
    \         memory: 512M\n        reservations:\n          cpus: '0.1'\n       \
    \   memory: 256M\n      restart_policy:\n        condition: on-failure\n     \
    \   delay: 5s\n        max_attempts: 3\n        window: 120s\n    healthcheck:\n\
    \      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:8080/health\"]\n \
    \     interval: 30s\n      timeout: 10s\n      retries: 3\n      start_period:\
    \ 40s\n    logging:\n      driver: \"json-file\"\n      options:\n        max-size:\
    \ \"10m\"\n        max-file: \"3\"\n\n  postgresql:\n    image: postgres:15-alpine\n\
    \    container_name: postgresql\n    environment:\n      - POSTGRES_DB=${POSTGRES_DB}\n\
    \      - POSTGRES_USER=${POSTGRES_USER}\n      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}\n\
    \    volumes:\n      - postgresql-data:/var/lib/postgresql/data\n    networks:\n\
    \      - app-network\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready\
    \ -U ${POSTGRES_USER}\"]\n      interval: 10s\n      timeout: 5s\n      retries:\
    \ 5\n\n  redis:\n    image: redis:7-alpine\n    container_name: redis\n    command:\
    \ redis-server --appendonly yes\n    volumes:\n      - redis-data:/data\n    networks:\n\
    \      - app-network\n    healthcheck:\n      test: [\"CMD\", \"redis-cli\", \"\
    ping\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n\n  nginx:\n\
    \    image: nginx:alpine\n    container_name: nginx\n    ports:\n      - \"80:80\"\
    \n      - \"443:443\"\n    volumes:\n      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro\n\
    \      - ./nginx/ssl:/etc/nginx/ssl:ro\n    depends_on:\n      - machine-native-ops\n\
    \    networks:\n      - app-network\n    restart: unless-stopped\n\nvolumes:\n\
    \  postgresql-data:\n  redis-data:\n\nnetworks:\n  app-network:\n    driver: bridge\n"
  helm.yaml: "apiVersion: v2\nname: machine-native-ops\ndescription: A Helm chart\
    \ for MachineNativeOps\ntype: application\nversion: 1.0.0\nappVersion: \"1.0.0\"\
    \n\ndependencies:\n  - name: postgresql\n    version: ~12.0.0\n    repository:\
    \ https://charts.bitnami.com/bitnami\n    condition: postgresql.enabled\n  \n\
    \  - name: redis\n    version: ~17.0.0\n    repository: https://charts.bitnami.com/bitnami\n\
    \    condition: redis.enabled\n  \n  - name: ingress-nginx\n    version: ~4.0.0\n\
    \    repository: https://kubernetes.github.io/ingress-nginx\n    condition: ingress-nginx.enabled"
  kubernetes.yaml: "apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: machine-native-ops\n\
    \  namespace: production\nspec:\n  replicas: ${REPLICAS:-3}\n  selector:\n   \
    \ matchLabels:\n      app.kubernetes.io/name: machine-native-ops\n  strategy:\n\
    \    type: RollingUpdate\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable:\
    \ 0\n  template:\n    \n      labels:\n        eco-base/part-of: eco-base\n  \
    \      eco-base/governance: aligned\n        app.kubernetes.io/name: machine-native-ops\n\
    \        version: ${VERSION:-latest}\n    spec:\n      serviceAccountName: machine-native-ops\n\
    \      securityContext:\n        runAsNonRoot: true\n        runAsUser: 1000\n\
    \        fsGroup: 1000\n      containers:\n      - name: app\n        image: ${IMAGE_REGISTRY}/machine-native-ops:${VERSION:-latest}\n\
    \        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort:\
    \ 8080\n          name: http\n          protocol: TCP\n        - containerPort:\
    \ 9090\n          name: metrics\n          protocol: TCP\n        env:\n     \
    \   - name: ENVIRONMENT\n          value: \"production\"\n        - name: LOG_LEVEL\n\
    \          value: \"${LOG_LEVEL:-info}\"\n        - name: DATABASE_URL\n     \
    \     valueFrom:\n            secretKeyRef:\n              name: database-credentials\n\
    \              key: url\n        - name: REDIS_URL\n          valueFrom:\n   \
    \         secretKeyRef:\n              name: redis-credentials\n             \
    \ key: url\n        resources:\n          requests:\n            memory: \"256Mi\"\
    \n            cpu: \"100m\"\n          limits:\n            memory: \"512Mi\"\n\
    \            cpu: \"500m\"\n        livenessProbe:\n          httpGet:\n     \
    \       path: /health\n            port: http\n          initialDelaySeconds:\
    \ 30\n          periodSeconds: 10\n          timeoutSeconds: 5\n          failureThreshold:\
    \ 3\n        readinessProbe:\n          httpGet:\n            path: /ready\n \
    \           port: http\n          initialDelaySeconds: 10\n          periodSeconds:\
    \ 5\n          timeoutSeconds: 3\n          failureThreshold: 3\n        securityContext:\n\
    \          allowPrivilegeEscalation: false\n          readOnlyRootFilesystem:\
    \ true\n          capabilities:\n            drop:\n            - ALL\n      \
    \  volumeMounts:\n        - name: config\n          mountPath: /etc/config\n \
    \         readOnly: true\n        - name: tmp\n          mountPath: /tmp\n   \
    \   volumes:\n      - name: config\n        configMap:\n          name: app-config\n\
    \      - name: tmp\n        emptyDir: {}\n      affinity:\n        podAntiAffinity:\n\
    \          preferredDuringSchedulingIgnoredDuringExecution:\n          - weight:\
    \ 100\n            podAffinityTerm:\n              labelSelector:\n          \
    \      matchExpressions:\n                - key: app\n                  operator:\
    \ In\n                  values:\n                  - machine-native-ops\n    \
    \          topologyKey: kubernetes.io/hostname\n"
  nomad.yaml: "job \"machine-native-ops\" {\n  datacenters = [\"dc1\"]\n  type = \"\
    service\"\n  \n  update {\n    max_parallel = 1\n    min_healthy_time = \"30s\"\
    \n    healthy_deadline = \"5m\"\n    progress_deadline = \"10m\"\n    auto_revert\
    \ = false\n    auto_promote = true\n    canary = 1\n  }\n  \n  group \"app\" {\n\
    \    count = ${REPLICAS:-3}\n    \n    network {\n      port \"http\" {\n    \
    \    static = 8080\n      }\n      port \"metrics\" {\n        static = 9090\n\
    \      }\n    }\n    \n    task \"machine-native-ops\" {\n      driver = \"docker\"\
    \n      \n      config {\n        image = \"${IMAGE_REGISTRY}/machine-native-ops:${VERSION:-latest}\"\
    \n        ports = [\"http\", \"metrics\"]\n      }\n      \n      env {\n    \
    \    ENVIRONMENT = \"production\"\n        LOG_LEVEL = \"${LOG_LEVEL:-info}\"\n\
    \        DATABASE_URL = \"${DATABASE_URL}\"\n        REDIS_URL = \"${REDIS_URL}\"\
    \n      }\n      \n      resources {\n        cpu    = 500\n        memory = 512\n\
    \      }\n      \n      service {\n        name = \"machine-native-ops\"\n   \
    \     port = \"http\"\n        tags = [\"production\"]\n        check {\n    \
    \      type     = \"http\"\n          path     = \"/health\"\n          interval\
    \ = \"10s\"\n          timeout  = \"5s\"\n          check_restart {\n        \
    \    limit = 3\n            grace = \"90s\"\n            ignore_warnings = false\n\
    \          }\n        }\n      }\n    }\n  }\n}\n"
  systemd.yaml: "[Unit]\nDescription=MachineNativeOps Application\nAfter=network.target\
    \ postgresql.service redis.service\nRequires=network.target\n\n[Service]\nType=simple\n\
    User=machine-native-ops\nGroup=machine-native-ops\nWorkingDirectory=/opt/machine-native-ops\n\
    ExecStart=/opt/machine-native-ops/bin/machine-native-ops \\\n  --config /etc/machine-native-ops/config.yaml\
    \ \\\n  --log-level ${LOG_LEVEL:-info} \\\n  --port 8080 \\\n  --metrics-port\
    \ 9090\n\nEnvironment=\"ENVIRONMENT=production\"\nEnvironment=\"LOG_LEVEL=${LOG_LEVEL:-info}\"\
    \nEnvironment=\"DATABASE_URL=${DATABASE_URL}\"\nEnvironment=\"REDIS_URL=${REDIS_URL}\"\
    \n\nRestart=always\nRestartSec=10\nStartLimitInterval=60\nStartLimitBurst=3\n\n\
    # Security settings\nNoNewPrivileges=true\nPrivateTmp=true\nProtectSystem=strict\n\
    ProtectHome=true\nReadOnlyDirectories=/\nReadWritePaths=/var/log/machine-native-ops\
    \ /tmp\n\n# Resource limits\nLimitNOFILE=65536\nLimitNPROC=4096\n\n# Logging\n\
    StandardOutput=journal\nStandardError=journal\nSyslogIdentifier=machine-native-ops\n\
    \n[Install]\nWantedBy=multi-user.target\n"
kind: ConfigMap
metadata:
  annotations:
    eco-base/uri: eco-base://k8s/core/configmap/universal-deployment-config
    eco-base/urn: urn:eco-base:k8s:core:configmap:universal-deployment-config:sha256-69026012c613e266a91d2338c606f27f81647011cc4136a5c7b8ba2025a37e54
  labels: {}
  name: universal-deployment-config
  namespace: production
