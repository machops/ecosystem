# @ECO-governed
# @ECO-layer: infrastructure
# @ECO-semantic: predictive-scaling
# @ECO-audit-trail: ../../engine/governance/GL_SEMANTIC_ANCHOR.json
# 
# GL Unified Architecture Governance Framework Activated

# Predictive Scaling Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  annotations:
    eco-base/urn: "urn:eco-base:platform:resource:infrastructure:k8s-legacy:production:predictive-scaling.yaml"
    eco-base/uri: "eco-base://platform/resource/infrastructure/k8s-legacy/production/predictive-scaling.yaml"
  name: predictive-scaling-config
  namespace: production
data:
  predictive-scaling.yaml: |
    # Predictive scaling configuration
    predictiveScaling:
      enabled: true
      
      # Time series forecasting
      forecasting:
        enabled: true
        model: prophet  # prophet | arima | lstm
        lookbackPeriod: 30d
        forecastHorizon: 7d
        updateInterval: 1h
        
        # Data sources
        dataSources:
          - name: cpu-usage
            metric: container_cpu_usage_seconds_total
            aggregation: rate
            window: 5m
          - name: memory-usage
            metric: container_memory_working_set_bytes
            aggregation: avg
            window: 5m
          - name: request-rate
            metric: istio_requests_total
            aggregation: rate
            window: 5m
          - name: response-time
            metric: istio_request_duration_milliseconds_bucket
            aggregation: histogram_quantile(0.95)
            window: 5m
          - name: error-rate
            metric: istio_requests_total{response_code=~"5.."}
            aggregation: rate
            window: 5m
        
        # Seasonality patterns
        seasonality:
          daily:
            enabled: true
            periods: 24
            fourierOrder: 5
          weekly:
            enabled: true
            periods: 7
            fourierOrder: 3
          yearly:
            enabled: true
            periods: 365
            fourierOrder: 10
        
        # Holiday effects
        holidays:
          enabled: true
          regions:
            - US
            - EU
        
        # Event-based adjustments
        events:
          enabled: true
          sources:
            - name: marketing-events
              type: calendar
              impact: +50
              duration: 3d
            - name: product-launches
              type: calendar
              impact: +100
              duration: 7d
            - name: scheduled-maintenance
              type: calendar
              impact: -50
              duration: 1d
      
      # Scaling prediction
      scalingPrediction:
        enabled: true
        interval: 5m
        
        # Predictive metrics
        metrics:
          - name: predicted-cpu-usage
            forecastHorizon: 1h
            threshold: 80
            action: scale-up
            
          - name: predicted-memory-usage
            forecastHorizon: 1h
            threshold: 90
            action: scale-up
            
          - name: predicted-request-rate
            forecastHorizon: 30m
            threshold: 1000
            unit: req/s
            action: scale-up
            
          - name: predicted-response-time
            forecastHorizon: 30m
            threshold: 200
            unit: ms
            action: scale-up
        
        # Scaling strategies
        strategies:
          - name: proactive-scaling
            enabled: true
            leadTime: 30m
            predictionThreshold: 0.8
            scaleUpFactor: 1.5
            scaleDownFactor: 0.8
            
          - name: reactive-scaling
            enabled: true
            leadTime: 5m
            predictionThreshold: 0.9
            scaleUpFactor: 1.2
            scaleDownFactor: 0.9
            
          - name: hybrid-scaling
            enabled: true
            proactiveLeadTime: 30m
            reactiveLeadTime: 5m
            scaleUpFactor: 1.3
            scaleDownFactor: 0.85
      
      # Resource prediction
      resourcePrediction:
        enabled: true
        interval: 1h
        
        resources:
          - name: replicas
            forecastHorizon: 1h
            minReplicas: 9
            maxReplicas: 30
            stepSize: 3
            
          - name: cpu-requests
            forecastHorizon: 1h
            minRequest: 100m
            maxRequest: 2000m
            stepSize: 100m
            
          - name: memory-requests
            forecastHorizon: 1h
            minRequest: 256Mi
            maxRequest: 4Gi
            stepSize: 256Mi
            
          - name: storage
            forecastHorizon: 24h
            minStorage: 100Gi
            maxStorage: 1Ti
            stepSize: 50Gi
      
      # Scaling policies
      scalingPolicies:
        enabled: true
        
        # Horizontal Pod Autoscaler
        hpa:
          enabled: true
          behavior:
            scaleDown:
              stabilizationWindowSeconds: 300
              policies:
              - type: Percent
                value: 10
                periodSeconds: 60
            scaleUp:
              stabilizationWindowSeconds: 0
              policies:
              - type: Percent
                value: 50
                periodSeconds: 60
              - type: Pods
                value: 3
                periodSeconds: 60
              selectPolicy: Max
        
        # Vertical Pod Autoscaler
        vpa:
          enabled: true
          updatePolicy:
            updateMode: Auto
          resourcePolicy:
            containerPolicies:
            - containerName: '*'
              minAllowed:
                cpu: 100m
                memory: 256Mi
              maxAllowed:
                cpu: 2000m
                memory: 4Gi
              controlledResources: ["cpu", "memory"]
              controlledValues: RequestsAndLimits
        
        # Cluster Autoscaler
        clusterAutoscaler:
          enabled: true
          minNodes: 3
          maxNodes: 20
          scaleDownEnabled: true
          scaleDownUnneededTime: 10m
          scaleDownUtilizationThreshold: 0.5
          balanceSimilarNodeGroups: true
      
      # Predictive alerting
      alerting:
        enabled: true
        
        rules:
          - name: PredictedResourceShortage
            condition: predicted-cpu > 90% OR predicted-memory > 95%
            duration: 30m
            severity: warning
            message: "Predicted resource shortage in {{ leadTime }}: {{ prediction }}"
            
          - name: ScalingEvent
            condition: scaling-triggered
            severity: info
            message: "Scaling event triggered: {{ action }} {{ factor }}"
            
          - name: PredictionAccuracy
            condition: prediction-error > 20%
            duration: 1h
            severity: warning
            message: "Prediction accuracy degraded: {{ accuracy }}"
      
      # Model training
      modelTraining:
        enabled: true
        schedule: weekly
        trainingWindow: 30d
        validationWindow: 7d
        retrainOnDrift: true
        driftThreshold: 10
        
        modelMetrics:
          - name: mae  # Mean Absolute Error
            threshold: 10
          - name: mape  # Mean Absolute Percentage Error
            threshold: 15
          - name: rmse  # Root Mean Square Error
            threshold: 20