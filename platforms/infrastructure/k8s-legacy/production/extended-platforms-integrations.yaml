# @ECO-governed
# @ECO-layer: infrastructure
# @ECO-semantic: extended-platforms-integrations
# @ECO-audit-trail: ../../engine/governance/GL_SEMANTIC_ANCHOR.json
# 
# GL Unified Architecture Governance Framework Activated

# Extended Platforms Integrations Configuration
# Integrations for Cloudflare, Supabase, GitBook, and other platforms

apiVersion: v1
kind: ConfigMap
metadata:
  annotations:
    eco-base/urn: "urn:eco-base:platform:resource:infrastructure:k8s-legacy:production:extended-platforms-integrations.yaml"
    eco-base/uri: "eco-base://platform/resource/infrastructure/k8s-legacy/production/extended-platforms-integrations.yaml"
  name: extended-platforms-integrations
  namespace: production
data:
  # Cloudflare Integrations
  cloudflare-integrations.yaml: |
    cloudflareIntegrations:
      # Webhook Integration
      webhook:
        enabled: ${CLOUDFLARE_WEBHOOK_ENABLED:-true}
        secret: ${CLOUDFLARE_WEBHOOK_SECRET:-}
        endpoints:
          - url: ${API_WEBHOOK_URL:-https://api.machine-native-ops.com/webhooks/cloudflare}
            events:
              - worker.script.published
              - worker.script.updated
              - worker.script.deployed
            headers:
              - name: User-Agent
                value: Cloudflare-Webhook
              - name: X-Cloudflare-Signature
                value: ${CLOUDFLARE_WEBHOOK_SECRET:-}
      
      # Analytics Integration
      analytics:
        enabled: ${CLOUDFLARE_ANALYTICS_ENABLED:-true}
        provider: ${ANALYTICS_PROVIDER:-google-analytics}
        trackingId: ${GA_TRACKING_ID:-}
        metrics:
          - pageViews
          - uniqueVisitors
          - bounceRate
          - sessionDuration
        events:
          - workerInvocation
          - databaseQuery
          - storageOperation
        dimensions:
          - workerName
          - route
          - status
          - errorType
      
      # Logging Integration
      logging:
        enabled: ${CLOUDFLARE_LOGGING_ENABLED:-true}
        provider: ${LOGGING_PROVIDER:-cloudflare}
        logPush:
          enabled: true
          destination:
            type: r2
            bucketName: ${CLOUDFLARE_R2_BUCKET:-machine-native-ops-logs}
            path: /logs/worker/{date}
        logLevel: ${LOG_LEVEL:-info}
        includeMetadata: true
        sampling: ${LOG_SAMPLING:-1.0}
      
      # Monitoring Integration
      monitoring:
        enabled: ${CLOUDFLARE_MONITORING_ENABLED:-true}
        provider: ${MONITORING_PROVIDER:-prometheus}
        metricsEndpoint: ${PROMETHEUS_REMOTE_WRITE_URL:-}
        metrics:
          - name: worker_requests_total
            type: counter
            labels:
    eco-base/part-of: eco-base
    eco-base/governance: aligned
              - worker_name
              - route
              - status
          - name: worker_duration_seconds
            type: histogram
            labels:
    eco-base/part-of: eco-base
    eco-base/governance: aligned
              - worker_name
              - route
            buckets:
              - 0.005
              - 0.01
              - 0.025
              - 0.05
              - 0.1
              - 0.25
              - 0.5
              - 1
              - 2.5
              - 5
              - 10
          - name: kv_operations_total
            type: counter
            labels:
    eco-base/part-of: eco-base
    eco-base/governance: aligned
              - operation
              - status
          - name: r2_operations_total
            type: counter
            labels:
    eco-base/part-of: eco-base
    eco-base/governance: aligned
              - operation
              - status
      
      # D1 Database Integration
      d1Integration:
        enabled: ${CLOUDFLARE_D1_INTEGRATION_ENABLED:-true}
        connectionPooling:
          enabled: true
          maxConnections: 10
          idleTimeout: 30
        queryLogging:
          enabled: true
          slowQueryThreshold: 1000  # milliseconds
        migrations:
          autoApply: true
          path: ./cloudflare/d1/migrations
        backups:
          enabled: true
          schedule: "0 2 * * *"  # Daily at 2 AM
          retention: 7
      
      # R2 Storage Integration
      r2Integration:
        enabled: ${CLOUDFLARE_R2_INTEGRATION_ENABLED:-true}
        lifecycle:
          enabled: true
          rules:
            - id: transition-to-infrequent-access
              status: enabled
              transitions:
                - days: 30
                  storageClass: INFREQUENT_ACCESS
            - id: expire-old-files
              status: enabled
              expiration:
                days: 365
        versioning:
          enabled: true
          maxVersions: 10
        encryption:
          type: AES256
          kmsKeyId: ${KMS_KEY_ID:-}
      
      # Pages Integration
      pagesIntegration:
        enabled: ${CLOUDFLARE_PAGES_INTEGRATION_ENABLED:-true}
        previewDeployments:
          enabled: true
          branch: preview/*
          environment:
            - name: ENVIRONMENT
              value: preview
        productionBranch: main
        build:
          command: npm run build
          outputDirectory: dist
          environment:
            - name: NODE_ENV
              value: production
            - name: VITE_API_URL
              value: ${API_URL:-https://api.machine-native-ops.com}
        headers:
          - pattern: /*
            headers:
              - name: X-Frame-Options
                value: DENY
              - name: X-Content-Type-Options
                value: nosniff
              - name: X-XSS-Protection
                value: 1; mode=block
              - name: Strict-Transport-Security
                value: max-age=31536000; includeSubDomains
        redirects:
          - source: /old-path/*
            destination: /new-path/:splat
            statusCode: 301
        rewrites:
          - source: /api/*
            destination: https://api.machine-native-ops.com/:splat
  
  # Supabase Integrations
  supabase-integrations.yaml: |
    supabaseIntegrations:
      # Webhook Integration
      webhook:
        enabled: ${SUPABASE_WEBHOOK_ENABLED:-true}
        secret: ${SUPABASE_WEBHOOK_SECRET:-}
        endpoints:
          - url: ${API_WEBHOOK_URL:-https://api.machine-native-ops.com/webhooks/supabase}
            events:
              - database.*
              - storage.*
              - auth.*
            headers:
              - name: User-Agent
                value: Supabase-Webhook
              - name: X-Supabase-Signature
                value: ${SUPABASE_WEBHOOK_SECRET:-}
      
      # PostgreSQL Integration
      postgresqlIntegration:
        enabled: ${SUPABASE_POSTGRESQL_INTEGRATION_ENABLED:-true}
        connectionString: ${SUPABASE_DATABASE_URL:-}
        poolSize: ${SUPABASE_POOL_SIZE:-10}
        connectionTimeout: 30
        queryTimeout: 60
        idleTimeout: 300
        sslMode: require
        migrations:
          autoApply: true
          path: ./supabase/migrations
          table: supabase_migrations
        replication:
          enabled: false
          slotName: supabase_replication_slot
          publicationName: supabase_publication
        backups:
          enabled: true
          retention: 7
          schedule: "0 2 * * *"  # Daily at 2 AM
      
      # Realtime Integration
      realtimeIntegration:
        enabled: ${SUPABASE_REALTIME_INTEGRATION_ENABLED:-true}
        channels:
          - name: notifications
            config:
              broadcast:
                - self: true
                - others: true
              presence:
                - key: user_id
              postgresChanges:
                - event: INSERT
                  schema: public
                  table: notifications
                  filter: user_id=eq.user_id()
        subscriptions:
          - name: user-notifications
            channel: notifications
            events:
              - postgres_changes
              - broadcast
              - presence
        jwt:
          issuer: https://${SUPABASE_PROJECT_ID}.supabase.co/auth/v1
          audience: authenticated
          expiration: 3600
      
      # Storage Integration
      storageIntegration:
        enabled: ${SUPABASE_STORAGE_INTEGRATION_ENABLED:-true}
        buckets:
          - name: documents
            config:
              public: false
              fileSizeLimit: 10485760  # 10MB
              allowedMimeTypes:
                - application/pdf
                - application/msword
              cors:
                allowedOrigins:
                  - https://machine-native-ops.com
                allowedMethods:
                  - POST
                  - GET
                  - PUT
                  - DELETE
        policies:
          - name: documents-select-own
            bucket: documents
            operation: SELECT
            definition: "auth.uid() = storage.foldername"
        transformations:
          enabled: true
          formats:
            - thumbnail:
                width: 200
                height: 200
                fit: cover
            - medium:
                width: 800
                height: 600
                fit: inside
      
      # Edge Functions Integration
      edgeFunctionsIntegration:
        enabled: ${SUPABASE_EDGE_FUNCTIONS_INTEGRATION_ENABLED:-true}
        runtime: deno
        timeout: 60
        memory: 512
        functions:
          - name: webhook-handler
            path: /webhook
            method: POST
            code: ./supabase/functions/webhook-handler/index.ts
            env:
              - name: WEBHOOK_SECRET
                value: ${WEBHOOK_SECRET:-}
              - name: DATABASE_URL
                value: ${SUPABASE_DATABASE_URL:-}
        deployment:
          autoDeploy: true
          branch: main
        monitoring:
          enabled: true
          metricsEndpoint: ${PROMETHEUS_REMOTE_WRITE_URL:-}
          logs:
            enabled: true
            level: info
      
      # Auth Integration
      authIntegration:
        enabled: ${SUPABASE_AUTH_INTEGRATION_ENABLED:-true}
        providers:
          - name: email
            enabled: true
            requireEmailConfirmation: true
          - name: google
            enabled: ${GOOGLE_AUTH_ENABLED:-true}
            clientId: ${GOOGLE_OAUTH_CLIENT_ID:-}
            clientSecret: ${GOOGLE_OAUTH_CLIENT_SECRET:-}
            scopes:
              - email
              - profile
          - name: github
            enabled: ${GITHUB_AUTH_ENABLED:-true}
            clientId: ${GITHUB_OAUTH_CLIENT_ID:-}
            clientSecret: ${GITHUB_OAUTH_CLIENT_SECRET:-}
            scopes:
              - user:email
              - read:user
        session:
          duration: 3600  # 1 hour
          inactivityTimeout: 300  # 5 minutes
        mfa:
          enabled: ${SUPABASE_MFA_ENABLED:-true}
          factor: totp
          issuer: MachineNativeOps
        jwt:
          secret: ${SUPABASE_JWT_SECRET:-}
          expiration: 3600
          refreshExpiration: 604800  # 7 days
  
  # GitBook Integrations
  gitbook-integrations.yaml: |
    gitbookIntegrations:
      # GitHub Integration
      github:
        enabled: ${GITBOOK_GITHUB_INTEGRATION_ENABLED:-true}
        repository: MachineNativeOps/machine-native-ops
        syncBranches:
          - main
          - develop
        autoSync: true
        syncInterval: 300  # 5 minutes
        syncOptions:
          - syncPages: true
          - syncAssets: true
          - syncNavigation: true
          - createPullRequests: true
        webhooks:
          enabled: true
          events:
            - push
            - pull_request
            - pull_request_review
          secret: ${GITHUB_WEBHOOK_SECRET:-}
      
      # Slack Integration
      slack:
        enabled: ${GITBOOK_SLACK_INTEGRATION_ENABLED:-false}
        webhookUrl: ${SLACK_WEBHOOK_URL:-}
        channels:
          - name: documentation-updates
            events:
              - page_published
              - page_updated
              - page_deleted
            message: |
              :page_facing_up: *GitBook Update*
              
              **Event**: {{event}}
              **Page**: {{page.title}}
              **Author**: {{author.name}}
              **URL**: {{page.url}}
              
              View changes: {{page.url}}
          - name: api-updates
            events:
              - api_reference_updated
            message: |
              :books: *API Reference Updated*
              
              **Event**: {{event}}
              **API**: {{api.name}}
              **Version**: {{api.version}}
              
              View documentation: {{api.url}}
      
      # Analytics Integration
      analytics:
        enabled: ${GITBOOK_ANALYTICS_ENABLED:-true}
        providers:
          - name: google-analytics
            enabled: ${GA_ENABLED:-false}
            trackingId: ${GA_TRACKING_ID:-}
            anonymizeIp: true
            allowAdPersonalizationSignals: false
          - name: plausible
            enabled: ${PLAUSIBLE_ENABLED:-false}
            domain: ${PLAUSIBLE_DOMAIN:-machine-native-ops.gitbook.io}
            selfHosted: false
          - name: amplitude
            enabled: ${AMPLITUDE_ENABLED:-false}
            apiKey: ${AMPLITUDE_API_KEY:-}
            serverUrl: ${AMPLITUDE_SERVER_URL:-https://api.amplitude.com}
        events:
          - page_view
          - search
          - page_scroll
          - time_on_page
      
      # SEO Integration
      seo:
        enabled: ${GITBOOK_SEO_ENABLED:-true}
        title: MachineNativeOps Documentation
        description: Comprehensive documentation for the MachineNativeOps platform
        keywords:
          - MachineNativeOps
          - Machine Learning
          - AI
          - Infrastructure
          - DevOps
        ogImage: ${GITBOOK_OG_IMAGE:-https://machine-native-ops.com/og-image.png}
        twitterCard: summary_large_image
        canonicalUrl: ${GITBOOK_CANONICAL_URL:-https://machine-native-ops.gitbook.io}
        robots: index,follow
        sitemap:
          enabled: true
          changefreq: weekly
          priority: 0.8
      
      # API Reference Integration
      apiReference:
        enabled: ${GITBOOK_API_REFERENCE_ENABLED:-true}
        openApiSpec: ./openapi.yaml
        theme: light
        servers:
          - url: ${API_URL:-https://api.machine-native-ops.com}
            description: Production API
          - url: https://staging-api.machine-native-ops.com
            description: Staging API
        authentication:
          type: bearer
          scheme: jwt
          bearerFormat: JWT
        codeSamples:
          enabled: true
          languages:
            - javascript
            - python
            - go
            - rust
            - curl
      
      # Webhooks
      webhooks:
        enabled: ${GITBOOK_WEBHOOKS_ENABLED:-true}
        secret: ${GITBOOK_WEBHOOK_SECRET:-}
        events:
          - content.published
          - content.updated
          - content.deleted
          - content.moved
        endpoints:
          - url: ${WEBHOOK_ENDPOINT:-https://api.machine-native-ops.com/webhooks/gitbook}
            secret: ${WEBHOOK_SECRET:-}
            events:
              - content.published
              - content.updated
            headers:
              - name: User-Agent
                value: GitBook-Webhook
              - name: X-GitBook-Signature
                value: ${GITBOOK_WEBHOOK_SECRET:-}
          - url: ${SLACK_WEBHOOK_URL:-}
            secret: ${SLACK_WEBHOOK_SECRET:-}
            events:
              - content.published
              - content.updated
            format: slack
      
      # Search Integration
      search:
        enabled: ${GITBOOK_SEARCH_ENABLED:-true}
        provider: algolia
        apiKey: ${ALGOLIA_API_KEY:-}
        appId: ${ALGOLIA_APP_ID:-}
        indexName: ${ALGOLIA_INDEX_NAME:-machine-native-ops-docs}
        searchableAttributes:
          - title
          - content
          - headings
        attributesToRetrieve:
          - title
          - content
          - url
          - excerpt
        customSettings:
          - searchableAttributes:
              - unordered(title)
              - unordered(content)
          - attributesToSnippet:
              - content:20
          - snippetEllipsisText: "..."
  
  # Additional Platforms Integrations
  additional-integrations.yaml: |
    additionalIntegrations:
      # Vercel Integration
      vercel:
        enabled: ${VERCEL_ENABLED:-false}
        teamId: ${VERCEL_TEAM_ID:-}
        projectId: ${VERCEL_PROJECT_ID:-}
        deployments:
          preview:
            branch: preview/*
            environment:
              - name: ENVIRONMENT
                value: preview
          production:
            branch: main
            environment:
              - name: ENVIRONMENT
                value: production
        domains:
          - machine-native-ops.com
          - www.machine-native-ops.com
        env:
          - name: DATABASE_URL
            value: ${DATABASE_URL:-}
          - name: REDIS_URL
            value: ${REDIS_URL:-}
          - name: NEXT_PUBLIC_API_URL
            value: ${NEXT_PUBLIC_API_URL:-https://api.machine-native-ops.com}
        build:
          command: npm run build
          outputDirectory: .next
        webhooks:
          enabled: true
          url: ${WEBHOOK_ENDPOINT:-https://api.machine-native-ops.com/webhooks/vercel}
          secret: ${VERCEL_WEBHOOK_SECRET:-}
      
      # Netlify Integration
      netlify:
        enabled: ${NETLIFY_ENABLED:-false}
        siteId: ${NETLIFY_SITE_ID:-}
        build:
          command: npm run build
          publish: dist
          functions: netlify/functions
        domains:
          - machine-native-ops.netlify.app
        env:
          - name: DATABASE_URL
            value: ${DATABASE_URL:-}
          - name: REDIS_URL
            value: ${REDIS_URL:-}
        headers:
          - pattern: /*
            headers:
              - name: X-Frame-Options
                value: DENY
              - name: X-Content-Type-Options
                value: nosniff
        redirects:
          - from: /old-path/*
            to: /new-path/:splat
            status: 301
        webhooks:
          enabled: true
          url: ${WEBHOOK_ENDPOINT:-https://api.machine-native-ops.com/webhooks/netlify}
          secret: ${NETLIFY_WEBHOOK_SECRET:-}
      
      # Render Integration
      render:
        enabled: ${RENDER_ENABLED:-false}
        serviceId: ${RENDER_SERVICE_ID:-}
        type: web_service
        env:
          - name: DATABASE_URL
            value: ${DATABASE_URL:-}
          - name: REDIS_URL
            value: ${REDIS_URL:-}
        build:
          command: npm run build
          outputDirectory: dist
        scaling:
          instances: 1
          memory: 512
          cpu: 0.5
        healthCheck:
          enabled: true
          path: /health
          interval: 30
          timeout: 5
        webhooks:
          enabled: true
          url: ${WEBHOOK_ENDPOINT:-https://api.machine-native-ops.com/webhooks/render}
          secret: ${RENDER_WEBHOOK_SECRET:-}
      
      # Railway Integration
      railway:
        enabled: ${RAILWAY_ENABLED:-false}
        projectId: ${RAILWAY_PROJECT_ID:-}
        environment:
          - name: DATABASE_URL
            value: ${DATABASE_URL:-}
          - name: REDIS_URL
            value: ${REDIS_URL:-}
        services:
          - name: machine-native-ops
            env: node
            buildCommand: npm run build
            startCommand: npm start
            scaling:
              minInstances: 1
              maxInstances: 3
        webhooks:
          enabled: true
          url: ${WEBHOOK_ENDPOINT:-https://api.machine-native-ops.com/webhooks/railway}
          secret: ${RAILWAY_WEBHOOK_SECRET:-}