---
apiVersion: v1
data:
  trace-analysis.json: "{\n  \"dashboard\": {\n    \"title\": \"Distributed Tracing\
    \ Analysis\",\n    \"panels\": [\n      {\n        \"title\": \"Trace Throughput\"\
    ,\n        \"targets\": [\n          {\n            \"expr\": \"rate(jaeger_traces_started_total[5m])\"\
    ,\n            \"legendFormat\": \"Traces/sec\"\n          }\n        ],\n   \
    \     \"type\": \"graph\"\n      },\n      {\n        \"title\": \"Trace Duration\
    \ Percentiles\",\n        \"targets\": [\n          {\n            \"expr\": \"\
    histogram_quantile(0.50, sum(rate(jaeger_tracer_duration_milliseconds_bucket[5m]))\
    \ by (le))\",\n            \"legendFormat\": \"P50\"\n          },\n         \
    \ {\n            \"expr\": \"histogram_quantile(0.95, sum(rate(jaeger_tracer_duration_milliseconds_bucket[5m]))\
    \ by (le))\",\n            \"legendFormat\": \"P95\"\n          },\n         \
    \ {\n            \"expr\": \"histogram_quantile(0.99, sum(rate(jaeger_tracer_duration_milliseconds_bucket[5m]))\
    \ by (le))\",\n            \"legendFormat\": \"P99\"\n          }\n        ],\n\
    \        \"type\": \"graph\"\n      },\n      {\n        \"title\": \"Trace Duration\
    \ by Service\",\n        \"targets\": [\n          {\n            \"expr\": \"\
    histogram_quantile(0.95, sum(rate(jaeger_tracer_duration_milliseconds_bucket[5m]))\
    \ by (le, service_name))\",\n            \"legendFormat\": \"{{service_name}}\"\
    \n          }\n        ],\n        \"type\": \"heatmap\"\n      },\n      {\n\
    \        \"title\": \"Span Duration Distribution\",\n        \"targets\": [\n\
    \          {\n            \"expr\": \"histogram_quantile(0.95, sum(rate(jaeger_span_duration_milliseconds_bucket[5m]))\
    \ by (le, operation_name))\",\n            \"legendFormat\": \"{{operation_name}}\"\
    \n          }\n        ],\n        \"type\": \"graph\"\n      },\n      {\n  \
    \      \"title\": \"Error Rate\",\n        \"targets\": [\n          {\n     \
    \       \"expr\": \"sum(rate(jaeger_spans_total{error=true}[5m])) / sum(rate(jaeger_spans_total[5m]))\
    \ * 100\",\n            \"legendFormat\": \"Error Rate %\"\n          }\n    \
    \    ],\n        \"type\": \"graph\"\n      },\n      {\n        \"title\": \"\
    Trace Sampling Rate\",\n        \"targets\": [\n          {\n            \"expr\"\
    : \"sum(rate(jaeger_spans_total[5m])) / sum(rate(istio_requests_total[5m])) *\
    \ 100\",\n            \"legendFormat\": \"Sampling Rate %\"\n          }\n   \
    \     ],\n        \"type\": \"gauge\"\n      },\n      {\n        \"title\": \"\
    Service Dependency Graph\",\n        \"targets\": [\n          {\n           \
    \ \"expr\": \"sum(increase(istio_requests_total[5m])) by (source_service, destination_service)\"\
    ,\n            \"legendFormat\": \"{{source_service}} -> {{destination_service}}\"\
    \n          }\n        ],\n        \"type\": \"graph\"\n      },\n      {\n  \
    \      \"title\": \"Hot Operations\",\n        \"targets\": [\n          {\n \
    \           \"expr\": \"topk(10, sum(rate(jaeger_spans_total[5m])) by (operation_name))\"\
    ,\n            \"legendFormat\": \"{{operation_name}}\"\n          }\n       \
    \ ],\n        \"type\": \"table\"\n      },\n      {\n        \"title\": \"Slow\
    \ Traces (>5s)\",\n        \"targets\": [\n          {\n            \"expr\":\
    \ \"sum(increase(jaeger_tracer_duration_milliseconds_bucket{le=&quot;+Inf&quot;}[5m]))\
    \ by (trace_id)\",\n            \"legendFormat\": \"{{trace_id}}\"\n         \
    \ }\n        ],\n        \"type\": \"table\"\n      },\n      {\n        \"title\"\
    : \"Trace Success Rate\",\n        \"targets\": [\n          {\n            \"\
    expr\": \"sum(rate(jaeger_traces_finished_total{success=true}[5m])) / sum(rate(jaeger_traces_finished_total[5m]))\
    \ * 100\",\n            \"legendFormat\": \"Success Rate %\"\n          }\n  \
    \      ],\n        \"type\": \"gauge\"\n      }\n    ]\n  }\n}\n"
kind: ConfigMap
metadata:
  annotations:
    eco-base/uri: eco-base://k8s/core/configmap/trace-analysis-dashboard
    eco-base/urn: urn:eco-base:k8s:core:configmap:trace-analysis-dashboard:sha256-064b9c987290f6ba45c0c07ed3ba0084ec5ce92b5ca8961275c7c308185f2841
  labels:
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    grafana_dashboard: '1'
  name: trace-analysis-dashboard
  namespace: istio-system
---
apiVersion: v1
data:
  alerts.yaml: "groups:\n- name: trace_analysis\n  rules:\n  # High error rate in\
    \ traces\n  - alert: HighTraceErrorRate\n    expr: |\n      sum(rate(jaeger_spans_total{error=true}[5m]))\
    \ \n      / sum(rate(jaeger_spans_total[5m])) * 100 > 5\n    for: 5m\n    labels:\n\
    eco-base/part-of: eco-base\neco-base/governance: aligned\n      severity: warning\n\
    \      team: platform\n    annotations:\n      summary: \"High error rate detected\
    \ in traces\"\n      description: \"Trace error rate is {{ $value }}% for the\
    \ last 5 minutes\"\n  \n  # Slow traces detection\n  - alert: SlowTracesDetected\n\
    \    expr: |\n      histogram_quantile(0.95, sum(rate(jaeger_tracer_duration_milliseconds_bucket[5m]))\
    \ by (le)) > 5000\n    for: 10m\n    labels:\neco-base/part-of: eco-base\neco-base/governance:\
    \ aligned\n      severity: warning\n      team: platform\n    annotations:\n \
    \     summary: \"Slow traces detected\"\n      description: \"95th percentile\
    \ trace duration is {{ $value }}ms for the last 10 minutes\"\n  \n  # Trace sampling\
    \ rate anomaly\n  - alert: TraceSamplingRateAnomaly\n    expr: |\n      abs(\n\
    \        sum(rate(jaeger_spans_total[5m])) / sum(rate(istio_requests_total[5m]))\
    \ * 100 \n        - 10\n      ) > 50\n    for: 5m\n    labels:\neco-base/part-of:\
    \ eco-base\neco-base/governance: aligned\n      severity: info\n      team: platform\n\
    \    annotations:\n      summary: \"Trace sampling rate anomaly detected\"\n \
    \     description: \"Current sampling rate is {{ $value }}%, expected ~10%\"\n\
    \  \n  # Missing trace context\n  - alert: MissingTraceContext\n    expr: |\n\
    \      sum(rate(istio_requests_total[5m])) - sum(rate(jaeger_traces_started_total[5m]))\
    \ > 100\n    for: 5m\n    labels:\neco-base/part-of: eco-base\neco-base/governance:\
    \ aligned\n      severity: warning\n      team: platform\n    annotations:\n \
    \     summary: \"Missing trace context detected\"\n      description: \"{{ $value\
    \ }} requests per second are not being traced\"\n"
kind: ConfigMap
metadata:
  annotations:
    eco-base/uri: eco-base://k8s/core/configmap/trace-analysis-alerts
    eco-base/urn: urn:eco-base:k8s:core:configmap:trace-analysis-alerts:sha256-cdbcaacafb499a8d757f53cae4b58c1c54454b0ca231ce7a061df82ccc5351c8
  labels: {}
  name: trace-analysis-alerts
  namespace: istio-system
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    eco-base/uri: eco-base://k8s/core/cronjob/trace-analysis-report
    eco-base/urn: urn:eco-base:k8s:core:cronjob:trace-analysis-report:sha256-1dda8eeeb5027749e53ad09c809bab2b6da32bcc3583c596f89f3958874f7be7
  labels: {}
  name: trace-analysis-report
  namespace: istio-system
spec:
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - command:
            - /bin/sh
            - -c
            - "# Analyze traces and generate report\necho \"=== Trace Analysis Report\
              \ - $(date) ===\" > /tmp/trace-report.txt\necho \"\" >> /tmp/trace-report.txt\n\
              \n# Get trace statistics\necho \"Trace Statistics:\" >> /tmp/trace-report.txt\n\
              curl -s http://jaeger-query:16686/api/traces?service=machine-native-ops-production&limit=1000\
              \ \\\n  | jq '.data | length' >> /tmp/trace-report.txt\n\necho \"\"\
              \ >> /tmp/trace-report.txt\necho \"Slow Traces (>5s):\" >> /tmp/trace-report.txt\n\
              curl -s \"http://jaeger-query:16686/api/traces?service=machine-native-ops-production&limit=100\"\
              \ \\\n  | jq -r '.data[] | select(.duration > 5000000) | .traceID' >>\
              \ /tmp/trace-report.txt\n\ncat /tmp/trace-report.txt\n"
            image: jaegertracing/jaeger-query:latest
            name: trace-analyzer
            volumeMounts:
            - mountPath: /tmp
              name: reports
          restartPolicy: OnFailure
          volumes:
          - emptyDir: {}
            name: reports
  schedule: 0 6 * * *
  successfulJobsHistoryLimit: 3
