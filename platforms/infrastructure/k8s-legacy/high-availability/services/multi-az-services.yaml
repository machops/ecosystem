--- null
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/service/machine-native-ops
    eco-base/urn: urn:eco-base:k8s:core:service:machine-native-ops:sha256-376797a973deaa454a431e8e60d5e9692f53b9187d8f627af9dca32271987b08
    prometheus.io/port: '9090'
    prometheus.io/scrape: 'true'
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: 'true'
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-healthy-threshold: '2'
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval-seconds: '30'
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-path: /health
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol: HTTP
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-timeout-seconds: '5'
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-unhealthy-threshold: '3'
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
    service.beta.kubernetes.io/aws-load-balancer-type: nlb
  labels:
    app.kubernetes.io/component: application
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: machine-native-ops
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
  name: machine-native-ops
  namespace: platform-03
spec:
  externalTrafficPolicy: Local
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 8080
  - name: https
    port: 443
    protocol: TCP
    targetPort: 8080
  - name: metrics
    port: 9090
    protocol: TCP
    targetPort: 9090
  selector:
    app.kubernetes.io/name: machine-native-ops
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800
  type: LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/service/machine-native-ops-api
    eco-base/urn: urn:eco-base:k8s:core:service:machine-native-ops-api:sha256-11da0696acaefa96e97329bf33a229444bd39c27994c99b011f988d45eeb94b0
    prometheus.io/port: '9090'
    prometheus.io/scrape: 'true'
  labels:
    app.kubernetes.io/component: api
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: machine-native-ops-api
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
  name: machine-native-ops-api
  namespace: platform-03
spec:
  ports:
  - name: http
    port: 8080
    protocol: TCP
    targetPort: 8080
  - name: metrics
    port: 9090
    protocol: TCP
    targetPort: 9090
  selector:
    app.kubernetes.io/name: machine-native-ops-api
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/service/machine-native-ops-worker
    eco-base/urn: urn:eco-base:k8s:core:service:machine-native-ops-worker:sha256-edad0b9abe0f08069df5a3102dfc464e7a8537610d3ff8f6cc3131f02b3ea5f5
  labels:
    app.kubernetes.io/component: worker
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: machine-native-ops-worker
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
  name: machine-native-ops-worker
  namespace: platform-03
spec:
  clusterIP: None
  ports:
  - name: metrics
    port: 9090
    protocol: TCP
    targetPort: 9090
  selector:
    app.kubernetes.io/name: machine-native-ops-worker
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/service/redis-cluster
    eco-base/urn: urn:eco-base:k8s:core:service:redis-cluster:sha256-089470f0056bc756151ff59dbf40525e57a5406d6c9c660bb43d9e96ec7a6df3
  labels:
    app.kubernetes.io/component: cache
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: redis-cluster
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
  name: redis-cluster
  namespace: platform-03
spec:
  ports:
  - name: redis
    port: 6379
    protocol: TCP
    targetPort: 6379
  - name: metrics
    port: 9121
    protocol: TCP
    targetPort: 9121
  selector:
    app.kubernetes.io/name: rediscluster
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/service/postgres
    eco-base/urn: urn:eco-base:k8s:core:service:postgres:sha256-3e7a93da3fb2009cf37f9fcee21181cff03304f2b49f23f5d28317d5d2b2b20e
    prometheus.io/port: '9187'
    prometheus.io/scrape: 'true'
  labels:
    app.kubernetes.io/component: database
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: postgres
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
  name: postgres
  namespace: platform-03
spec:
  ports:
  - name: postgres
    port: 5432
    protocol: TCP
    targetPort: 5432
  - name: metrics
    port: 9187
    protocol: TCP
    targetPort: 9187
  selector:
    app.kubernetes.io/name: postgres
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    eco-base/audit-log-level: minimal
    eco-base/governance-policy: standard-v1
    eco-base/uri: eco-base://k8s/core/service/monitoring
    eco-base/urn: urn:eco-base:k8s:core:service:monitoring:sha256-c782c32349d2c8a919851a01bc0dfa8cd2267f925338457f0f5399c04f63a312
  labels:
    app.kubernetes.io/component: observability
    app.kubernetes.io/instance: eco-instance
    app.kubernetes.io/name: monitoring
    app.kubernetes.io/part-of: eco-base
    app.kubernetes.io/version: 1.0.0
    eco-base/environment: development
    eco-base/governance: aligned
    eco-base/owner: eco-system
    eco-base/part-of: eco-base
    eco-base/platform: core
  name: monitoring
  namespace: monitoring
spec:
  externalTrafficPolicy: Local
  ports:
  - name: prometheus
    port: 9090
    protocol: TCP
    targetPort: 9090
  - name: grafana
    port: 3000
    protocol: TCP
    targetPort: 3000
  selector:
    app.kubernetes.io/name: prometheus
  type: LoadBalancer
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/name: machine-native-ops
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    release: prometheus
  name: machine-native-ops
  namespace: platform-03
spec:
  endpoints:
  - interval: 30s
    path: /metrics
    port: metrics
    scheme: http
  selector:
    matchLabels:
      app.kubernetes.io/name: machine-native-ops
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/name: machine-native-ops-api
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    release: prometheus
  name: machine-native-ops-api
  namespace: platform-03
spec:
  endpoints:
  - interval: 15s
    path: /metrics
    port: metrics
    scheme: http
  selector:
    matchLabels:
      app.kubernetes.io/name: machine-native-ops-api
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/name: machine-native-ops-worker
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    release: prometheus
  name: machine-native-ops-worker
  namespace: platform-03
spec:
  endpoints:
  - interval: 60s
    path: /metrics
    port: metrics
    scheme: http
  selector:
    matchLabels:
      app.kubernetes.io/name: machine-native-ops-worker
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/name: redis-cluster
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    release: prometheus
  name: redis-cluster
  namespace: platform-03
spec:
  endpoints:
  - interval: 30s
    path: /metrics
    port: metrics
    scheme: http
  selector:
    matchLabels:
      app.kubernetes.io/name: rediscluster
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/name: postgres
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    release: prometheus
  name: postgres
  namespace: platform-03
spec:
  endpoints:
  - interval: 30s
    path: /metrics
    port: metrics
    scheme: http
  selector:
    matchLabels:
      app.kubernetes.io/name: postgres
---
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: machine-native-ops-gateway
  namespace: platform-03
spec:
  selector:
    istio: ingressgateway
  servers:
  - hosts:
    - machine-native-ops.example.com
    - '*.machine-native-ops.example.com'
    port:
      name: http
      number: 80
      protocol: HTTP
  - hosts:
    - machine-native-ops.example.com
    - '*.machine-native-ops.example.com'
    port:
      name: https
      number: 443
      protocol: HTTPS
    tls:
      mode: SIMPLE
      privateKey: /etc/certs/tls.key
      serverCertificate: /etc/certs/tls.crt
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: machine-native-ops-vs
  namespace: platform-03
spec:
  gateways:
  - machine-native-ops-gateway
  hosts:
  - machine-native-ops.example.com
  - '*.machine-native-ops.example.com'
  http:
  - match:
    - uri:
        prefix: /
    retries:
      attempts: 3
      perTryTimeout: 10s
      retryOn: 5xx,connect-failure,refused-stream
    route:
    - destination:
        host: machine-native-ops
        port:
          number: 80
    timeout: 30s
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: machine-native-ops-dr
  namespace: platform-03
spec:
  host: machine-native-ops
  subsets:
  - labels:
      eco-base/governance: aligned
      eco-base/part-of: eco-base
      version: v1.0.0
    name: stable
  - labels:
      eco-base/governance: aligned
      eco-base/part-of: eco-base
      version: v1.1.0
    name: canary
  trafficPolicy:
    connectionPool:
      http:
        http1MaxPendingRequests: 50
        idleTimeout: 300s
        maxRequestsPerConnection: 3
      tcp:
        connectTimeout: 10s
        maxConnections: 100
    loadBalancer:
      localityLbSetting:
        distribute:
        - from: us-east-1a/us-east-1a/*
          to:
            us-east-1a/us-east-1a/*: 80
            us-east-1b/us-east-1b/*: 10
            us-east-1c/us-east-1c/*: 10
        - from: us-east-1b/us-east-1b/*
          to:
            us-east-1a/us-east-1a/*: 10
            us-east-1b/us-east-1b/*: 80
            us-east-1c/us-east-1c/*: 10
        - from: us-east-1c/us-east-1c/*
          to:
            us-east-1a/us-east-1a/*: 10
            us-east-1b/us-east-1b/*: 10
            us-east-1c/us-east-1c/*: 80
        enabled: true
      simple: LEAST_CONN
    outlierDetection:
      baseEjectionTime: 60s
      consecutive5xxErrors: 3
      interval: 30s
      maxEjectionPercent: 50
      minHealthPercent: 50
    tls:
      mode: ISTIO_MUTUAL
