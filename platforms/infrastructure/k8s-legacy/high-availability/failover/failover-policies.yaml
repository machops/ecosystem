--- null
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    app.kubernetes.io/component: failover
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    type: pdb
  name: machine-native-ops-ha-pdb
  namespace: platform-03
spec:
  maxUnavailable: 33%
  minAvailable: 66%
  selector:
    matchLabels:
      app.kubernetes.io/name: machine-native-ops
---
apiVersion: scheduling.k8s.io/v1
description: High priority class for critical workloads during failover
globalDefault: false
kind: PriorityClass
metadata:
  labels:
    app.kubernetes.io/component: failover
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    type: priority
  name: critical-priority
  namespace: platform-03
value: 1000000
---
apiVersion: scheduling.k8s.io/v1
description: High priority class for important workloads
globalDefault: false
kind: PriorityClass
metadata:
  labels:
    app.kubernetes.io/component: failover
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    type: priority
  name: high-priority
  namespace: platform-03
value: 500000
---
apiVersion: scheduling.k8s.io/v1
description: Normal priority class for standard workloads
globalDefault: true
kind: PriorityClass
metadata:
  labels:
    app.kubernetes.io/component: failover
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    type: priority
  name: normal-priority
  namespace: platform-03
value: 0
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  labels:
    app.kubernetes.io/component: scaling
    app.kubernetes.io/name: machine-native-ops
    eco-base/governance: aligned
    eco-base/part-of: eco-base
  name: machine-native-ops-hpa
  namespace: platform-03
spec:
  behavior:
    scaleDown:
      policies:
      - periodSeconds: 60
        type: Percent
        value: 50
      stabilizationWindowSeconds: 300
    scaleUp:
      policies:
      - periodSeconds: 15
        type: Percent
        value: 100
      - periodSeconds: 15
        type: Pods
        value: 4
      selectPolicy: Max
      stabilizationWindowSeconds: 0
  maxReplicas: 30
  metrics:
  - resource:
      name: cpu
      target:
        averageUtilization: 70
        type: Utilization
    type: Resource
  - resource:
      name: memory
      target:
        averageUtilization: 80
        type: Utilization
    type: Resource
  - pods:
      metric:
        name: http_requests_per_second
      target:
        averageValue: 1000
        type: AverageValue
    type: Pods
  minReplicas: 9
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: machine-native-ops
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  labels:
    app.kubernetes.io/component: scaling
    app.kubernetes.io/name: machine-native-ops-api
    eco-base/governance: aligned
    eco-base/part-of: eco-base
  name: machine-native-ops-api-hpa
  namespace: platform-03
spec:
  behavior:
    scaleDown:
      policies:
      - periodSeconds: 90
        type: Percent
        value: 30
      stabilizationWindowSeconds: 600
    scaleUp:
      policies:
      - periodSeconds: 30
        type: Percent
        value: 50
      stabilizationWindowSeconds: 0
  maxReplicas: 18
  metrics:
  - resource:
      name: cpu
      target:
        averageUtilization: 60
        type: Utilization
    type: Resource
  - resource:
      name: memory
      target:
        averageUtilization: 70
        type: Utilization
    type: Resource
  minReplicas: 6
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: machine-native-ops-api
---
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  labels:
    app.kubernetes.io/component: scaling
    app.kubernetes.io/name: machine-native-ops
    eco-base/governance: aligned
    eco-base/part-of: eco-base
  name: machine-native-ops-vpa
  namespace: platform-03
spec:
  resourcePolicy:
    containerPolicies:
    - containerName: machine-native-ops
      controlledResources:
      - cpu
      - memory
      maxAllowed:
        cpu: 4000m
        memory: 4Gi
      minAllowed:
        cpu: 500m
        memory: 512Mi
      mode: Auto
    - containerName: istio-proxy
      controlledResources:
      - cpu
      - memory
      maxAllowed:
        cpu: 500m
        memory: 512Mi
      minAllowed:
        cpu: 100m
        memory: 128Mi
      mode: Auto
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: machine-native-ops
  updatePolicy:
    updateMode: Auto
---
apiVersion: v1
data:
  config.yaml: "zones:\n  us-east-1a:\n    enabled: true\n    health_check_interval:\
    \ 30s\n    failure_threshold: 3\n    recovery_threshold: 2\n    nodes_expected:\
    \ 5\n    pods_expected: 3\n  us-east-1b:\n    enabled: true\n    health_check_interval:\
    \ 30s\n    failure_threshold: 3\n    recovery_threshold: 2\n    nodes_expected:\
    \ 5\n    pods_expected: 3\n  us-east-1c:\n    enabled: true\n    health_check_interval:\
    \ 30s\n    failure_threshold: 3\n    recovery_threshold: 2\n    nodes_expected:\
    \ 5\n    pods_expected: 3\nfailover:\n  mode: automatic\n  cooldown_period: 300s\n\
    \  max_failover_attempts: 3\n  notification_enabled: true\n  notification_channels:\n\
    \  - slack\n  - email\n  - pagerduty\nrecovery:\n  mode: automatic\n  cooldown_period:\
    \ 600s\n  health_check_enabled: true\n"
kind: ConfigMap
metadata:
  annotations:
    eco-base/uri: eco-base://k8s/core/configmap/zone-failure-config
    eco-base/urn: urn:eco-base:k8s:core:configmap:zone-failure-config:sha256-8fdebbbe00ed5ce73dd953fc4a5b5e83441803fcbd50ca639c3a49aabe8a01cf
  labels:
    app.kubernetes.io/component: failover
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    type: config
  name: zone-failure-config
  namespace: platform-03
---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    eco-base/uri: eco-base://k8s/core/deployment/zone-failover-controller
    eco-base/urn: urn:eco-base:k8s:core:deployment:zone-failover-controller:sha256-93e7ac3d0247e545dafba2effa820c4af72c763c859cd7ddd2daed1786147448
  labels:
    app.kubernetes.io/component: failover
    app.kubernetes.io/name: zone-failover-controller
    eco-base/governance: aligned
    eco-base/part-of: eco-base
    type: controller
  name: zone-failover-controller
  namespace: platform-03
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: zone-failover-controller
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app.kubernetes.io/component: failover
        app.kubernetes.io/name: zone-failover-controller
        eco-base/governance: aligned
        eco-base/part-of: eco-base
        type: controller
        version: v1.0.0
    spec:
      containers:
      - command:
        - /bin/sh
        - -c
        - "# Zone failover controller logic\nwhile true; do\n  # Check zone health\n\
          \  for zone in us-east-1a us-east-1b us-east-1c; do\n    NODE_COUNT=$(kubectl\
          \ get nodes -l topology.kubernetes.io/zone=$zone --no-headers 2>/dev/null\
          \ | wc -l)\n    POD_COUNT=$(kubectl get pods -n machine-native-ops -l topology.kubernetes.io/zone=$zone\
          \ --no-headers 2>/dev/null | grep Running | wc -l)\n    \n    echo \"Zone\
          \ $zone: Nodes=$NODE_COUNT, Pods=$POD_COUNT\"\n    \n    # Check if zone\
          \ is healthy\n    if [ \"$NODE_COUNT\" -lt 3 ] || [ \"$POD_COUNT\" -lt 2\
          \ ]; then\n      echo \"WARNING: Zone $zone may be unhealthy\"\n      #\
          \ Trigger failover logic\n      # Send notification\n      # Update routing\n\
          \    fi\n  done\n  sleep 30\ndone\n"
        env:
        - name: NAMESPACE
          value: machine-native-ops
        - name: CHECK_INTERVAL
          value: '30'
        image: machinenativeops/zone-failover-controller:v1.0.0
        imagePullPolicy: IfNotPresent
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pgrep -f 'zone-failover' || exit 1
          initialDelaySeconds: 30
          periodSeconds: 30
        name: controller
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 128Mi
        volumeMounts:
        - mountPath: /etc/config
          name: config
          readOnly: true
        - mountPath: /var/log/failover
          name: logs
      priorityClassName: critical-priority
      serviceAccountName: zone-failover-controller
      volumes:
      - configMap:
          name: zone-failure-config
        name: config
      - emptyDir: {}
        name: logs
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: zone-failover-controller
  namespace: platform-03
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: zone-failover-controller
  namespace: platform-03
rules:
- apiGroups:
  - ''
  resources:
  - pods
  - nodes
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - apps
  resources:
  - deployments
  - statefulsets
  verbs:
  - get
  - list
  - watch
  - update
- apiGroups:
  - networking.istio.io
  resources:
  - virtualservices
  - destinationrules
  verbs:
  - get
  - list
  - watch
  - update
  - patch
- apiGroups:
  - ''
  resources:
  - configmaps
  - events
  verbs:
  - get
  - list
  - watch
  - create
  - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: zone-failover-controller
  namespace: platform-03
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
subjects:
- kind: ServiceAccount
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: circuit-breaker-failover
  namespace: platform-03
spec:
  host: machine-native-ops
  trafficPolicy:
    connectionPool:
      http:
        http1MaxPendingRequests: 50
        idleTimeout: 300s
        maxRequestsPerConnection: 3
        retryOn: 5xx,connect-failure,refused-stream
      tcp:
        connectTimeout: 10s
        maxConnections: 100
    loadBalancer:
      localityLbSetting:
        enabled: true
        failover:
        - from: us-east-1a/us-east-1a/*
          to: us-east-1b/us-east-1b/*
        - from: us-east-1b/us-east-1b/*
          to: us-east-1c/us-east-1c/*
        - from: us-east-1c/us-east-1c/*
          to: us-east-1a/us-east-1a/*
      simple: ROUND_ROBIN
    outlierDetection:
      baseEjectionTime: 300s
      consecutive5xxErrors: 5
      interval: 30s
      maxEjectionPercent: 100
      minHealthPercent: 0
