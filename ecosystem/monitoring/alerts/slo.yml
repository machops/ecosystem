groups:
  - name: eco-base.slo
    interval: 30s
    rules:
      - alert: APIHighErrorRate
        expr: |
          rate(http_requests_total{job="api-service",status=~"5.."}[5m])
          / rate(http_requests_total{job="api-service"}[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
          service:  api
        annotations:
          summary:     "API error rate > 5% (current: {{ $value | humanizePercentage }})"
          description: "The API service is returning too many 5xx errors."
          runbook_url: "http://localhost:3030/d/api-overview"

      - alert: APIHighLatency
        expr: |
          histogram_quantile(0.95,
            rate(http_request_duration_seconds_bucket{job="api-service"}[5m])
          ) > 1.0
        for: 5m
        labels:
          severity: warning
          service:  api
        annotations:
          summary: "API p95 latency > 1s (current: {{ $value | humanizeDuration }})"

      - alert: AIJobQueueDepth
        expr: celery_queue_length{queue="default"} > 50
        for: 1m
        labels:
          severity: warning
          service:  ai
        annotations:
          summary: "AI job queue depth {{ $value }} — worker may be overwhelmed"

      - alert: RedisHighMemory
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.85
        for: 2m
        labels:
          severity: warning
          service:  redis
        annotations:
          summary: "Redis memory usage > 85% (current: {{ $value | humanizePercentage }})"

      - alert: PostgresConnectionsHigh
        expr: pg_stat_activity_count > 80
        for: 3m
        labels:
          severity: warning
          service:  postgres
        annotations:
          summary: "PostgreSQL connections {{ $value }} — approaching limit of 100"

      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service {{ $labels.job }} is DOWN"
