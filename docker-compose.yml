# IndestructibleEco v1.0 — Local Development Stack
# URI: indestructibleeco://root/docker-compose
# Usage: docker compose up

version: "3.9"

services:
  # ─── Backend API (Node.js Express) ───
  api:
    build:
      context: ./backend/api
      dockerfile: Dockerfile
    container_name: eco-api
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      PORT: "3000"
      ECO_REDIS_URL: redis://redis:6379
      ECO_AI_SERVICE_GRPC: ai:8000
      ECO_AI_SERVICE_HTTP: http://ai:8001
      ECO_SUPABASE_URL: ${ECO_SUPABASE_URL:-}
      ECO_SUPABASE_KEY: ${ECO_SUPABASE_KEY:-}
      ECO_JWT_SECRET: ${ECO_JWT_SECRET:-dev-secret-change-in-production}
      ECO_CONSUL_ENDPOINT: http://consul:8500
      ECO_JAEGER_ENDPOINT: http://jaeger:14268/api/traces
    depends_on:
      - redis
      - ai
    restart: unless-stopped

  # ─── Backend AI (Python FastAPI) ───
  ai:
    build:
      context: ./backend/ai
      dockerfile: Dockerfile
    container_name: eco-ai
    ports:
      - "8000:8000"
      - "8001:8001"
    environment:
      ECO_AI_HTTP_PORT: "8001"
      ECO_AI_GRPC_PORT: "8000"
      ECO_REDIS_URL: redis://redis:6379
      ECO_CELERY_BROKER: redis://redis:6379/0
      ECO_CELERY_BACKEND: redis://redis:6379/1
      ECO_VECTOR_DIM: "1024"
      ECO_ALIGNMENT_MODEL: quantum-bert-xxl-v1
      ECO_AI_MODELS: vllm,ollama,tgi,sglang
      ECO_CONSUL_ENDPOINT: http://consul:8500
      ECO_JAEGER_ENDPOINT: http://jaeger:14268/api/traces
    depends_on:
      - redis
    restart: unless-stopped

  # ─── Redis ───
  redis:
    image: redis:7-alpine
    container_name: eco-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    restart: unless-stopped

  # ─── PostgreSQL ───
  postgres:
    image: postgres:16-alpine
    container_name: eco-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: indestructibleeco
      POSTGRES_USER: indestructibleeco
      POSTGRES_PASSWORD: ${ECO_POSTGRES_PASSWORD:-eco_secret}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  redis-data:
  postgres-data: