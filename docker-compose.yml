# ╔══════════════════════════════════════════════════════════════════════════════╗
# ║  eco-base v1.0 — docker-compose.yml                               ║
# ║  Local Development Environment — Backend Services + Infrastructure          ║
# ║                                                                              ║
# ║  Usage:                                                                      ║
# ║    docker compose up -d                    # start all services              ║
# ║    docker compose up -d api ai             # start specific services         ║
# ║    docker compose logs -f api              # follow api logs                 ║
# ║    docker compose exec api sh              # shell into api container        ║
# ║    docker compose down -v                  # stop + delete volumes           ║
# ║                                                                              ║
# ║  Prerequisites: copy .env.local.example to .env.local and fill in values.   ║
# ╚══════════════════════════════════════════════════════════════════════════════╝

version: "3.9"

# ── Shared extension fields ──────────────────────────────────────────────────
x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"
    labels: "service,env"

x-restart: &default-restart
  restart: unless-stopped

x-healthcheck-defaults: &hc-defaults
  interval: 15s
  timeout: 5s
  retries: 5
  start_period: 20s

# ── Networks ─────────────────────────────────────────────────────────────────
networks:
  backend:
    driver: bridge
    name: eco_backend
  data:
    driver: bridge
    name: eco_data
  proxy:
    driver: bridge
    name: eco_proxy

# ── Volumes ───────────────────────────────────────────────────────────────────
volumes:
  postgres-data:
    name: eco_postgres_data
  redis-data:
    name: eco_redis_data
  api-node-modules:
    name: eco_api_node_modules
  ai-pip-cache:
    name: eco_ai_pip_cache
  nginx-logs:
    name: eco_nginx_logs

# ══════════════════════════════════════════════════════════════════════════════
# SERVICES
# ══════════════════════════════════════════════════════════════════════════════
services:

  # ── NGINX — Reverse Proxy / Dev Gateway ────────────────────────────────────
  nginx:
    image: nginx:1.27-alpine
    container_name: eco_nginx
    <<: *default-restart
    ports:
      - "${NGINX_HTTP_PORT:-8080}:80"
    volumes:
      - ./infra/nginx/nginx.dev.conf:/etc/nginx/nginx.conf:ro
      - ./infra/nginx/conf.d:/etc/nginx/conf.d:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      api:
        condition: service_healthy
    networks:
      - proxy
      - backend
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      <<: *hc-defaults
    logging: *default-logging
    labels:
      generated-by: yaml-toolkit-v8
      service: nginx
      env: development

  # ── PostgreSQL (Supabase-compatible) ─────────────────────────────────────
  postgres:
    image: supabase/postgres:15.1.1.78
    container_name: eco_postgres
    <<: *default-restart
    environment:
      POSTGRES_USER:     ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB:       ${POSTGRES_DB:-eco-base}
      # Supabase required vars
      POSTGRES_HOST:     /var/run/postgresql
      PGPORT:            5432
      PGPASSWORD:        ${POSTGRES_PASSWORD:-postgres}
      # Performance tuning for dev
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    command:
      - postgres
      - -c
      - wal_level=logical
      - -c
      - max_connections=100
      - -c
      - shared_buffers=256MB
      - -c
      - effective_cache_size=1GB
      - -c
      - work_mem=4MB
      - -c
      - maintenance_work_mem=64MB
      - -c
      - log_min_duration_statement=500
      - -c
      - "log_line_prefix=%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./supabase/migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-eco-base}"]
      <<: *hc-defaults
    logging: *default-logging
    labels:
      generated-by: yaml-toolkit-v8
      service: postgres
      env: development
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 256M

  # ── Redis ────────────────────────────────────────────────────────────────
  redis:
    image: redis:7.2-alpine
    container_name: eco_redis
    <<: *default-restart
    command:
      - redis-server
      - --appendonly yes
      - --appendfsync everysec
      - --maxmemory 256mb
      - --maxmemory-policy allkeys-lru
      - --loglevel notice
      - --tcp-keepalive 60
      - --requirepass ${REDIS_PASSWORD:-}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    networks:
      - data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      <<: *hc-defaults
    logging: *default-logging
    labels:
      generated-by: yaml-toolkit-v8
      service: redis
      env: development
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: "0.5"

  # ── Redis Commander — Redis GUI ───────────────────────────────────────────
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: eco_redis_commander
    <<: *default-restart
    environment:
      REDIS_HOSTS: "local:redis:6379:0:${REDIS_PASSWORD:-}"
      HTTP_USER:   ${REDIS_COMMANDER_USER:-admin}
      HTTP_PASSWORD: ${REDIS_COMMANDER_PASSWORD:-admin}
    ports:
      - "${REDIS_COMMANDER_PORT:-8081}:8081"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - data
      - proxy
    profiles:
      - tools
    logging: *default-logging
    labels:
      generated-by: yaml-toolkit-v8
      service: redis-commander
      env: development

  # ── Mailpit — Local SMTP / Email UI ──────────────────────────────────────
  mailpit:
    image: axllent/mailpit:v1.18
    container_name: eco_mailpit
    <<: *default-restart
    ports:
      - "${MAILPIT_SMTP_PORT:-1025}:1025"
      - "${MAILPIT_UI_PORT:-8025}:8025"
    networks:
      - backend
    logging: *default-logging
    labels:
      generated-by: yaml-toolkit-v8
      service: mailpit
      env: development

  # ── backend/api — Primary REST + WebSocket API ───────────────────────────
  api:
    build:
      context: ./backend/api
      dockerfile: Dockerfile
      target: builder                   # dev: use build stage with tsx watch
    container_name: eco_api
    <<: *default-restart
    environment:
      # Server
      PORT:           ${API_PORT:-3000}
      LOG_LEVEL:      ${LOG_LEVEL:-info}
      NODE_ENV:       development

      # Supabase / DB
      SUPABASE_URL:              ${SUPABASE_URL:-http://postgres:5432}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-local-service-role-key-placeholder}
      SUPABASE_ANON_KEY:         ${SUPABASE_ANON_KEY:-local-anon-key-placeholder}

      # Redis
      REDIS_URL:     redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379

      # CORS (web dev server + Electron dev)
      CORS_ORIGIN: >-
        http://localhost:5173,
        http://localhost:5174,
        http://localhost:3001,
        http://nginx:80

      # AI service (internal gRPC)
      AI_SERVICE_GRPC_URL: ai:8000
      AI_SERVICE_HTTP_URL: http://ai:8001

      # Email (Mailpit for dev)
      SMTP_HOST: mailpit
      SMTP_PORT: 1025
      SMTP_FROM: noreply@eco-base.local

      # OpenTelemetry
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
      OTEL_SERVICE_NAME:            api-service
      OTEL_RESOURCE_ATTRIBUTES:     deployment.environment=development

    ports:
      - "${API_PORT:-3000}:3000"
    volumes:
      # Hot reload — mount source, keep node_modules in named volume
      - ./backend/api/src:/app/src:delegated
      - ./packages:/app/packages:delegated
      - api-node-modules:/app/node_modules
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - backend
      - data
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:${API_PORT:-3000}/health || exit 1"]
      <<: *hc-defaults
    logging: *default-logging
    labels:
      generated-by: yaml-toolkit-v8
      service: api
      env: development
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
        reservations:
          memory: 128M

  # ── backend/ai — AI Generation + YAML Governance Service ─────────────────
  ai:
    build:
      context: ./backend/ai
      dockerfile: Dockerfile
    container_name: eco_ai
    <<: *default-restart
    environment:
      # Server
      PORT:       ${AI_HTTP_PORT:-8001}
      GRPC_PORT:  ${AI_GRPC_PORT:-8000}
      LOG_LEVEL:  ${LOG_LEVEL:-info}
      ENVIRONMENT: development

      # Redis / Celery
      REDIS_URL:             redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379
      CELERY_BROKER_URL:     redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/0
      CELERY_RESULT_BACKEND: redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/1

      # Model config
      MODEL_BASE_PATH:  /app/models
      DEFAULT_MODEL_ID: quantum-bert-xxl-v1
      VECTOR_DIM:       1024
      VECTOR_TOLERANCE: 0.001

      # YAML Toolkit
      YAML_SCHEMA_VERSION: v8
      YAML_GENERATOR_ID:   yaml-toolkit-v8

      # OpenTelemetry
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
      OTEL_SERVICE_NAME:            ai-service
      OTEL_RESOURCE_ATTRIBUTES:     deployment.environment=development

    ports:
      - "${AI_HTTP_PORT:-8001}:8001"
      - "${AI_GRPC_PORT:-8000}:8000"
    volumes:
      - ./backend/ai/src:/app/src:delegated
      - ai-pip-cache:/root/.cache/pip
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - backend
      - data
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:${AI_HTTP_PORT:-8001}/health || exit 1"]
      <<: *hc-defaults
      start_period: 40s     # Python startup is slower
    logging: *default-logging
    labels:
      generated-by: yaml-toolkit-v8
      service: ai
      env: development
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
        reservations:
          memory: 512M

  # ── Celery Worker — AI async job processor ────────────────────────────────
  celery-worker:
    build:
      context: ./backend/ai
      dockerfile: Dockerfile
    container_name: eco_celery_worker
    <<: *default-restart
    command: celery -A src.celery_app worker --loglevel=info --concurrency=2
    environment:
      REDIS_URL:             redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379
      CELERY_BROKER_URL:     redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/0
      CELERY_RESULT_BACKEND: redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/1
      MODEL_BASE_PATH:       /app/models
    volumes:
      - ./backend/ai/src:/app/src:delegated
    depends_on:
      redis:
        condition: service_healthy
      ai:
        condition: service_healthy
    networks:
      - backend
      - data
    healthcheck:
      test: ["CMD-SHELL", "celery -A src.celery_app inspect ping -d celery@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging: *default-logging
    labels:
      generated-by: yaml-toolkit-v8
      service: celery-worker
      env: development
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"

  # ── Flower — Celery monitoring UI ─────────────────────────────────────────
  flower:
    build:
      context: ./backend/ai
      dockerfile: Dockerfile
    container_name: eco_flower
    <<: *default-restart
    command: celery -A src.celery_app flower --port=5555
    environment:
      CELERY_BROKER_URL:     redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/0
      CELERY_RESULT_BACKEND: redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/1
      FLOWER_BASIC_AUTH:     ${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-admin}
    ports:
      - "${FLOWER_PORT:-5555}:5555"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - backend
      - proxy
    profiles:
      - tools
    logging: *default-logging
    labels:
      generated-by: yaml-toolkit-v8
      service: flower
      env: development
