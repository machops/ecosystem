version: "3.9"

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"
    labels: "service,env"

x-restart: &default-restart
  restart: unless-stopped

x-healthcheck-defaults: &hc-defaults
  interval: 15s
  timeout: 5s
  retries: 5
  start_period: 20s

networks:
  backend:
    driver: bridge
    name: eco_backend
  data:
    driver: bridge
    name: eco_data

volumes:
  postgres_data:
  redis_data:
  faiss_data:

services:
  postgres:
    image: postgres:16-alpine
    <<: *default-restart
    logging: *default-logging
    environment:
      POSTGRES_DB: indestructibleeco
      POSTGRES_USER: eco_admin
      POSTGRES_PASSWORD: ${ECO_DB_PASSWORD:-eco_dev_password}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/supabase/migrations:/docker-entrypoint-initdb.d:ro
    networks: [data]
    healthcheck:
      <<: *hc-defaults
      test: ["CMD-SHELL", "pg_isready -U eco_admin -d indestructibleeco"]

  redis:
    image: redis:7-alpine
    <<: *default-restart
    logging: *default-logging
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks: [data]
    healthcheck:
      <<: *hc-defaults
      test: ["CMD", "redis-cli", "ping"]

  ai:
    build:
      context: ./backend/ai
      dockerfile: Dockerfile
    <<: *default-restart
    logging: *default-logging
    environment:
      ECO_ENVIRONMENT: development
      ECO_AI_HTTP_PORT: "8001"
      ECO_AI_GRPC_PORT: "8000"
      ECO_LOG_LEVEL: debug
      ECO_REDIS_URL: redis://redis:6379
      ECO_CELERY_BROKER: redis://redis:6379/0
      ECO_CELERY_BACKEND: redis://redis:6379/1
      ECO_VECTOR_DIM: "1024"
      ECO_FAISS_ENABLED: "true"
      ECO_FAISS_PERSIST_DIR: /data/faiss
      ECO_ES_ENABLED: "false"
      ECO_NEO4J_ENABLED: "false"
    ports:
      - "8001:8001"
      - "8000:8000"
    volumes:
      - faiss_data:/data/faiss
    depends_on:
      redis:
        condition: service_healthy
    networks: [backend, data]
    healthcheck:
      <<: *hc-defaults
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]

  api:
    build:
      context: ./backend/api
      dockerfile: Dockerfile
    <<: *default-restart
    logging: *default-logging
    environment:
      ECO_ENVIRONMENT: development
      ECO_API_PORT: "3000"
      ECO_LOG_LEVEL: debug
      ECO_AI_SERVICE_URL: http://ai:8001
      ECO_REDIS_URL: redis://redis:6379
      ECO_SUPABASE_URL: http://postgres:5432
      ECO_JWT_SECRET: ${ECO_JWT_SECRET:-eco_dev_jwt_secret_change_me}
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      ai:
        condition: service_healthy
    networks: [backend, data]
    healthcheck:
      <<: *hc-defaults
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]

  web:
    build:
      context: ./platforms/web
      dockerfile: Dockerfile
    <<: *default-restart
    logging: *default-logging
    environment:
      VITE_API_URL: http://localhost:3000
      VITE_WS_URL: ws://localhost:3000
    ports:
      - "5173:5173"
    depends_on:
      api:
        condition: service_healthy
    networks: [backend]

  prometheus:
    image: prom/prometheus:v2.51.0
    <<: *default-restart
    logging: *default-logging
    volumes:
      - ./ecosystem/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./ecosystem/monitoring/alertmanager/alert-rules.yaml:/etc/prometheus/rules/alert-rules.yaml:ro
    ports:
      - "9090:9090"
    networks: [backend]
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=7d"

  grafana:
    image: grafana/grafana:10.4.0
    <<: *default-restart
    logging: *default-logging
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GF_ADMIN_PASSWORD:-eco_grafana}
      GF_INSTALL_PLUGINS: ""
    volumes:
      - ./ecosystem/monitoring/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "3001:3000"
    depends_on:
      - prometheus
    networks: [backend]
