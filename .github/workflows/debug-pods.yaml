name: Debug Pod Logs
on:
  workflow_dispatch:
env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GKE_REGION }}
  CLUSTER: ${{ vars.GKE_CLUSTER_STAGING }}
  NAMESPACE: ${{ vars.K8S_NAMESPACE_STAGING }}
jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Install gcloud
        run: |
          curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get update -y && sudo apt-get install -y google-cloud-cli google-cloud-cli-gke-gcloud-auth-plugin
          echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV
      - name: Auth GCP
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/key.json
          gcloud auth activate-service-account --key-file=/tmp/key.json
          gcloud config set project ${{ env.PROJECT_ID }}
          gcloud container clusters get-credentials ${{ env.CLUSTER }} --region ${{ env.REGION }} --project ${{ env.PROJECT_ID }}
          rm -f /tmp/key.json
      - name: Get pod logs
        run: |
          NS=${{ env.NAMESPACE }}
          echo "=== All Pods ==="
          kubectl get pods -n $NS -o wide
          echo ""
          echo "=== API Service Logs (previous) ==="
          kubectl logs -n $NS -l app.kubernetes.io/name=eco-api-service --tail=100 --previous 2>&1 || true
          echo "=== API Service Logs (current) ==="
          kubectl logs -n $NS -l app.kubernetes.io/name=eco-api-service --tail=100 2>&1 || true
          echo ""
          echo "=== Web Frontend Logs (previous) ==="
          kubectl logs -n $NS -l app.kubernetes.io/name=eco-web-frontend --tail=100 --previous 2>&1 || true
          echo "=== Web Frontend Logs (current) ==="
          kubectl logs -n $NS -l app.kubernetes.io/name=eco-web-frontend --tail=100 2>&1 || true
          echo ""
          echo "=== API Pod Events ==="
          kubectl describe pod -n $NS -l app.kubernetes.io/name=eco-api-service 2>&1 | tail -30
          echo ""
          echo "=== Web Pod Events ==="
          kubectl describe pod -n $NS -l app.kubernetes.io/name=eco-web-frontend 2>&1 | tail -30
