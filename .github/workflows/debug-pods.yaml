name: Debug Pod Logs

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GKE_REGION }}
  CLUSTER: ${{ vars.GKE_CLUSTER_STAGING }}
  NAMESPACE: ${{ vars.K8S_NAMESPACE_STAGING }}

jobs:
  debug:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Install gke-gcloud-auth-plugin
        run: |
          # Install gke-gcloud-auth-plugin via gcloud components
          # On GitHub Actions ubuntu-latest, gcloud is pre-installed
          gcloud components install gke-gcloud-auth-plugin --quiet
          echo "gke-gcloud-auth-plugin: $(gke-gcloud-auth-plugin --version 2>&1)"

      - name: Authenticate to GCP
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          USE_GKE_GCLOUD_AUTH_PLUGIN: "True"
        run: |
          TMP_DIR="$(mktemp -d)"
          chmod 700 "$TMP_DIR"
          KEY_FILE="$TMP_DIR/gcp-sa-key.json"
          echo "$GCP_SA_KEY" > "$KEY_FILE"
          chmod 600 "$KEY_FILE"
          gcloud auth activate-service-account --key-file="$KEY_FILE"
          gcloud config set project ${{ env.PROJECT_ID }}
          gcloud container clusters get-credentials ${{ env.CLUSTER }} --region ${{ env.REGION }} --project ${{ env.PROJECT_ID }}
          rm -rf "$TMP_DIR"

      - name: Get pod logs
        run: |
          NS=${{ env.NAMESPACE }}
          echo "=== All Pods ==="
          kubectl get pods -n $NS -o wide
          echo ""
          echo "=== API Service Logs (previous) ==="
          kubectl logs -n $NS -l app.kubernetes.io/name=eco-api-service --tail=100 --previous 2>&1 || true
          echo "=== API Service Logs (current) ==="
          kubectl logs -n $NS -l app.kubernetes.io/name=eco-api-service --tail=100 2>&1 || true
          echo ""
          echo "=== Web Frontend Logs (previous) ==="
          kubectl logs -n $NS -l app.kubernetes.io/name=eco-web-frontend --tail=100 --previous 2>&1 || true
          echo "=== Web Frontend Logs (current) ==="
          kubectl logs -n $NS -l app.kubernetes.io/name=eco-web-frontend --tail=100 2>&1 || true
          echo ""
          echo "=== API Pod Events ==="
          kubectl describe pod -n $NS -l app.kubernetes.io/name=eco-api-service 2>&1 | tail -30
          echo ""
          echo "=== Web Pod Events ==="
          kubectl describe pod -n $NS -l app.kubernetes.io/name=eco-web-frontend 2>&1 | tail -30
