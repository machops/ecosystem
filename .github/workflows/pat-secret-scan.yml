name: PAT Secret Scan

# Scans codebase for hardcoded GitHub PATs and other secrets.
# Runs on every PR, push to main, and daily schedule.
# Blocks merge if hardcoded PATs are detected.
#
# Detection patterns:
#   - Classic PAT:       ghp_[A-Za-z0-9]{36}
#   - Fine-grained PAT:  github_pat_[A-Za-z0-9_]{82}
#   - OAuth token:       gho_[A-Za-z0-9]{36}
#   - GitHub App token:  ghs_[A-Za-z0-9]{36}
#   - Refresh token:     ghr_[A-Za-z0-9]{36}
#
# Issue dedup: 7-day window, append comment on recurrence.

on:
  push:
    branches: [main, develop, 'release/**', 'hotfix/**']
  pull_request:
    branches: [main, develop]
  schedule:
    # Daily at 06:30 UTC
    - cron: '30 6 * * *'
  workflow_dispatch:
    inputs:
      scan_depth:
        description: 'Number of commits to scan (0 = full history)'
        required: false
        default: '0'

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: write

jobs:
  # ── Job 1: Pattern-based scan (fast, no external tools) ─────────────────────
  pattern-scan:
    name: Pattern-Based PAT Detection
    runs-on: ubuntu-latest
    outputs:
      findings: ${{ steps.scan.outputs.findings }}
      finding_count: ${{ steps.scan.outputs.finding_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: ${{ github.event.inputs.scan_depth == '0' && 0 || github.event.inputs.scan_depth || 0 }}

      - name: Scan for hardcoded PATs
        id: scan
        run: |
          set +e  # Don't exit on grep no-match

          REPORT_FILE="/tmp/pat-scan-report.json"
          FINDINGS_FILE="/tmp/pat-findings.txt"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Define patterns (token_type:regex)
          declare -A PATTERNS=(
            ["classic_pat"]="ghp_[A-Za-z0-9]{36}"
            ["fine_grained_pat"]="github_pat_[A-Za-z0-9_]{82}"
            ["oauth_token"]="gho_[A-Za-z0-9]{36}"
            ["github_app_token"]="ghs_[A-Za-z0-9]{36}"
            ["refresh_token"]="ghr_[A-Za-z0-9]{36}"
          )

          # Exclusion patterns (known false positives)
          EXCLUDE_PATTERNS=(
            "\.git/"
            "node_modules/"
            "vendor/"
            "\.png$"
            "\.jpg$"
            "\.jpeg$"
            "\.gif$"
            "\.ico$"
            "\.woff"
            "\.ttf$"
            "\.eot$"
            "\.pdf$"
            "\.zip$"
            "\.tar"
            "\.lock$"
            "package-lock\.json"
            "pnpm-lock\.yaml"
            "yarn\.lock"
            # Allowlist: test fixtures with fake tokens
            "tests/fixtures/"
            "\.example$"
            "\.sample$"
            "EXAMPLE_TOKEN"
            "YOUR_TOKEN_HERE"
            "REPLACE_ME"
            "ghp_XXXX"
            "github_pat_XXXX"
          )

          # Build grep exclude args
          EXCLUDE_ARGS=""
          for pat in "${EXCLUDE_PATTERNS[@]}"; do
            EXCLUDE_ARGS="$EXCLUDE_ARGS --exclude-dir=$(echo $pat | tr -d '/')"
          done

          echo "[]" > "$FINDINGS_FILE"
          TOTAL_FINDINGS=0
          FINDINGS_JSON="[]"

          for token_type in "${!PATTERNS[@]}"; do
            PATTERN="${PATTERNS[$token_type]}"

            # Scan working tree
            MATCHES=$(grep -rn --include="*.ts" --include="*.tsx" --include="*.js" \
              --include="*.jsx" --include="*.py" --include="*.sh" --include="*.bash" \
              --include="*.yaml" --include="*.yml" --include="*.json" --include="*.env" \
              --include="*.env.*" --include="*.conf" --include="*.config" \
              --include="*.toml" --include="*.tf" --include="*.tfvars" \
              --include="*.md" --include="*.txt" --include="*.properties" \
              -E "$PATTERN" . 2>/dev/null \
              | grep -v "\.git/" \
              | grep -v "node_modules/" \
              | grep -v "vendor/" \
              | grep -v "EXAMPLE_TOKEN\|YOUR_TOKEN\|REPLACE_ME\|_XXXX\|ghp_XXXX\|github_pat_XXXX" \
              || true)

            if [[ -n "$MATCHES" ]]; then
              COUNT=$(echo "$MATCHES" | wc -l | tr -d ' ')
              TOTAL_FINDINGS=$((TOTAL_FINDINGS + COUNT))

              # Mask token values in output (show only prefix)
              MASKED=$(echo "$MATCHES" | sed -E \
                -e 's/(ghp_)[A-Za-z0-9]{36}/\1[MASKED]/g' \
                -e 's/(github_pat_)[A-Za-z0-9_]{82}/\1[MASKED]/g' \
                -e 's/(gho_)[A-Za-z0-9]{36}/\1[MASKED]/g' \
                -e 's/(ghs_)[A-Za-z0-9]{36}/\1[MASKED]/g' \
                -e 's/(ghr_)[A-Za-z0-9]{36}/\1[MASKED]/g')

              echo "::error::Found $COUNT hardcoded $token_type token(s)"
              echo "$MASKED" | while IFS= read -r line; do
                FILE=$(echo "$line" | cut -d: -f1)
                LINENO=$(echo "$line" | cut -d: -f2)
                echo "::error file=$FILE,line=$LINENO::Hardcoded $token_type detected"
              done

              # Append to findings JSON
              FINDINGS_JSON=$(echo "$FINDINGS_JSON" | python3 -c "
          import sys, json
          findings = json.load(sys.stdin)
          matches = '''$MASKED'''.strip().split('\n')
          for m in matches:
              if ':' in m:
                  parts = m.split(':', 2)
                  findings.append({
                      'token_type': '$token_type',
                      'file': parts[0],
                      'line': parts[1] if len(parts) > 1 else '?',
                      'context': parts[2][:80] if len(parts) > 2 else ''
                  })
          print(json.dumps(findings))
          ")
            fi
          done

          # Also scan git log for secrets in commit messages/diffs (last 50 commits)
          echo "--- Scanning git history (last 50 commits) ---"
          GIT_FINDINGS=$(git log --oneline -50 --all 2>/dev/null | \
            grep -E "ghp_[A-Za-z0-9]{36}|github_pat_[A-Za-z0-9_]{82}|gho_[A-Za-z0-9]{36}" \
            | grep -v "XXXX\|EXAMPLE\|REPLACE_ME" || true)

          if [[ -n "$GIT_FINDINGS" ]]; then
            GIT_COUNT=$(echo "$GIT_FINDINGS" | wc -l | tr -d ' ')
            TOTAL_FINDINGS=$((TOTAL_FINDINGS + GIT_COUNT))
            echo "::warning::Found $GIT_COUNT PAT reference(s) in git history (commit messages)"
          fi

          # Write report
          python3 - << PYEOF
          import json
          from datetime import datetime, timezone

          report = {
              "timestamp": "$TIMESTAMP",
              "repo": "${{ github.repository }}",
              "ref": "${{ github.ref }}",
              "sha": "${{ github.sha }}"[:8],
              "trigger": "${{ github.event_name }}",
              "total_findings": $TOTAL_FINDINGS,
              "status": "FAIL" if $TOTAL_FINDINGS > 0 else "PASS",
              "findings": $FINDINGS_JSON,
              "git_history_findings": $GIT_COUNT if "$GIT_FINDINGS" else 0,
          }
          with open("$REPORT_FILE", "w") as f:
              json.dump(report, f, indent=2)
          print(json.dumps(report, indent=2))
          PYEOF

          echo "finding_count=$TOTAL_FINDINGS" >> $GITHUB_OUTPUT
          echo "findings=$(cat $REPORT_FILE | python3 -c "import sys,json; d=json.load(sys.stdin); print(json.dumps(d['findings']))")" >> $GITHUB_OUTPUT

          if [[ $TOTAL_FINDINGS -gt 0 ]]; then
            echo "::error::PAT Secret Scan FAILED: $TOTAL_FINDINGS hardcoded token(s) detected."
            echo "Remove all hardcoded tokens and use GitHub Secrets instead."
            echo "See docs/pat-security-guide.md for storage policy."
            exit 1
          else
            echo "::notice::PAT Secret Scan PASSED: No hardcoded tokens detected."
          fi

      - name: Upload scan report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: pat-scan-report-${{ github.run_id }}
          path: /tmp/pat-scan-report.json
          retention-days: 90

  # ── Job 2: Gitleaks deep scan (git history) ────────────────────────────────
  trufflehog-scan:
    name: Gitleaks Deep Scan
    runs-on: ubuntu-latest
    outputs:
      findings: ${{ steps.gitleaks.outputs.report }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Check Gitleaks result
        if: steps.gitleaks.outcome == 'failure'
        run: |
          echo "::error::Gitleaks detected secrets in git history."
          echo "Run: gitleaks detect --source . to reproduce locally."

  # ── Job 3: Create GitHub Issue on findings ───────────────────────────────────
  report-findings:
    name: Report Findings
    runs-on: ubuntu-latest
    needs: [pattern-scan, trufflehog-scan]
    if: always() && (needs.pattern-scan.outputs.finding_count != '0' || needs.trufflehog-scan.outputs.findings != '')

    steps:
      - name: Create or update GitHub Issue (deduped, 7-day window)
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        env:
          FINDING_COUNT: ${{ needs.pattern-scan.outputs.finding_count }}
          FINDINGS_JSON: ${{ needs.pattern-scan.outputs.findings }}
          GITLEAKS_STATUS: ${{ needs.trufflehog-scan.result }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SHA: ${{ github.sha }}
          REF: ${{ github.ref }}
        with:
          script: |
            const findingCount = parseInt(process.env.FINDING_COUNT || '0');
            const truffleStatus = process.env.GITLEAKS_STATUS;
            const runUrl = process.env.RUN_URL;
            const sha = process.env.SHA.substring(0, 8);
            const ref = process.env.REF;
            const now = new Date().toISOString();

            const title = `[SECRET SCAN] Hardcoded PAT detected in ${ref} (${sha})`;

            const body = `## Secret Scan Alert — FAIL

            **Repository:** \`${{ github.repository }}\`
            **Ref:** \`${ref}\`
            **Commit:** \`${sha}\`
            **Detected At:** ${now}
            **Pattern Scan Findings:** ${findingCount}
            **Gitleaks Status:** ${truffleStatus}
            **Workflow Run:** [View Details](${runUrl})

            ## Required Actions

            1. **Immediately revoke** any exposed tokens at:
               - Classic PATs: [github.com/settings/tokens](https://github.com/settings/tokens)
               - Fine-grained PATs: [github.com/settings/personal-access-tokens](https://github.com/settings/personal-access-tokens)

            2. **Remove hardcoded tokens** from source code:
               \`\`\`bash
               # Find all occurrences
               grep -rn "ghp_\\|github_pat_\\|gho_\\|ghs_" . --include="*.ts" --include="*.py" --include="*.sh" --include="*.yml"
               \`\`\`

            3. **Replace with GitHub Secrets:**
               \`\`\`yaml
               env:
                 MY_TOKEN: \${{ secrets.PAT_TOKEN }}
               \`\`\`

            4. **Purge from git history** (if committed):
               \`\`\`bash
               git filter-repo --path <file> --invert-paths
               # OR use BFG Repo Cleaner
               \`\`\`

            5. **Run rotation script:**
               \`\`\`bash
               ./scripts/pat-rotate.sh --token <active_token> --new-token <new_token> --expiry YYYY-MM-DD
               \`\`\`

            > See [docs/pat-security-guide.md](../blob/main/docs/pat-security-guide.md) for full remediation procedure.

            ---
            *This issue was created automatically by the PAT Secret Scan workflow.*`;

            // Dedup: search for open issue within 7 days
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'secret-scan',
              since: sevenDaysAgo,
              per_page: 10,
            });

            const match = existing.data.find(i => i.title.includes('[SECRET SCAN]'));

            if (match) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: match.number,
                body: `### Follow-up Detection — ${now}\n\n**Commit:** \`${sha}\` | **Findings:** ${findingCount} | **Run:** [${runUrl}](${runUrl})`,
              });
              console.log(`Appended to existing issue #${match.number}`);
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['secret-scan', 'security', 'priority:critical'],
              });
              console.log('Created new secret scan issue');
            }

      - name: PR comment on findings
        if: github.event_name == 'pull_request'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        env:
          FINDING_COUNT: ${{ needs.pattern-scan.outputs.finding_count }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const findingCount = parseInt(process.env.FINDING_COUNT || '0');
            const runUrl = process.env.RUN_URL;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ❌ PAT Secret Scan FAILED

              **${findingCount} hardcoded token(s) detected** in this PR.

              This PR **cannot be merged** until all hardcoded tokens are removed.

              **Immediate actions:**
              1. Remove hardcoded tokens from source code
              2. Revoke any exposed tokens immediately
              3. Use \`\${{ secrets.PAT_TOKEN }}\` instead

              [View scan details](${runUrl}) | [Remediation guide](../blob/main/docs/pat-security-guide.md)`,
            });
