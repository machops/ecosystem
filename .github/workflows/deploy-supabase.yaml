name: Deploy Supabase Edge Function

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/functions/**'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Setup Node.js
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs

      - name: Install Node.js 20
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          node --version
          npm --version
      - name: Install Supabase CLI
        run: |
          npm install -g supabase
          supabase --version

      - name: Deploy hello-world function
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          chmod +x scripts/deploy-supabase-function.sh
          ./scripts/deploy-supabase-function.sh

      - name: Verify deployment
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: |
          FUNCTION_URL="https://${SUPABASE_PROJECT_REF}.supabase.co/functions/v1/hello-world"
          curl -X POST "$FUNCTION_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -d '{"name": "CITest"}' \
            --fail --silent --show-error

      - name: Notify on failure
        if: failure()
        run: |
          echo "Supabase function deployment failed"
          exit 1
