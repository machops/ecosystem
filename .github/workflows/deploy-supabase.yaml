name: Deploy Supabase Edge Functions
# Deploys Supabase Edge Functions on push to main.
# Requires: SUPABASE_SERVICE_ROLE_KEY (as access token), SUPABASE_URL secrets
on:
  push:
    branches: [main]
    paths:
      - "supabase/functions/**"
      - ".github/workflows/deploy-supabase.yaml"
  workflow_dispatch:
permissions:
  contents: read
  id-token: write
concurrency:
  group: deploy-supabase-${{ github.ref }}
  cancel-in-progress: true
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Install Supabase CLI
        run: |
          curl -fsSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/supabase
          supabase --version

      - name: Extract project ref from URL
        id: supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        run: |
          PROJECT_REF=$(echo "$SUPABASE_URL" | sed 's|https://||' | cut -d'.' -f1)
          echo "project_ref=$PROJECT_REF" >> "$GITHUB_OUTPUT"
          echo "Project ref: $PROJECT_REF"

      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          if [ -d supabase/functions ]; then
            for fn in supabase/functions/*/; do
              fn_name=$(basename "$fn")
              echo "Deploying function: $fn_name"
              supabase functions deploy "$fn_name" \
                --project-ref "${{ steps.supabase.outputs.project_ref }}" \
                || echo "WARN: $fn_name deploy failed"
            done
          else
            echo "No Supabase functions directory found -- skipping"
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "Supabase function deployment failed"
          exit 1
