name: Deploy to GKE eco-staging

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "platforms/web/**"
      - "src/**"
      - "k8s/staging/**"
      - "docker/**"
  workflow_dispatch:

concurrency:
  group: deploy-gke-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT: my-project-ops-1991
  GKE_CLUSTER: eco-staging
  GKE_ZONE: asia-east1
  GAR_LOCATION: asia-east1
  GAR_REPOSITORY: eco-images
  REGISTRY: asia-east1-docker.pkg.dev/my-project-ops-1991/eco-images

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tag }}
    steps:
      - name: Checkout
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Set image tag
        id: meta
        run: |
          TAG="${{ github.sha }}"
          echo "tag=${TAG:0:7}" >> "$GITHUB_OUTPUT"

      - name: Authenticate to Google Cloud
        run: |
          echo '${{ secrets.KUBE_CONFIG_STAGING }}' | base64 -d > /tmp/gcloud-key.json
          gcloud auth activate-service-account --key-file=/tmp/gcloud-key.json
          gcloud config set project ${{ env.GCP_PROJECT }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet

      - name: Build and push eco-gateway
        run: |
          docker build             -t ${{ env.REGISTRY }}/eco-gateway:${{ steps.meta.outputs.tag }}             -t ${{ env.REGISTRY }}/eco-gateway:latest             -f docker/Dockerfile .
          docker push ${{ env.REGISTRY }}/eco-gateway:${{ steps.meta.outputs.tag }}
          docker push ${{ env.REGISTRY }}/eco-gateway:latest

      - name: Build and push eco-ai
        run: |
          docker build             -t ${{ env.REGISTRY }}/eco-ai:${{ steps.meta.outputs.tag }}             -t ${{ env.REGISTRY }}/eco-ai:latest             -f backend/ai/Dockerfile backend/ai/
          docker push ${{ env.REGISTRY }}/eco-ai:${{ steps.meta.outputs.tag }}
          docker push ${{ env.REGISTRY }}/eco-ai:latest

      - name: Build and push eco-api
        run: |
          docker build             -t ${{ env.REGISTRY }}/eco-api:${{ steps.meta.outputs.tag }}             -t ${{ env.REGISTRY }}/eco-api:latest             backend/api/
          docker push ${{ env.REGISTRY }}/eco-api:${{ steps.meta.outputs.tag }}
          docker push ${{ env.REGISTRY }}/eco-api:latest

      - name: Build and push eco-web
        run: |
          docker build             -t ${{ env.REGISTRY }}/eco-web:${{ steps.meta.outputs.tag }}             -t ${{ env.REGISTRY }}/eco-web:latest             platforms/web/
          docker push ${{ env.REGISTRY }}/eco-web:${{ steps.meta.outputs.tag }}
          docker push ${{ env.REGISTRY }}/eco-web:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Authenticate to GKE
        run: |
          echo '${{ secrets.KUBE_CONFIG_STAGING }}' | base64 -d > /tmp/gcloud-key.json
          gcloud auth activate-service-account --key-file=/tmp/gcloud-key.json
          gcloud config set project ${{ env.GCP_PROJECT }}
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} --zone ${{ env.GKE_ZONE }}

      - name: Convert .qyaml to .yaml
        run: |
          node tools/yaml-toolkit/bin/cli.js convert k8s/staging/ --output /tmp/k8s-staging/ 2>/dev/null ||           (mkdir -p /tmp/k8s-staging && for f in k8s/staging/*.qyaml; do cp "$f" "/tmp/k8s-staging/$(basename "${f%.qyaml}.yaml")"; done)

      - name: Apply manifests
        run: |
          kubectl apply -f /tmp/k8s-staging/namespace.yaml
          kubectl apply -f /tmp/k8s-staging/ --namespace=eco-staging
          echo "Manifests applied"

      - name: Update image tags
        run: |
          TAG="${{ needs.build-and-push.outputs.image_tag }}"
          kubectl set image deployment/eco-api-gateway eco-gateway=${{ env.REGISTRY }}/eco-gateway:${TAG} -n eco-staging || true
          kubectl set image deployment/eco-ai-service eco-ai=${{ env.REGISTRY }}/eco-ai:${TAG} -n eco-staging || true
          kubectl set image deployment/eco-api-service eco-api=${{ env.REGISTRY }}/eco-api:${TAG} -n eco-staging || true
          kubectl set image deployment/eco-web-frontend eco-web=${{ env.REGISTRY }}/eco-web:${TAG} -n eco-staging || true

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/eco-api-gateway -n eco-staging --timeout=300s || true
          kubectl rollout status deployment/eco-ai-service -n eco-staging --timeout=300s || true
          kubectl rollout status deployment/eco-api-service -n eco-staging --timeout=300s || true
          kubectl rollout status deployment/eco-web-frontend -n eco-staging --timeout=120s || true

      - name: Verify deployment
        run: |
          echo "=== Pods ==="
          kubectl get pods -n eco-staging -o wide
          echo "=== Services ==="
          kubectl get svc -n eco-staging
          echo "=== Ingress ==="
          kubectl get ingress -n eco-staging
