name: Deploy to GKE eco-staging

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "platforms/web/**"
      - "k8s/staging/**"
      - "docker/**"
      - "src/**"
  workflow_dispatch:

concurrency:
  group: deploy-gke-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: my-project-ops-1991
  REGION: asia-east1
  CLUSTER: eco-staging
  NAMESPACE: eco-staging
  REGISTRY: asia-east1-docker.pkg.dev/my-project-ops-1991/eco-images

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Install gcloud CLI and auth plugin
        run: |
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          sudo apt-get update -y && sudo apt-get install -y google-cloud-cli google-cloud-cli-gke-gcloud-auth-plugin
          echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

      - name: Authenticate to Google Cloud
        run: |
          echo '${{ secrets.KUBE_CONFIG_STAGING }}' | base64 -d > /tmp/kubeconfig.yaml
          export KUBECONFIG=/tmp/kubeconfig.yaml
          gcloud auth login --cred-file=/tmp/kubeconfig.yaml 2>/dev/null || true
          gcloud config set project ${{ env.PROJECT_ID }} 2>/dev/null || true
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet 2>/dev/null || true

      - name: Build and push Gateway image
        run: |
          docker build -t ${{ env.REGISTRY }}/gateway:${{ github.sha }} \
                        -t ${{ env.REGISTRY }}/gateway:latest \
                        -f docker/Dockerfile .
          docker push ${{ env.REGISTRY }}/gateway:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/gateway:latest

      - name: Build and push AI image
        run: |
          docker build -t ${{ env.REGISTRY }}/ai:${{ github.sha }} \
                        -t ${{ env.REGISTRY }}/ai:latest \
                        backend/ai/
          docker push ${{ env.REGISTRY }}/ai:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/ai:latest

      - name: Build and push API image
        run: |
          docker build -t ${{ env.REGISTRY }}/api:${{ github.sha }} \
                        -t ${{ env.REGISTRY }}/api:latest \
                        backend/api/
          docker push ${{ env.REGISTRY }}/api:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/api:latest

      - name: Build and push Web image
        run: |
          docker build -t ${{ env.REGISTRY }}/web:${{ github.sha }} \
                        -t ${{ env.REGISTRY }}/web:latest \
                        platforms/web/
          docker push ${{ env.REGISTRY }}/web:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/web:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Install gcloud CLI and auth plugin
        run: |
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          sudo apt-get update -y && sudo apt-get install -y google-cloud-cli google-cloud-cli-gke-gcloud-auth-plugin
          echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

      - name: Configure kubectl
        run: |
          echo '${{ secrets.KUBE_CONFIG_STAGING }}' | base64 -d > /tmp/kubeconfig.yaml
          echo "KUBECONFIG=/tmp/kubeconfig.yaml" >> $GITHUB_ENV

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get namespaces

      - name: Convert .qyaml to .yaml and apply
        run: |
          mkdir -p /tmp/k8s-staging
          for f in k8s/staging/*.qyaml; do
            cp "$f" "/tmp/k8s-staging/$(basename "${f%.qyaml}.yaml")"
          done

          echo "Applying namespace..."
          kubectl apply -f /tmp/k8s-staging/namespace.yaml || true

          echo "Applying all manifests..."
          for f in namespace configmap postgres redis ai-service api-service api-gateway web-frontend ingress; do
            yaml="/tmp/k8s-staging/${f}.yaml"
            if [ -f "$yaml" ]; then
              echo "  Applying ${f}..."
              kubectl apply -f "$yaml" -n ${{ env.NAMESPACE }} || true
            fi
          done

      - name: Update image tags
        run: |
          kubectl set image deployment/eco-api-gateway eco-api-gateway=${{ env.REGISTRY }}/gateway:${{ github.sha }} -n ${{ env.NAMESPACE }} || true
          kubectl set image deployment/eco-ai-service eco-ai-service=${{ env.REGISTRY }}/ai:${{ github.sha }} -n ${{ env.NAMESPACE }} || true
          kubectl set image deployment/eco-api-service eco-api-service=${{ env.REGISTRY }}/api:${{ github.sha }} -n ${{ env.NAMESPACE }} || true
          kubectl set image deployment/eco-web-frontend eco-web-frontend=${{ env.REGISTRY }}/web:${{ github.sha }} -n ${{ env.NAMESPACE }} || true

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/eco-api-gateway -n ${{ env.NAMESPACE }} --timeout=300s || true
          kubectl rollout status deployment/eco-ai-service -n ${{ env.NAMESPACE }} --timeout=300s || true
          kubectl rollout status deployment/eco-api-service -n ${{ env.NAMESPACE }} --timeout=300s || true
          kubectl rollout status deployment/eco-web-frontend -n ${{ env.NAMESPACE }} --timeout=300s || true

      - name: Verify deployment
        run: |
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }}
          echo "=== Services ==="
          kubectl get svc -n ${{ env.NAMESPACE }}
          echo "=== Ingress ==="
          kubectl get ingress -n ${{ env.NAMESPACE }}