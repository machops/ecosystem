name: Deploy to GKE

on:
  push:
    branches: [main]
    paths:
      - 'k8s/**'
      - 'helm/**'
      - 'docker/**'
      - 'backend/**'
      - 'src/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options: ['staging', 'production']
      deploy_method:
        description: 'Deployment method'
        required: true
        default: 'helm'
        type: choice
        options: ['helm', 'argocd-sync', 'kubectl']

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID || 'my-project-ops-1991' }}
  GKE_REGION: ${{ vars.GKE_REGION || 'asia-east1' }}
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}

jobs:
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3

      - name: Login to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@902fa8ec7d6ecbf8d84d538b9b233a880e428804 # v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/eco-api-gateway
          tags: |
            type=sha,prefix=
            type=ref,event=branch

      - name: Build and push API Gateway
        uses: docker/build-push-action@14487ce63c7a62a4a324b0bfb37086795e31c6c1 # v6
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-staging:
    name: Deploy to Staging
    needs: build-images
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Authenticate to GCP
        uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@64bc7249bbcf78056bb92f14d3cedc2da193946c # v2
        with:
          cluster_name: eco-staging
          location: ${{ env.GKE_REGION }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Deploy with Helm
        run: |
          helm upgrade --install eco-base-staging ./helm \
            --namespace eco-staging \
            --create-namespace \
            --values helm/values-staging.yaml \
            --set image.tag="${{ needs.build-images.outputs.image_tag }}" \
            --set secrets.postgresPassword="${{ secrets.POSTGRES_PASSWORD }}" \
            --set secrets.jwtSecret="${{ secrets.JWT_SECRET }}" \
            --wait \
            --timeout 10m

      - name: Verify deployment
        run: |
          kubectl -n eco-staging rollout status deployment/eco-base-platform --timeout=5m
          kubectl -n eco-staging get pods

  deploy-production:
    name: Deploy to Production
    needs: [build-images, deploy-staging]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Authenticate to GCP
        uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@64bc7249bbcf78056bb92f14d3cedc2da193946c # v2
        with:
          cluster_name: eco-production
          location: ${{ env.GKE_REGION }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Deploy with Helm
        run: |
          helm upgrade --install eco-base ./helm \
            --namespace eco-production \
            --create-namespace \
            --values helm/values.yaml \
            --set image.tag="${{ needs.build-images.outputs.image_tag }}" \
            --set secrets.postgresPassword="${{ secrets.POSTGRES_PASSWORD }}" \
            --set secrets.jwtSecret="${{ secrets.JWT_SECRET }}" \
            --set secrets.hfToken="${{ secrets.HF_TOKEN }}" \
            --wait \
            --timeout 15m

      - name: Verify deployment
        run: |
          kubectl -n eco-production rollout status deployment/eco-base-platform --timeout=10m
          kubectl -n eco-production get pods
          echo "Production deployment complete!"
