name: deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      caps_json_path: artifacts/_tmp/capabilities.enabled.json
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: |
          mkdir -p artifacts/_tmp
          python scripts/capabilities.py capabilities.yaml > artifacts/_tmp/capabilities.enabled.json

  preflight:
    runs-on: ubuntu-latest
    needs: [detect]
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: Generate enabled capabilities JSON
        run: |
          mkdir -p artifacts/_tmp
          python scripts/capabilities.py capabilities.yaml > artifacts/_tmp/capabilities.enabled.json

      - name: Preflight secrets gate (fail fast)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

          KEYCLOAK_ADMIN_URL: ${{ secrets.KEYCLOAK_ADMIN_URL }}
          KEYCLOAK_ADMIN_CLIENT_ID: ${{ secrets.KEYCLOAK_ADMIN_CLIENT_ID }}
          KEYCLOAK_ADMIN_CLIENT_SECRET: ${{ secrets.KEYCLOAK_ADMIN_CLIENT_SECRET }}

          N8N_BASE_URL: ${{ secrets.N8N_BASE_URL }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          bash scripts/preflight_secrets.sh artifacts/_tmp/capabilities.enabled.json secrets.required.yaml

  deploy_vercel:
    runs-on: ubuntu-latest
    needs: [preflight]
    environment: production
    if: ${{ contains(fromJSON('["true"]'), 'true') }} # placeholder; actual gating in-step via capabilities
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: corepack enable
      - run: pnpm -w install --frozen-lockfile
      - name: Deploy Vercel (only if enabled)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          mkdir -p artifacts/_tmp
          python scripts/capabilities.py capabilities.yaml > artifacts/_tmp/capabilities.enabled.json
          VERGATE=$(python - <<'PY'
import json
with open("artifacts/_tmp/capabilities.enabled.json") as f:
    d = json.load(f)
print("enabled" if "vercel" in d else "disabled")
PY
          )
          if [ "$VERGATE" != "enabled" ]; then
            echo "vercel capability disabled; skipping Vercel deploy"
            exit 0
          fi
          pnpm -w --filter ./apps/web deploy:vercel

  deploy_cloudflare:
    runs-on: ubuntu-latest
    needs: [preflight]
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: corepack enable
      - run: pnpm -w install --frozen-lockfile
      - name: Deploy Cloudflare (only if enabled)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          mkdir -p artifacts/_tmp
          python scripts/capabilities.py capabilities.yaml > artifacts/_tmp/capabilities.enabled.json
          python - <<'PY'
import json
d=json.load(open("artifacts/_tmp/capabilities.enabled.json"))
assert ("cloudflare" in d), "cloudflare disabled"
print("cloudflare enabled")
PY
          pnpm -w --filter ./apps/edge deploy:cloudflare

  deploy_supabase:
    runs-on: ubuntu-latest
    needs: [preflight]
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: Supabase migrate (only if enabled)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          mkdir -p artifacts/_tmp
          python scripts/capabilities.py capabilities.yaml > artifacts/_tmp/capabilities.enabled.json
          python - <<'PY'
import json
d=json.load(open("artifacts/_tmp/capabilities.enabled.json"))
assert ("supabase" in d), "supabase disabled"
print("supabase enabled")
PY
          bash supabase/scripts/migrate.sh

  sync_keycloak:
    runs-on: ubuntu-latest
    needs: [preflight]
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: Keycloak sync (only if enabled)
        env:
          KEYCLOAK_ADMIN_URL: ${{ secrets.KEYCLOAK_ADMIN_URL }}
          KEYCLOAK_ADMIN_CLIENT_ID: ${{ secrets.KEYCLOAK_ADMIN_CLIENT_ID }}
          KEYCLOAK_ADMIN_CLIENT_SECRET: ${{ secrets.KEYCLOAK_ADMIN_CLIENT_SECRET }}
        run: |
          mkdir -p artifacts/_tmp
          python scripts/capabilities.py capabilities.yaml > artifacts/_tmp/capabilities.enabled.json
          python - <<'PY'
import json
d=json.load(open("artifacts/_tmp/capabilities.enabled.json"))
assert ("keycloak" in d), "keycloak disabled"
print("keycloak enabled")
PY
          bash ops/keycloak/scripts/sync.sh

  sync_n8n:
    runs-on: ubuntu-latest
    needs: [preflight]
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: n8n sync (only if enabled)
        env:
          N8N_BASE_URL: ${{ secrets.N8N_BASE_URL }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          mkdir -p artifacts/_tmp
          python scripts/capabilities.py capabilities.yaml > artifacts/_tmp/capabilities.enabled.json
          python - <<'PY'
import json
d=json.load(open("artifacts/_tmp/capabilities.enabled.json"))
assert ("n8n" in d), "n8n disabled"
print("n8n enabled")
PY
          bash ops/n8n/scripts/sync.sh
