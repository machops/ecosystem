name: Security Scan & Dependency Audit

on:
  schedule:
    # Run every Monday and Thursday at 08:00 UTC
    - cron: '0 8 * * 1,4'
  push:
    branches: [main]
    paths:
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

concurrency:
  group: security-scan
  cancel-in-progress: true

jobs:
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

    - name: Setup Node.js
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
      with:
        node-version: '20'

    - name: Install pnpm
      run: npm install -g pnpm@9

    - name: Node.js dependency audit
      id: node_audit
      run: |
        echo "=== Node.js Dependency Audit ==="
        if [ -f "package.json" ]; then
          pnpm install --frozen-lockfile 2>/dev/null || pnpm install 2>/dev/null || true
          pnpm audit --audit-level=high 2>&1 | tee /tmp/node-audit.txt || true
          HIGH_VULNS=$(grep -c "high\|critical" /tmp/node-audit.txt 2>/dev/null || true)
          HIGH_VULNS=${HIGH_VULNS:-0}
          echo "high_vulns=$HIGH_VULNS" >> "$GITHUB_OUTPUT"
          echo "Node.js high/critical vulnerabilities: $HIGH_VULNS"
        else
          echo "No package.json found"
          echo "high_vulns=0" >> "$GITHUB_OUTPUT"
        fi

    - name: Python dependency audit
      id: python_audit
      run: |
        echo "=== Python Dependency Audit ==="
        pip3 install pip-audit 2>/dev/null || true
        if [ -f "pyproject.toml" ] || [ -f "requirements.txt" ]; then
          pip-audit --format=json -o /tmp/python-audit.json 2>/dev/null || true
          if [ -f /tmp/python-audit.json ]; then
            VULNS=$(python3 tools/ci-helpers/count_vulns.py /tmp/python-audit.json 2>/dev/null || echo '0')
            echo "python_vulns=$VULNS" >> "$GITHUB_OUTPUT"
            echo "Python vulnerabilities with fixes: $VULNS"
          else
            echo "python_vulns=0" >> "$GITHUB_OUTPUT"
          fi
        else
          echo "No Python dependency files found"
          echo "python_vulns=0" >> "$GITHUB_OUTPUT"
        fi

    - name: Workflow permissions audit
      id: workflow_audit
      run: |
        echo "=== Workflow Permissions Audit ==="
        python3 - << 'PYEOF'
        import os, yaml, glob

        issues = []
        for wf_file in glob.glob(".github/workflows/*.yaml") + glob.glob(".github/workflows/*.yml"):
            try:
                with open(wf_file) as f:
                    wf = yaml.safe_load(f)
                if not wf:
                    continue

                # Check for overly broad permissions
                perms = wf.get("permissions", {})
                if perms == "write-all":
                    issues.append(f"{wf_file}: uses 'write-all' permissions (overly broad)")
                elif isinstance(perms, dict):
                    for perm, level in perms.items():
                        if level == "write" and perm in ["contents", "actions", "packages"]:
                            pass  # These are common and often needed

                # Check for pinned action versions
                content = open(wf_file).read()
                import re
                unpinned = re.findall(r'uses: [^@\n]+@(?![\da-f]{40})[^\n]+', content)
                for u in unpinned:
                    if "actions/checkout" not in u and "actions/setup" not in u:
                        issues.append(f"{wf_file}: unpinned action: {u.strip()}")

            except Exception as e:
                issues.append(f"{wf_file}: parse error: {e}")

        if issues:
            print(f"\nFound {len(issues)} workflow security issues:")
            for issue in issues[:10]:
                print(f"  - {issue}")
        else:
            print("No workflow security issues found")
        PYEOF

    - name: Create security summary
      run: |
        echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Node.js High Vulns | ${{ steps.node_audit.outputs.high_vulns }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Python Vulns | ${{ steps.python_audit.outputs.python_vulns }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Scan completed at: $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
