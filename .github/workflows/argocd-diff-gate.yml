name: ArgoCD Diff Gate

on:
  pull_request:
    branches: [main]
    paths:
      - 'platforms/**'
      - 'gitops/**'
      - 'k8s/**'
      - 'infrastructure/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  argocd-diff:
    name: ArgoCD Diff Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4
        with:
          fetch-depth: 0

      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o /usr/local/bin/argocd \
            https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x /usr/local/bin/argocd

      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Render manifests diff (Helm template)
        id: diff
        run: |
          set +e
          DIFF_OUTPUT=""

          # Check each changed gitops path
          CHANGED=$(git diff --name-only origin/main...HEAD | grep -E '^(gitops|platforms|k8s)/' | head -20)

          if [ -z "$CHANGED" ]; then
            echo "No gitops/platforms/k8s changes detected"
            echo "diff_empty=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED"

          # Render diff for each Helm chart directory changed
          for dir in $(echo "$CHANGED" | xargs -I{} dirname {} | sort -u); do
            if [ -f "$dir/Chart.yaml" ]; then
              echo "=== Helm diff: $dir ===" >> /tmp/diff_output.txt
              helm template test "$dir" 2>&1 >> /tmp/diff_output.txt || true
            fi
          done

          # Plain manifest diff
          git diff origin/main...HEAD -- gitops/ platforms/ k8s/ >> /tmp/diff_output.txt 2>&1 || true

          DIFF_SIZE=$(wc -c < /tmp/diff_output.txt)
          echo "diff_size=$DIFF_SIZE" >> $GITHUB_OUTPUT

          if [ "$DIFF_SIZE" -gt 0 ]; then
            echo "diff_empty=false" >> $GITHUB_OUTPUT
          else
            echo "diff_empty=true" >> $GITHUB_OUTPUT
          fi

      - name: Check for critical resource deletion
        id: prune-check
        run: |
          DANGEROUS_DELETES=$(git diff origin/main...HEAD -- gitops/ platforms/ k8s/ \
            | grep '^-' \
            | grep -E 'kind: (CustomResourceDefinition|ClusterRole|ClusterRoleBinding|Namespace|ValidatingWebhookConfiguration|MutatingWebhookConfiguration|PodDisruptionBudget|ResourceQuota)' \
            | grep -v '^---' || true)

          if [ -n "$DANGEROUS_DELETES" ]; then
            echo "DANGEROUS_DELETES detected:"
            echo "$DANGEROUS_DELETES"
            echo "has_dangerous_deletes=true" >> $GITHUB_OUTPUT
            echo "$DANGEROUS_DELETES" > /tmp/dangerous_deletes.txt
          else
            echo "has_dangerous_deletes=false" >> $GITHUB_OUTPUT
          fi

      - name: Post diff as PR comment
        if: steps.diff.outputs.diff_empty == 'false'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7
        with:
          script: |
            const fs = require('fs');
            let diffContent = '';
            try {
              diffContent = fs.readFileSync('/tmp/diff_output.txt', 'utf8').slice(0, 60000);
            } catch(e) {
              diffContent = 'Could not read diff output';
            }

            const hasDangerous = '${{ steps.prune-check.outputs.has_dangerous_deletes }}' === 'true';
            const header = hasDangerous
              ? '## ⚠️ ArgoCD Diff Gate — DANGEROUS DELETIONS DETECTED'
              : '## ArgoCD Diff Gate — Review Required';

            const body = `${header}

            ${hasDangerous ? '**CRITICAL: This PR deletes critical cluster resources (CRD/ClusterRole/Webhook/PDB/ResourceQuota). Manual review required before merge.**\n\n' : ''}

            <details>
            <summary>Manifest Diff (click to expand)</summary>

            \`\`\`diff
            ${diffContent}
            \`\`\`
            </details>

            > Generated by ArgoCD Diff Gate — all gitops changes require diff review.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail on dangerous deletes
        if: steps.prune-check.outputs.has_dangerous_deletes == 'true'
        run: |
          echo "ERROR: PR contains deletion of critical cluster resources."
          echo "Review /tmp/dangerous_deletes.txt and add 'argocd.argoproj.io/sync-options: Prune=false' annotation if intentional."
          cat /tmp/dangerous_deletes.txt
          exit 1

  validate-prune-annotations:
    name: Validate Prune=false Annotations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4

      - name: Check critical resources have Prune=false
        run: |
          MISSING_ANNOTATION=()

          # Check CRDs
          for f in $(find gitops/ platforms/ k8s/ -name "*.yaml" 2>/dev/null | xargs grep -l "kind: CustomResourceDefinition" 2>/dev/null); do
            if ! grep -q 'Prune=false' "$f"; then
              MISSING_ANNOTATION+=("$f: CRD missing argocd.argoproj.io/sync-options: Prune=false")
            fi
          done

          # Check ValidatingWebhookConfiguration
          for f in $(find gitops/ platforms/ k8s/ -name "*.yaml" 2>/dev/null | xargs grep -l "kind: ValidatingWebhookConfiguration" 2>/dev/null); do
            if ! grep -q 'Prune=false' "$f"; then
              MISSING_ANNOTATION+=("$f: ValidatingWebhookConfiguration missing Prune=false")
            fi
          done

          if [ ${#MISSING_ANNOTATION[@]} -gt 0 ]; then
            echo "WARNING: Critical resources missing Prune=false annotation:"
            printf '%s\n' "${MISSING_ANNOTATION[@]}"
            # Warn only (not fail) — Phase 4 hardening
          else
            echo "All critical resources have Prune=false annotation"
          fi
