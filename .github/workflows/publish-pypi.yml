name: Publish PyPI Package

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      with:
        ref: ${{ github.ref }}

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
      with:
        python-version: '3.11'

    - name: Check if version already published
      id: version_check
      run: |
        cd backend/ai
        # Extract package name and version using heredoc to avoid YAML parse errors
        PKG_NAME=$(python3 - << 'PYEOF'
        import tomllib, sys
        try:
            d = tomllib.load(open('pyproject.toml', 'rb'))
            name = d.get('tool', {}).get('poetry', {}).get('name') or d.get('project', {}).get('name', '')
            print(name.replace('-', '_'))
        except Exception:
            sys.exit(1)
        PYEOF
        ) || PKG_NAME=$(grep -m1 '^name' pyproject.toml | sed 's/.*= *"\(.*\)"/\1/' | tr '-' '_')
        PKG_VERSION=$(python3 - << 'PYEOF'
        import tomllib, sys
        try:
            d = tomllib.load(open('pyproject.toml', 'rb'))
            version = d.get('tool', {}).get('poetry', {}).get('version') or d.get('project', {}).get('version', '')
            print(version)
        except Exception:
            sys.exit(1)
        PYEOF
        ) || PKG_VERSION=$(grep -m1 '^version' pyproject.toml | sed 's/.*= *"\(.*\)"/\1/')
        echo "pkg_name=$PKG_NAME" >> "$GITHUB_OUTPUT"
        echo "pkg_version=$PKG_VERSION" >> "$GITHUB_OUTPUT"
        echo "Checking if ${PKG_NAME}==${PKG_VERSION} is already on PyPI..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/${PKG_NAME}/${PKG_VERSION}/json")
        if [ "$HTTP_CODE" = "200" ]; then
          echo "already_published=true" >> "$GITHUB_OUTPUT"
          echo "Version ${PKG_VERSION} already published on PyPI — skipping upload."
        else
          echo "already_published=false" >> "$GITHUB_OUTPUT"
          echo "Version ${PKG_VERSION} not yet on PyPI — proceeding with upload."
        fi

    - name: Build and publish to PyPI
      if: steps.version_check.outputs.already_published == 'false'
      run: |
        pip install build twine -q
        cd backend/ai
        python -m build
        twine upload dist/*
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

    - name: Summary
      run: |
        if [ "${{ steps.version_check.outputs.already_published }}" = "true" ]; then
          echo "## PyPI Publish — Skipped (already published)" >> $GITHUB_STEP_SUMMARY
          echo "Package \`${{ steps.version_check.outputs.pkg_name }}==${{ steps.version_check.outputs.pkg_version }}\` already exists on PyPI." >> $GITHUB_STEP_SUMMARY
        else
          echo "## PyPI Publish — Success" >> $GITHUB_STEP_SUMMARY
          echo "Published \`${{ steps.version_check.outputs.pkg_name }}==${{ steps.version_check.outputs.pkg_version }}\` to PyPI." >> $GITHUB_STEP_SUMMARY
        fi
