name: Scheduled Health Check & Auto-Remediation

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
    # Run weekly on Monday at 06:00 UTC (deep scan)
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of health check to run'
        required: false
        type: choice
        options:
          - quick
          - full
          - security
        default: full

permissions:
  contents: read
  issues: write
  security-events: write
  actions: read

jobs:
  health-check:
    name: System Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      health_score: ${{ steps.score.outputs.health_score }}
      issues_found: ${{ steps.score.outputs.issues_found }}

    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      with:
        fetch-depth: 0

    - name: Run CI Validator Engine
      id: validator
      run: |
        echo "=== CI Validator Health Check ==="
        python3 tools/ci-validator/validate.py --report=/tmp/health-report.json || true
        if [ -f /tmp/health-report.json ]; then
          echo "Validator report generated"
          cat /tmp/health-report.json | python3 -m json.tool || true
        fi

    - name: Check workflow syntax
      id: yaml_check
      run: |
        echo "=== YAML Syntax Check ==="
        ERROR_COUNT=0
        for f in .github/workflows/*.yaml .github/workflows/*.yml; do
          if ! python3 -c 'import yaml, sys; yaml.safe_load(open(sys.argv[1]))' "$f" 2>/dev/null; then
            echo "YAML ERROR: $f"
            ERROR_COUNT=$((ERROR_COUNT + 1))
          fi
        done
        echo "yaml_errors=$ERROR_COUNT" >> "$GITHUB_OUTPUT"
        echo "Total YAML errors: $ERROR_COUNT"

    - name: Check for hardcoded secrets
      id: secret_check
      run: |
        echo "=== Hardcoded Secret Check ==="
        PATTERNS=(
          "sk-ant-api[0-9A-Za-z-]+"
          "gsk_[0-9A-Za-z]+"
          "sbp_[0-9a-f]+"
          "ghp_[0-9A-Za-z]+"
          "npm_[0-9A-Za-z]+"
        )
        FOUND=0
        for pattern in "${PATTERNS[@]}"; do
          MATCHES=$(grep -rE "$pattern" \
            --include="*.ts" --include="*.js" --include="*.py" \
            --include="*.yaml" --include="*.yml" --include="*.md" \
            --exclude-dir=".git" --exclude-dir="node_modules" \
            . 2>/dev/null | grep -v "REDACTED" | wc -l)
          if [ "$MATCHES" -gt 0 ]; then
            echo "WARNING: Found $MATCHES potential secrets matching pattern: $pattern"
            FOUND=$((FOUND + MATCHES))
          fi
        done
        echo "secrets_found=$FOUND" >> "$GITHUB_OUTPUT"
        echo "Total potential secrets found: $FOUND"

    - name: Check recent workflow failures
      id: workflow_check
      run: |
        echo "=== Recent Workflow Failures ==="
        python3 - << 'PYEOF'
        import json, urllib.request, os
        token = os.environ.get("GITHUB_TOKEN", "")
        repo = os.environ.get("GITHUB_REPOSITORY", "")
        if not token or not repo:
            print("Missing GITHUB_TOKEN or GITHUB_REPOSITORY")
            exit(0)
        url = f"https://api.github.com/repos/{repo}/actions/runs?status=failure&per_page=10"
        req = urllib.request.Request(url, headers={
            "Authorization": f"token {token}",
            "Accept": "application/vnd.github.v3+json",
        })
        try:
            with urllib.request.urlopen(req) as resp:
                data = json.loads(resp.read())
                runs = data.get("workflow_runs", [])
                if runs:
                    print(f"Found {len(runs)} recent failed workflow runs:")
                    for run in runs[:5]:
                        print(f"  - {run['name']} (#{run['run_number']}) at {run['created_at']}")
                else:
                    print("No recent workflow failures found")
        except Exception as e:
            print(f"Could not check workflow runs: {e}")
        PYEOF
      env:
        GITHUB_TOKEN: ${{ github.token }}

    - name: Calculate health score
      id: score
      run: |
        YAML_ERRORS="${{ steps.yaml_check.outputs.yaml_errors }}"
        SECRETS_FOUND="${{ steps.secret_check.outputs.secrets_found }}"
        YAML_ERRORS=${YAML_ERRORS:-0}
        SECRETS_FOUND=${SECRETS_FOUND:-0}

        SCORE=100
        SCORE=$((SCORE - YAML_ERRORS * 10))
        SCORE=$((SCORE - SECRETS_FOUND * 20))
        if [ $SCORE -lt 0 ]; then SCORE=0; fi

        ISSUES=$((YAML_ERRORS + SECRETS_FOUND))

        echo "health_score=$SCORE" >> "$GITHUB_OUTPUT"
        echo "issues_found=$ISSUES" >> "$GITHUB_OUTPUT"
        echo "=== Health Score: $SCORE/100 ==="
        echo "=== Issues Found: $ISSUES ==="

  report-issues:
    name: Report Health Issues
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.issues_found > 0
    steps:
    - name: Create issue for health problems
      env:
        GH_TOKEN: ${{ github.token }}
        HEALTH_SCORE: ${{ needs.health-check.outputs.health_score }}
        ISSUES_FOUND: ${{ needs.health-check.outputs.issues_found }}
      run: |
        TITLE="[Auto] Health Check Alert â€” Score: ${HEALTH_SCORE}/100"
        BODY="## Automated Health Check Report

        **Date**: $(date -u '+%Y-%m-%d %H:%M UTC')
        **Health Score**: ${HEALTH_SCORE}/100
        **Issues Found**: ${ISSUES_FOUND}

        This issue was automatically created by the scheduled health check workflow.

        ### Next Steps
        1. Review the workflow run logs for details
        2. Fix any YAML syntax errors in workflows
        3. Remove any hardcoded secrets found
        4. Run \`python3 tools/ci-validator/auto-fix.py\` for auto-fixable issues

        ### Links
        - [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        - [Security Alerts](https://github.com/${{ github.repository }}/security)
        "

        EXISTING=$(gh issue list --repo "${{ github.repository }}" \
          --label "health-check" --state open \
          --json number --jq '.[0].number' 2>/dev/null || echo "")

        if [ -z "$EXISTING" ]; then
          gh issue create \
            --repo "${{ github.repository }}" \
            --title "$TITLE" \
            --body "$BODY" 2>/dev/null || echo "Could not create issue"
        else
          gh issue comment "$EXISTING" \
            --repo "${{ github.repository }}" \
            --body "$BODY" 2>/dev/null || echo "Could not comment on issue"
        fi
