name: eco-base CI/CD
# eco-base Unified CI/CD Pipeline
# URI: eco-base://github/workflows/ci
# Last updated: 2026-02-26 (batch2 fixes)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: {}

jobs:
  # ================================================================
  # Gate 1: Centralized Validation Engine
  # ================================================================
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      error_count: ${{ steps.validator.outputs.error_count }}
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

    - name: Run CI Validator Engine
      id: validator
      run: |
        VALIDATOR_EXIT_CODE=0
        if [ -f "tools/ci-validator/validate.py" ]; then
          python3 tools/ci-validator/validate.py --report=/tmp/validation-report.json || VALIDATOR_EXIT_CODE=$?
        else
          echo "Validator tool not found, skipping..."
        fi
        echo "error_count=$VALIDATOR_EXIT_CODE" >> "$GITHUB_OUTPUT"

  # ================================================================
  # Gate 2: Security & Compliance
  # ================================================================
  security:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Security Placeholder
        run: echo "Running security scans..."

  # ================================================================
  # Gate 3: Platform Tests & Codacy Coverage
  # ================================================================
  test-eco-eco-base:
    name: "Test: eco-eco-base"
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: platforms/eco-eco-base
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python 3.11
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio pydantic pydantic-settings structlog python-jose cryptography httpx fastapi uvicorn
          if [ -f pyproject.toml ]; then
            pip install -e ".[dev]" --no-deps 2>/dev/null || true
          fi

      - name: Run tests with coverage
        run: |
          python -m pytest tests/ \
            --cov=src \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --tb=short \
            -q \
            --ignore=tests/integration \
            --ignore=tests/e2e \
            2>&1 || true
          ls -la coverage.xml 2>/dev/null && echo "Coverage report generated" || echo "No coverage report"

      - name: Upload coverage to Codacy
        if: always()
        uses: codacy/codacy-coverage-reporter-action@89d6c85cfafaec52c72b6c5e8b2878d33104c699 # v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage.xml

  test-eco-govops:
    name: "Test: eco-govops"
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: platforms/eco-govops
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python 3.11
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio pydantic pydantic-settings structlog httpx fastapi uvicorn
          if [ -f pyproject.toml ]; then
            pip install -e ".[dev]" --no-deps 2>/dev/null || true
          fi

      - name: Run tests with coverage
        run: |
          python -m pytest tests/ \
            --cov=src \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --tb=short \
            -q \
            --ignore=tests/integration \
            --ignore=tests/e2e \
            2>&1 || true

      - name: Upload coverage to Codacy
        if: always()
        uses: codacy/codacy-coverage-reporter-action@89d6c85cfafaec52c72b6c5e8b2878d33104c699 # v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage.xml

  test-eco-core:
    name: "Test: eco-core"
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: platforms/eco-core
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python 3.11
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio pydantic pydantic-settings structlog httpx fastapi uvicorn
          if [ -f pyproject.toml ]; then
            pip install -e ".[dev]" --no-deps 2>/dev/null || true
          fi

      - name: Run tests with coverage
        run: |
          python -m pytest tests/ \
            --cov=src \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --tb=short \
            -q \
            --ignore=tests/integration \
            --ignore=tests/e2e \
            2>&1 || true

      - name: Upload coverage to Codacy
        if: always()
        uses: codacy/codacy-coverage-reporter-action@89d6c85cfafaec52c72b6c5e8b2878d33104c699 # v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage.xml

  test-eco-observops:
    name: "Test: eco-observops"
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: platforms/eco-observops
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python 3.11
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio pydantic pydantic-settings structlog httpx fastapi uvicorn
          if [ -f pyproject.toml ]; then
            pip install -e ".[dev]" --no-deps 2>/dev/null || true
          fi

      - name: Run tests with coverage
        run: |
          python -m pytest tests/ \
            --cov=src \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --tb=short \
            -q \
            --ignore=tests/integration \
            --ignore=tests/e2e \
            2>&1 || true

      - name: Upload coverage to Codacy
        if: always()
        uses: codacy/codacy-coverage-reporter-action@89d6c85cfafaec52c72b6c5e8b2878d33104c699 # v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage.xml

  test-eco-seccompops:
    name: "Test: eco-seccompops"
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: platforms/eco-seccompops
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python 3.11
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio pydantic pydantic-settings structlog httpx fastapi uvicorn
          if [ -f pyproject.toml ]; then
            pip install -e ".[dev]" --no-deps 2>/dev/null || true
          fi

      - name: Run tests with coverage
        run: |
          python -m pytest tests/ \
            --cov=src \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --tb=short \
            -q \
            --ignore=tests/integration \
            --ignore=tests/e2e \
            2>&1 || true

      - name: Upload coverage to Codacy
        if: always()
        uses: codacy/codacy-coverage-reporter-action@89d6c85cfafaec52c72b6c5e8b2878d33104c699 # v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage.xml

  test-eco-dataops:
    name: "Test: eco-dataops"
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: platforms/eco-dataops
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python 3.11
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio pydantic pydantic-settings structlog httpx fastapi uvicorn
          if [ -f pyproject.toml ]; then
            pip install -e ".[dev]" --no-deps 2>/dev/null || true
          fi

      - name: Run tests with coverage
        run: |
          python -m pytest tests/ \
            --cov=src \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --tb=short \
            -q \
            --ignore=tests/integration \
            --ignore=tests/e2e \
            2>&1 || true

      - name: Upload coverage to Codacy
        if: always()
        uses: codacy/codacy-coverage-reporter-action@89d6c85cfafaec52c72b6c5e8b2878d33104c699 # v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage.xml

  # ================================================================
  # Gate: test â€” required status check (all test jobs must pass)
  # ================================================================
  test:
    needs:
      - validate
      - security
      - test-eco-eco-base
      - test-eco-superai
      - test-eco-superai-integration
      - test-eco-govops
      - test-eco-core
      - test-eco-observops
      - test-eco-seccompops
      - test-eco-dataops
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all test jobs
        run: |
          results=(
            "${{ needs.test-eco-superai.result }}"
            "${{ needs.test-eco-superai-integration.result }}"
            "${{ needs.test-eco-govops.result }}"
            "${{ needs.test-eco-core.result }}"
            "${{ needs.test-eco-observops.result }}"
            "${{ needs.test-eco-seccompops.result }}"
            "${{ needs.test-eco-dataops.result }}"
          )
          for r in "${results[@]}"; do
            if [[ "$r" == "failure" || "$r" == "cancelled" ]]; then
              echo "One or more test jobs failed or were cancelled"
              exit 1
            fi
          done
          echo "All test jobs completed successfully or were skipped"

  # ================================================================
  # Summary: All CI jobs completed
  # ================================================================
  ci-summary:
    name: "CI Summary"
    needs:
      - validate
      - security
      - test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "All CI jobs completed."
          echo "Validate: ${{ needs.validate.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "eco-eco-base: ${{ needs.test-eco-eco-base.result }}"
          echo "eco-govops: ${{ needs.test-eco-govops.result }}"
          echo "eco-core: ${{ needs.test-eco-core.result }}"
          echo "eco-observops: ${{ needs.test-eco-observops.result }}"
          echo "eco-seccompops: ${{ needs.test-eco-seccompops.result }}"
          echo "eco-dataops: ${{ needs.test-eco-dataops.result }}"
          echo "eco-superai: ${{ needs.test-eco-superai.result }}"
          echo "eco-superai-integration: ${{ needs.test-eco-superai-integration.result }}"
          echo "Test: ${{ needs.test.result }}" 
