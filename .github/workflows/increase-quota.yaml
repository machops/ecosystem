name: Increase SSD Quota

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'GCP region'
        required: true
        default: 'asia-east1'
      current_limit:
        description: 'Current SSD limit in GB'
        required: true
        type: number
      requested_limit:
        description: 'Requested SSD limit in GB'
        required: true
        type: number
      justification:
        description: 'Justification for quota increase'
        required: true
        type: string

permissions:
  contents: read
  issues: write

env:
  GCP_PROJECT: my-project-ops-1991

jobs:
  check-current-quota:
    name: Check Current Quota
    runs-on: ubuntu-latest
    outputs:
      current_usage: ${{ steps.check-quota.outputs.usage }}
      current_limit: ${{ steps.check-quota.outputs.limit }}
      quota_status_json: ${{ steps.check-quota.outputs.quota_status_json }}
    steps:
      - name: Checkout repository
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Install Python 3.11
        run: |
          sudo add-apt-repository ppa:deadsnakes/ppa -y
          sudo apt-get update -y
          sudo apt-get install -y python3.11 python3.11-venv python3-pip
          python3.11 --version

      - name: Install dependencies
        run: |
          python3.11 -m pip install google-cloud-compute google-auth

      - name: Configure service account credentials
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          TMP_DIR="$(mktemp -d)"
          chmod 700 "$TMP_DIR"
          KEY_FILE="$(mktemp "$TMP_DIR/gcp-sa-key-XXXXXX.json")"
          echo "$GCP_SA_KEY" > "$KEY_FILE"
          chmod 600 "$KEY_FILE"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$KEY_FILE" >> $GITHUB_ENV
          echo "GCP_CREDENTIALS_DIR=$TMP_DIR" >> $GITHUB_ENV

      - name: Check current quota
        id: check-quota
        env:
          REGION: ${{ github.event.inputs.region }}
        run: |
          # Run the quota script, capturing only the final JSON line into quota_status.json.
          # Any non-JSON logs are written to a separate log file.
          python3.11 scripts/increase_ssd_quota.py \
            --action check \
            --region "$REGION" \
            --output-json 2>increase_quota.log | tail -n 1 > quota_status.json
          
          # Optionally surface logs in the GitHub Actions output
          if [ -s increase_quota.log ]; then
            echo "::group::increase_ssd_quota.py logs"
            cat increase_quota.log
            echo "::endgroup::"
          fi
          
          OUTPUT_DELIMITER="EOF_QUOTA_STATUS_$(date +%s)"
          echo "usage=$(jq -r '.usage' quota_status.json)" >> $GITHUB_OUTPUT
          echo "limit=$(jq -r '.limit' quota_status.json)" >> $GITHUB_OUTPUT
          echo "quota_status_json<<$OUTPUT_DELIMITER" >> $GITHUB_OUTPUT
          cat quota_status.json >> $GITHUB_OUTPUT
          echo "$OUTPUT_DELIMITER" >> $GITHUB_OUTPUT
          
          cat quota_status.json

      - name: Cleanup credentials
        if: always()
        run: rm -rf "${GCP_CREDENTIALS_DIR:-}"

  request-quota-increase:
    name: Request Quota Increase
    runs-on: ubuntu-latest
    needs: check-current-quota
    steps:
      - name: Checkout repository
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Install Python 3.11
        run: |
          sudo add-apt-repository ppa:deadsnakes/ppa -y
          sudo apt-get update -y
          sudo apt-get install -y python3.11 python3.11-venv python3-pip
          python3.11 --version

      - name: Install dependencies
        run: |
          python3.11 -m pip install google-cloud-compute google-auth

      - name: Configure service account credentials
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          TMP_DIR="$(mktemp -d)"
          chmod 700 "$TMP_DIR"
          KEY_FILE="$(mktemp "$TMP_DIR/gcp-sa-key-XXXXXX.json")"
          echo "$GCP_SA_KEY" > "$KEY_FILE"
          chmod 600 "$KEY_FILE"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$KEY_FILE" >> $GITHUB_ENV
          echo "GCP_CREDENTIALS_DIR=$TMP_DIR" >> $GITHUB_ENV

      - name: Restore quota status
        env:
          QUOTA_STATUS_JSON: ${{ needs.check-current-quota.outputs.quota_status_json }}
        run: |
          printf '%s' "$QUOTA_STATUS_JSON" > quota_status.json
          cat quota_status.json

      - name: Request quota increase
        env:
          REGION: ${{ github.event.inputs.region }}
          CURRENT_LIMIT: ${{ github.event.inputs.current_limit }}
          REQUESTED_LIMIT: ${{ github.event.inputs.requested_limit }}
          JUSTIFICATION: ${{ github.event.inputs.justification }}
        run: |
          python3.11 scripts/increase_ssd_quota.py \
            --action request \
            --region $REGION \
            --current-limit $CURRENT_LIMIT \
            --requested-limit $REQUESTED_LIMIT \
            --justification "$JUSTIFICATION" \
            --output-json > quota_request.json
          
          cat quota_request.json

      - name: Create issue for tracking
        env:
          REGION: ${{ github.event.inputs.region }}
          CURRENT_LIMIT: ${{ github.event.inputs.current_limit }}
          REQUESTED_LIMIT: ${{ github.event.inputs.requested_limit }}
          JUSTIFICATION: ${{ github.event.inputs.justification }}
          CURRENT_USAGE: ${{ needs.check-current-quota.outputs.current_usage }}
          REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3.11 <<'PY'
          import json
          import os
          import urllib.error
          import urllib.request

          if not os.path.exists("quota_request.json"):
              raise FileNotFoundError("quota_request.json was not generated by the quota request step")

          with open("quota_request.json", "r", encoding="utf-8") as f:
              try:
                  request_data = json.load(f)
              except json.JSONDecodeError as exc:
                  raise RuntimeError("quota_request.json exists but contains invalid JSON") from exc

          body = f"""## SSD Quota Increase Request

          **Region**: {os.environ['REGION']}
          **Current Limit**: {os.environ['CURRENT_LIMIT']} GB
          **Requested Limit**: {os.environ['REQUESTED_LIMIT']} GB
          **Current Usage**: {os.environ['CURRENT_USAGE']} GB

          **Justification**:
          {os.environ['JUSTIFICATION']}

          **Request ID**: `{request_data.get('request_id', 'N/A')}`
          **Status**: `{request_data.get('status', 'Submitted')}`

          ### Next Steps
          1. Monitor approval status in GCP Console
          2. Once approved, recreate production cluster
          3. Deploy production workloads

          ### References
          - [GCP Quotas Console](https://console.cloud.google.com/iam-admin/quotas?project=my-project-ops-1991)
          - [Quota Guide](docs/gcp-quota-guide.md)"""

          payload = json.dumps({
              "title": f"SSD Quota Increase Request - {os.environ['REGION']}",
              "body": body,
              "labels": ["quota", "infrastructure", "gcp"],
          }).encode("utf-8")

          req = urllib.request.Request(
              f"https://api.github.com/repos/{os.environ['REPOSITORY']}/issues",
              data=payload,
              method="POST",
              headers={
                  "Accept": "application/vnd.github+json",
                  "Authorization": f"Bearer {os.environ['GITHUB_TOKEN']}",
                  "X-GitHub-Api-Version": "2022-11-28",
                  "Content-Type": "application/json",
              },
          )
          try:
              with urllib.request.urlopen(req) as resp:
                  issue = json.load(resp)
                  print(f"Issue created: {issue.get('html_url', 'unknown')}")
          except urllib.error.HTTPError as exc:
              error_body = exc.read().decode("utf-8", errors="replace")
              try:
                  error_json = json.loads(error_body)
                  error_message = error_json.get("message", error_body)
              except json.JSONDecodeError:
                  error_message = error_body
              raise RuntimeError(f"Failed to create issue: HTTP {exc.code} - {error_message}") from exc
          PY

      - name: Notify on success
        if: success()
        run: |
          echo "Quota increase request submitted successfully"
          echo "Request ID: $(jq -r '.request_id' quota_request.json)"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quota Status (restored)" >> $GITHUB_STEP_SUMMARY
          cat quota_status.json >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quota Request" >> $GITHUB_STEP_SUMMARY
          cat quota_request.json >> $GITHUB_STEP_SUMMARY

      - name: Cleanup credentials
        if: always()
        run: rm -rf "${GCP_CREDENTIALS_DIR:-}"
