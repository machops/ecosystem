name: Increase SSD Quota

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'GCP region'
        required: true
        default: 'asia-east1'
      current_limit:
        description: 'Current SSD limit in GB'
        required: true
        type: number
      requested_limit:
        description: 'Requested SSD limit in GB'
        required: true
        type: number
      justification:
        description: 'Justification for quota increase'
        required: true
        type: string

env:
  GCP_PROJECT: my-project-ops-1991

permissions:
  contents: read
  issues: write

jobs:
  manage-quota:
    name: Check and Request Quota Increase
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Install dependencies
        run: |
          pip install google-cloud-compute google-auth

      - name: Install gcloud CLI and authenticate
        run: |
          curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get update -y && sudo apt-get install -y google-cloud-cli
          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-sa-key.json
          chmod 600 /tmp/gcp-sa-key.json
          gcloud auth activate-service-account --key-file=/tmp/gcp-sa-key.json
          gcloud config set project $GCP_PROJECT
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-sa-key.json" >> $GITHUB_ENV

      - name: Check current quota
        id: check-quota
        env:
          REGION: ${{ github.event.inputs.region }}
        run: |
          python scripts/increase_ssd_quota.py \
            --action check \
            --region $REGION \
            --output-json > quota_status.json

          echo "usage=$(jq -r '.usage' quota_status.json)" >> $GITHUB_OUTPUT
          echo "limit=$(jq -r '.limit' quota_status.json)" >> $GITHUB_OUTPUT

          cat quota_status.json

      - name: Request quota increase
        env:
          REGION: ${{ github.event.inputs.region }}
          CURRENT_LIMIT: ${{ github.event.inputs.current_limit }}
          REQUESTED_LIMIT: ${{ github.event.inputs.requested_limit }}
          JUSTIFICATION: ${{ github.event.inputs.justification }}
        run: |
          python scripts/increase_ssd_quota.py \
            --action request \
            --region $REGION \
            --current-limit $CURRENT_LIMIT \
            --requested-limit $REQUESTED_LIMIT \
            --justification "$JUSTIFICATION" \
            --output-json > quota_request.json

          cat quota_request.json

      - name: Create issue for tracking
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USAGE: ${{ steps.check-quota.outputs.usage }}
          REGION: ${{ github.event.inputs.region }}
          CURRENT_LIMIT: ${{ github.event.inputs.current_limit }}
          REQUESTED_LIMIT: ${{ github.event.inputs.requested_limit }}
          JUSTIFICATION: ${{ github.event.inputs.justification }}
        run: |
          REQUEST_ID=$(jq -r '.request_id // "N/A"' quota_request.json)
          STATUS=$(jq -r '.status // "Submitted"' quota_request.json)

          printf '## SSD Quota Increase Request\n\n' > issue_body.txt
          printf '**Region**: %s\n' "$REGION" >> issue_body.txt
          printf '**Current Limit**: %s GB\n' "$CURRENT_LIMIT" >> issue_body.txt
          printf '**Requested Limit**: %s GB\n' "$REQUESTED_LIMIT" >> issue_body.txt
          printf '**Current Usage**: %s GB\n\n' "$USAGE" >> issue_body.txt
          printf '**Justification**:\n%s\n\n' "$JUSTIFICATION" >> issue_body.txt
          printf '**Request ID**: `%s`\n' "$REQUEST_ID" >> issue_body.txt
          printf '**Status**: `%s`\n\n' "$STATUS" >> issue_body.txt
          printf '### Next Steps\n' >> issue_body.txt
          printf '1. Monitor approval status in GCP Console\n' >> issue_body.txt
          printf '2. Once approved, recreate production cluster\n' >> issue_body.txt
          printf '3. Deploy production workloads\n\n' >> issue_body.txt
          printf '### References\n' >> issue_body.txt
          printf '- [GCP Quotas Console](https://console.cloud.google.com/iam-admin/quotas?project=my-project-ops-1991)\n' >> issue_body.txt
          printf '- [Quota Guide](docs/gcp-quota-guide.md)\n' >> issue_body.txt

          gh issue create \
            --title "SSD Quota Increase Request - ${REGION}" \
            --body-file issue_body.txt \
            --label "quota" \
            --label "infrastructure" \
            --label "gcp"

      - name: Notify on success
        if: success()
        run: |
          echo "Quota increase request submitted successfully"
          echo "Request ID: $(jq -r '.request_id' quota_request.json)"

      - name: Cleanup credentials
        if: always()
        run: rm -f /tmp/gcp-sa-key.json