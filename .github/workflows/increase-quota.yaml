name: Increase SSD Quota

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'GCP region'
        required: true
        default: 'asia-east1'
      current_limit:
        description: 'Current SSD limit in GB'
        required: true
        type: number
      requested_limit:
        description: 'Requested SSD limit in GB'
        required: true
        type: number
      justification:
        description: 'Justification for quota increase'
        required: true
        type: string

permissions:
  contents: read
  issues: write

env:
  GCP_PROJECT: my-project-ops-1991

permissions:
  contents: read
  issues: write

jobs:
  manage-quota:
    name: Check and Request Quota Increase
    runs-on: ubuntu-latest
    outputs:
      current_usage: ${{ steps.check-quota.outputs.usage }}
      current_limit: ${{ steps.check-quota.outputs.limit }}
      quota_status_json: ${{ steps.check-quota.outputs.quota_status_json }}
    steps:
      - name: Checkout repository
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Install Python 3.11
        run: |
          sudo add-apt-repository ppa:deadsnakes/ppa -y
          sudo apt-get update -y
          sudo apt-get install -y python3.11 python3.11-venv python3.11-pip
          python3.11 --version

      - name: Install dependencies
        run: |
          python3.11 -m pip install google-cloud-compute google-auth

      - name: Configure service account credentials
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          TMP_DIR="$(mktemp -d)"
          chmod 700 "$TMP_DIR"
          KEY_FILE="$(mktemp "$TMP_DIR/gcp-sa-key-XXXXXX.json")"
          echo "$GCP_SA_KEY" > "$KEY_FILE"
          chmod 600 "$KEY_FILE"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$KEY_FILE" >> $GITHUB_ENV
          echo "GCP_CREDENTIALS_DIR=$TMP_DIR" >> $GITHUB_ENV
      - name: Install gcloud CLI and authenticate
        run: |
          curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get update -y && sudo apt-get install -y google-cloud-cli
          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-sa-key.json
          chmod 600 /tmp/gcp-sa-key.json
          gcloud auth activate-service-account --key-file=/tmp/gcp-sa-key.json
          gcloud config set project $GCP_PROJECT
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-sa-key.json" >> $GITHUB_ENV

      - name: Check current quota
        id: check-quota
        env:
          REGION: ${{ github.event.inputs.region }}
        run: |
          python3.11 scripts/increase_ssd_quota.py \
            --action check \
            --region "$REGION" \
            --output-json > quota_status.raw

          awk 'BEGIN{capture=0} /^\{/{capture=1} !capture{print}' quota_status.raw > increase_quota.log
          awk 'BEGIN{capture=0} /^\{/{capture=1} capture{print}' quota_status.raw > quota_status.json

          if [ ! -s quota_status.json ]; then
            echo "Failed to extract JSON payload from quota check output"
            cat quota_status.raw
            exit 1
          fi

          if [ -s increase_quota.log ]; then
            echo "::group::increase_ssd_quota.py logs"
            cat increase_quota.log
            echo "::endgroup::"
          fi
          
          OUTPUT_DELIMITER="EOF_QUOTA_STATUS_$(date +%s)"
          echo "usage=$(jq -r '.usage' quota_status.json)" >> $GITHUB_OUTPUT
          echo "limit=$(jq -r '.limit' quota_status.json)" >> $GITHUB_OUTPUT
          echo "quota_status_json<<$OUTPUT_DELIMITER" >> $GITHUB_OUTPUT
          cat quota_status.json >> $GITHUB_OUTPUT
          echo "$OUTPUT_DELIMITER" >> $GITHUB_OUTPUT
          
          cat quota_status.json

      - name: Cleanup credentials
        if: always()
        run: |
          if [ -n "${GCP_CREDENTIALS_DIR+x}" ] && [ -n "$GCP_CREDENTIALS_DIR" ]; then
            rm -rf "$GCP_CREDENTIALS_DIR"
          fi

  request-quota-increase:
    name: Request Quota Increase
    runs-on: ubuntu-latest
    needs: check-current-quota
    steps:
      - name: Checkout repository
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Install Python 3.11
        run: |
          sudo add-apt-repository ppa:deadsnakes/ppa -y
          sudo apt-get update -y
          sudo apt-get install -y python3.11 python3.11-venv python3.11-pip
          python3.11 --version

      - name: Install dependencies
        run: |
          python3.11 -m pip install google-cloud-compute google-auth

      - name: Configure service account credentials
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          TMP_DIR="$(mktemp -d)"
          chmod 700 "$TMP_DIR"
          KEY_FILE="$(mktemp "$TMP_DIR/gcp-sa-key-XXXXXX.json")"
          echo "$GCP_SA_KEY" > "$KEY_FILE"
          chmod 600 "$KEY_FILE"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$KEY_FILE" >> $GITHUB_ENV
          echo "GCP_CREDENTIALS_DIR=$TMP_DIR" >> $GITHUB_ENV

      - name: Restore quota status
        env:
          QUOTA_STATUS_JSON: ${{ needs.check-current-quota.outputs.quota_status_json }}
        run: |
          printf '%s' "$QUOTA_STATUS_JSON" > quota_status.json
            --region $REGION \
            --output-json > quota_status.json

          echo "usage=$(jq -r '.usage' quota_status.json)" >> $GITHUB_OUTPUT
          echo "limit=$(jq -r '.limit' quota_status.json)" >> $GITHUB_OUTPUT

          cat quota_status.json

      - name: Request quota increase
        env:
          REGION: ${{ github.event.inputs.region }}
          CURRENT_LIMIT: ${{ github.event.inputs.current_limit }}
          REQUESTED_LIMIT: ${{ github.event.inputs.requested_limit }}
          JUSTIFICATION: ${{ github.event.inputs.justification }}
        run: |
          python3.11 scripts/increase_ssd_quota.py \
            --action request \
            --region "$REGION" \
            --current-limit "$CURRENT_LIMIT" \
            --requested-limit "$REQUESTED_LIMIT" \
            --justification "$JUSTIFICATION" \
            --output-json > quota_request.raw 2>&1

          awk 'BEGIN{capture=0} /^\{/{capture=1} { if (capture) { print > "quota_request.json" } else { print > "quota_request.log" } }' quota_request.raw
            --output-json > quota_request.json

          cat quota_request.json

          if [ ! -s quota_request.json ]; then
            echo "Failed to extract JSON payload from quota request output"
            echo "Full raw output from quota request command:"
            cat quota_request.raw
            exit 1
          fi

          echo "Quota request JSON payload:"
          cat quota_request.json

          if [ -s quota_request.log ]; then
            echo "Non-JSON output from quota request (for debugging):"
            cat quota_request.log
          fi
      - name: Create issue for tracking
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USAGE: ${{ steps.check-quota.outputs.usage }}
          REGION: ${{ github.event.inputs.region }}
          CURRENT_LIMIT: ${{ github.event.inputs.current_limit }}
          REQUESTED_LIMIT: ${{ github.event.inputs.requested_limit }}
          JUSTIFICATION: ${{ github.event.inputs.justification }}
          CURRENT_USAGE: ${{ needs.check-current-quota.outputs.current_usage }}
          REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3.11 <<'PY'
          import json
          import os
          import textwrap
          import urllib.error
          import urllib.request

          if not os.path.exists("quota_request.json"):
              raise FileNotFoundError("quota_request.json was not generated by the quota request step")

          with open("quota_request.json", "r", encoding="utf-8") as f:
              try:
                  request_data = json.load(f)
              except json.JSONDecodeError as exc:
                  raise RuntimeError("quota_request.json exists but contains invalid JSON") from exc

          body = textwrap.dedent(
              f"""\
              ## SSD Quota Increase Request

              **Region**: {os.environ['REGION']}
              **Current Limit**: {os.environ['CURRENT_LIMIT']} GB
              **Requested Limit**: {os.environ['REQUESTED_LIMIT']} GB
              **Current Usage**: {os.environ['CURRENT_USAGE']} GB

              **Justification**:
              {os.environ['JUSTIFICATION']}

              **Request ID**: `{request_data.get('request_id', 'N/A')}`
              **Status**: `{request_data.get('status', 'Submitted')}`

              ### Next Steps
              1. Monitor approval status in GCP Console
              2. Once approved, recreate production cluster
              3. Deploy production workloads

              ### References
              - [GCP Quotas Console](https://console.cloud.google.com/iam-admin/quotas?project=my-project-ops-1991)
              - [Quota Guide](docs/gcp-quota-guide.md)
              """
          ).strip()

          payload = json.dumps({
              "title": f"SSD Quota Increase Request - {os.environ['REGION']}",
              "body": body,
              "labels": ["quota", "infrastructure", "gcp"],
          }).encode("utf-8")

          req = urllib.request.Request(
              f"https://api.github.com/repos/{os.environ['REPOSITORY']}/issues",
              data=payload,
              method="POST",
              headers={
                  "Accept": "application/vnd.github+json",
                  "Authorization": f"Bearer {os.environ['GITHUB_TOKEN']}",
                  "X-GitHub-Api-Version": "2022-11-28",
                  "Content-Type": "application/json",
                  "User-Agent": "increase-ssd-quota-workflow",
              },
          )
          try:
              with urllib.request.urlopen(req) as resp:
                  issue = json.load(resp)
                  print(f"Issue created: {issue.get('html_url', 'unknown')}")
          except urllib.error.HTTPError as exc:
              error_body = exc.read().decode("utf-8", errors="replace")
              try:
                  error_json = json.loads(error_body)
                  error_message = error_json.get("message", error_body)
              except json.JSONDecodeError:
                  error_message = error_body
              raise RuntimeError(f"Failed to create issue: HTTP {exc.code} - {error_message}") from exc
          PY

      - name: Create GitHub issue for tracking
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USAGE: ${{ steps.check-quota.outputs.usage }}
          REGION: ${{ github.event.inputs.region }}
          CURRENT_LIMIT: ${{ github.event.inputs.current_limit }}
          REQUESTED_LIMIT: ${{ github.event.inputs.requested_limit }}
          JUSTIFICATION: ${{ github.event.inputs.justification }}
          CURRENT_USAGE: ${{ needs.check-current-quota.outputs.current_usage }}
          REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REQUEST_ID=$(jq -r '.request_id // "N/A"' quota_request.json)
          STATUS=$(jq -r '.status // "Submitted"' quota_request.json)

          printf '## SSD Quota Increase Request\n\n' > issue_body.txt
          printf '**Region**: %s\n' "$REGION" >> issue_body.txt
          printf '**Current Limit**: %s GB\n' "$CURRENT_LIMIT" >> issue_body.txt
          printf '**Requested Limit**: %s GB\n' "$REQUESTED_LIMIT" >> issue_body.txt
          printf '**Current Usage**: %s GB\n\n' "$USAGE" >> issue_body.txt
          printf '**Justification**:\n%s\n\n' "$JUSTIFICATION" >> issue_body.txt
          printf '**Request ID**: `%s`\n' "$REQUEST_ID" >> issue_body.txt
          printf '**Status**: `%s`\n\n' "$STATUS" >> issue_body.txt
          printf '### Next Steps\n' >> issue_body.txt
          printf '1. Monitor approval status in GCP Console\n' >> issue_body.txt
          printf '2. Once approved, recreate production cluster\n' >> issue_body.txt
          printf '3. Deploy production workloads\n\n' >> issue_body.txt
          printf '### References\n' >> issue_body.txt
          printf '- [GCP Quotas Console](https://console.cloud.google.com/iam-admin/quotas?project=my-project-ops-1991)\n' >> issue_body.txt
          printf '- [Quota Guide](docs/gcp-quota-guide.md)\n' >> issue_body.txt

          gh issue create \
            --title "SSD Quota Increase Request - ${REGION}" \
            --body-file issue_body.txt \
            --label "quota" \
            --label "infrastructure" \
            --label "gcp"

      - name: Notify on success
        if: success()
        run: |
          echo "Quota increase request submitted successfully"
          echo "Request ID: $(jq -r '.request_id' quota_request.json)"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quota Status (restored)" >> $GITHUB_STEP_SUMMARY
          cat quota_status.json >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quota Request" >> $GITHUB_STEP_SUMMARY
          cat quota_request.json >> $GITHUB_STEP_SUMMARY

      - name: Cleanup credentials
        if: always()
        run: |
          if [ -n "${GCP_CREDENTIALS_DIR+x}" ] && [ -n "$GCP_CREDENTIALS_DIR" ]; then
            rm -rf "$GCP_CREDENTIALS_DIR"
          fi

      - name: Cleanup credentials
        if: always()
        run: rm -f /tmp/gcp-sa-key.json
