name: auto-sync-deploy

on:
  workflow_run:
    workflows: ["Supply Chain Security Gate"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "production"
        type: choice
        options: ["staging", "production", "all"]
      skip_canary:
        description: "Skip canary SLO gate (emergency only)"
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]

permissions:
  contents: write
  issues: write
  pull-requests: write
  deployments: write
  id-token: write

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID || 'my-project-ops-1991' }}
  GKE_REGION: ${{ vars.GKE_REGION || 'asia-east1' }}
  GKE_CLUSTER_PRODUCTION: "eco-production"
  K8S_NAMESPACE_PRODUCTION: "eco-production"

jobs:
  gate-ci-passed:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Check CI workflow result
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
              echo "should_deploy=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          echo "should_deploy=true" >> "$GITHUB_OUTPUT"

  deploy:
    needs: gate-ci-passed
    if: needs.gate-ci-passed.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Deploy Placeholder
        run: echo "Deploying to ${{ github.event.inputs.environment || 'production' }}..."
