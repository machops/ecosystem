name: YAML Governance Lint
# Validates .qyaml governance blocks and checks for %YAML directives.
on:
  push:
    branches: [main]
    paths:
      - "**/*.qyaml"
      - "**/*.yaml"
      - "**/*.yml"
  pull_request:
    paths:
      - "**/*.qyaml"
      - "**/*.yaml"
      - "**/*.yml"
permissions:
  contents: read
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Validate .qyaml governance blocks
        run: |
          FAIL=0
          for f in $(find . -name "*.qyaml" -not -path "*/node_modules/*" -type f); do
            echo "Validating: $f"
            for block in document_metadata governance_info registry_binding vector_alignment_map; do
              if ! grep -q "${block}:" "$f"; then
                echo "  FAIL: Missing $block in $f"
                FAIL=1
              fi
            done
          done
          if [ "$FAIL" -eq 1 ]; then exit 1; fi
          echo "All .qyaml files valid"

      - name: Check no %YAML directive (GKE compatibility)
        run: |
          if grep -rn "^%YAML" --include="*.qyaml" --include="*.yaml" .; then
            echo "ERROR: %YAML directive found"
            exit 1
          fi
          echo "No %YAML directives found"

      - name: Validate YAML syntax for all workflow files
        run: |
          python3 << 'PYEOF'
          import yaml, os, sys
          fail = False
          for root, dirs, files in os.walk('.github/workflows'):
            for f in files:
              if f.endswith(('.yaml', '.yml')):
                path = os.path.join(root, f)
                try:
                  yaml.safe_load(open(path).read())
                  print('OK: ' + path)
                except Exception as e:
                  print('FAIL: ' + path + ' - ' + str(e))
                  fail = True
          sys.exit(1 if fail else 0)
          PYEOF
