name: Deploy Monitoring Stack

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      deploy_prometheus:
        description: 'Deploy Prometheus'
        required: false
        type: boolean
        default: true
      deploy_grafana:
        description: 'Deploy Grafana'
        required: false
        type: boolean
        default: true

env:
  GCP_PROJECT: my-project-ops-1991
  GCP_REGION: asia-east1

permissions:
  contents: read

jobs:
  deploy-monitoring:
    name: Deploy Monitoring Stack
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Install kubectl and gke-gcloud-auth-plugin
        run: |
          # Install kubectl
          sudo apt-get update -q
          sudo apt-get install -y kubectl
          # Add Google Cloud SDK apt source and install gke-gcloud-auth-plugin
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
          sudo apt-get update -q
          sudo apt-get install -y google-cloud-sdk-gke-gcloud-auth-plugin
          echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV
          echo "gke-gcloud-auth-plugin: $(gke-gcloud-auth-plugin --version 2>&1)"

      - name: Authenticate and get GKE credentials
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          TARGET_ENVIRONMENT: ${{ github.event.inputs.environment }}
          USE_GKE_GCLOUD_AUTH_PLUGIN: "True"
        run: |
          TMP_DIR="$(mktemp -d)"
          chmod 700 "$TMP_DIR"
          trap 'rm -rf "$TMP_DIR"' EXIT
          KEY_FILE="$(mktemp "$TMP_DIR/gcp-sa-key-XXXXXX.json")"
          echo "$GCP_SA_KEY" > "$KEY_FILE"
          chmod 600 "$KEY_FILE"
          gcloud auth activate-service-account --key-file="$KEY_FILE"
          gcloud config set project "$GCP_PROJECT"
          gcloud container clusters get-credentials "eco-$TARGET_ENVIRONMENT" --region "$GCP_REGION" --project "$GCP_PROJECT"

      - name: Create monitoring namespace
        run: |
          kubectl apply -f monitoring/k8s/namespace.yaml

      - name: Deploy Node Exporter
        run: |
          kubectl apply -f monitoring/k8s/node-exporter-daemonset.yaml

      - name: Deploy Prometheus
        if: github.event.inputs.deploy_prometheus == 'true'
        env:
          SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # Create secret with Supabase credentials
          kubectl create secret generic prometheus-secrets \
            --from-literal=SUPABASE_SECRET_KEY="$SUPABASE_SECRET_KEY" \
            --namespace=monitoring \
            --dry-run=client -o yaml | kubectl apply -f -

          # Deploy Prometheus
          kubectl apply -f monitoring/k8s/prometheus-deployment.yaml

      - name: Deploy Grafana
        if: github.event.inputs.deploy_grafana == 'true'
        env:
          GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
        run: |
          # Create secret with admin credentials
          kubectl create secret generic grafana-secrets \
            --from-literal=admin-user="admin" \
            --from-literal=admin-password="$GRAFANA_ADMIN_PASSWORD" \
            --namespace=monitoring \
            --dry-run=client -o yaml | kubectl apply -f -

          # Deploy Grafana
          kubectl apply -f monitoring/k8s/grafana-deployment.yaml

      - name: Wait for deployments
        run: |
          kubectl wait --for=condition=available --timeout=300s \
            deployment/prometheus -n monitoring || true
          kubectl wait --for=condition=available --timeout=300s \
            deployment/grafana -n monitoring || true

      - name: Verify deployments
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployments -n monitoring
          echo ""
          echo "=== Pod Status ==="
          kubectl get pods -n monitoring
          echo ""
          echo "=== Service Status ==="
          kubectl get services -n monitoring

      - name: Test Supabase metrics endpoint
        env:
          SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "=== Testing Supabase Metrics API ==="
          curl -s https://yrfxijooswpvdpdseswy.supabase.co/customer/v1/privileged/metrics \
            --user "service_role:$SUPABASE_SECRET_KEY" | head -20

      - name: Create deployment summary
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment }}
          DEPLOY_PROMETHEUS: ${{ github.event.inputs.deploy_prometheus }}
          DEPLOY_GRAFANA: ${{ github.event.inputs.deploy_grafana }}
        run: |
          echo "## Monitoring Stack Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${ENVIRONMENT}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Components" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Monitoring Namespace" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Node Exporter" >> $GITHUB_STEP_SUMMARY
          if [ "$DEPLOY_PROMETHEUS" == "true" ]; then
            echo "- ✅ Prometheus" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$DEPLOY_GRAFANA" == "true" ]; then
            echo "- ✅ Grafana" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Prometheus: http://prometheus.indestructibleeco.io" >> $GITHUB_STEP_SUMMARY
          echo "- Grafana: http://grafana.indestructibleeco.io" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Access Grafana and verify dashboards" >> $GITHUB_STEP_SUMMARY
          echo "2. Check Prometheus targets status" >> $GITHUB_STEP_SUMMARY
          echo "3. Configure alert notifications" >> $GITHUB_STEP_SUMMARY
