name: Weekly Chaos Drill

on:
  schedule:
    # Every Monday 02:00 UTC (off-peak for asia-east1)
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      drill:
        description: 'Drill to run (all | flagger | eventbus)'
        required: false
        default: 'all'

concurrency:
  group: chaos-drill
  cancel-in-progress: false

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_REGION: ${{ secrets.GKE_REGION }}
  # Scheduled time injected so drill scripts can compute cron drift
  DRILL_SCHEDULED_TIME: '2000-01-01T02:00:00Z'   # overridden per-job below

jobs:
  # ── Job 1: EventBus Cross-Zone Distribution Verification ─────────────────
  eventbus-zone-drill:
    name: EventBus Cross-Zone Distribution
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.drill == 'all' || github.event.inputs.drill == 'eventbus' || github.event_name == 'schedule' }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Record scheduled vs actual time
        id: timing
        run: |
          ACTUAL=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          # For schedule events, expected time is Monday 02:00 UTC of this week
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            SCHEDULED=$(python3 -c "from datetime import datetime,timezone,timedelta; now=datetime.now(timezone.utc); d=now.weekday(); m=(now-timedelta(days=d)).replace(hour=2,minute=0,second=0,microsecond=0); print(m.strftime('%Y-%m-%dT%H:%M:%SZ'))")
          else
            SCHEDULED="$ACTUAL"
          fi
          DRIFT_S=$(python3 -c "from datetime import datetime,timezone; fmt='%Y-%m-%dT%H:%M:%SZ'; s=datetime.strptime('$SCHEDULED',fmt).replace(tzinfo=timezone.utc); a=datetime.strptime('$ACTUAL',fmt).replace(tzinfo=timezone.utc); print(int((a-s).total_seconds()))")
          echo "scheduled=$SCHEDULED" >> $GITHUB_OUTPUT
          echo "actual=$ACTUAL" >> $GITHUB_OUTPUT
          echo "drift_s=$DRIFT_S" >> $GITHUB_OUTPUT
          echo "Scheduled: $SCHEDULED | Actual: $ACTUAL | Drift: ${DRIFT_S}s"
          if [[ "$DRIFT_S" -gt 3600 ]]; then
            echo "::warning::Cron drift ${DRIFT_S}s exceeds 1h — GitHub runner delay detected"
          fi

      - name: Authenticate to GCP
        uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@64bc7249bbcf78056bb92f14d3cedc2da193946c # v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER_NAME }}
          location: ${{ env.GKE_REGION }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Run EventBus zone distribution drill
        env:
          DRILL_SCHEDULED_TIME: ${{ steps.timing.outputs.scheduled }}
        run: |
          chmod +x tests/drill-eventbus-zone.sh
          bash tests/drill-eventbus-zone.sh

      - name: Upload full drill report (90d retention)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: drill-eventbus-zone-${{ github.run_number }}
          path: tests/reports/drill-eventbus-zone-*.json
          retention-days: 90

      - name: Commit drill-summary.json only
        if: always()
        run: |
          git config user.email "chaos-drill[bot]@indestructiblemachinen.com"
          git config user.name "chaos-drill[bot]"
          git add tests/reports/drill-summary.json || true
          git diff --cached --quiet || git commit -m "chore(drill): update drill-summary.json [skip ci]"
          git push origin HEAD:main || true

      - name: Assert PASS
        run: |
          python3 -c "
          import json, glob, sys
          files = sorted(glob.glob('tests/reports/drill-eventbus-zone-*.json'))
          if not files:
              print('ERROR: No report found'); sys.exit(1)
          report = json.load(open(files[-1]))
          result = report.get('gate_result', 'FAIL')
          resilience = report.get('zone_resilience', 'unknown')
          print(f'EventBus zone drill: {result} (zone_resilience={resilience})')
          if result != 'PASS':
              sys.exit(1)
          "

  # ── Job 2: Flagger Rollback Drill ────────────────────────────────────────
  flagger-rollback-drill:
    name: Flagger Rollback Drill
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.drill == 'all' || github.event.inputs.drill == 'flagger' || github.event_name == 'schedule' }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Record scheduled vs actual time
        id: timing
        run: |
          ACTUAL=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            SCHEDULED=$(python3 -c "from datetime import datetime,timezone,timedelta; now=datetime.now(timezone.utc); d=now.weekday(); m=(now-timedelta(days=d)).replace(hour=2,minute=0,second=0,microsecond=0); print(m.strftime('%Y-%m-%dT%H:%M:%SZ'))")
          else
            SCHEDULED="$ACTUAL"
          fi
          DRIFT_S=$(python3 -c "from datetime import datetime,timezone; fmt='%Y-%m-%dT%H:%M:%SZ'; s=datetime.strptime('$SCHEDULED',fmt).replace(tzinfo=timezone.utc); a=datetime.strptime('$ACTUAL',fmt).replace(tzinfo=timezone.utc); print(int((a-s).total_seconds()))")
          echo "scheduled=$SCHEDULED" >> $GITHUB_OUTPUT
          echo "actual=$ACTUAL" >> $GITHUB_OUTPUT
          echo "drift_s=$DRIFT_S" >> $GITHUB_OUTPUT
          echo "Scheduled: $SCHEDULED | Actual: $ACTUAL | Drift: ${DRIFT_S}s"
          if [[ "$DRIFT_S" -gt 3600 ]]; then
            echo "::warning::Cron drift ${DRIFT_S}s exceeds 1h"
          fi

      - name: Authenticate to GCP
        uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@64bc7249bbcf78056bb92f14d3cedc2da193946c # v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER_NAME }}
          location: ${{ env.GKE_REGION }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Run Flagger rollback drill
        env:
          DRILL_SCHEDULED_TIME: ${{ steps.timing.outputs.scheduled }}
        run: |
          chmod +x tests/drill-flagger-rollback.sh
          bash tests/drill-flagger-rollback.sh

      - name: Upload full drill report (90d retention)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: drill-flagger-rollback-${{ github.run_number }}
          path: tests/reports/drill-flagger-rollback-*.json
          retention-days: 90

      - name: Commit drill-summary.json only
        if: always()
        run: |
          git config user.email "chaos-drill[bot]@indestructiblemachinen.com"
          git config user.name "chaos-drill[bot]"
          git add tests/reports/drill-summary.json || true
          git diff --cached --quiet || git commit -m "chore(drill): update drill-summary.json [skip ci]"
          git push origin HEAD:main || true

      - name: Assert PASS
        run: |
          python3 -c "
          import json, glob, sys
          files = sorted(glob.glob('tests/reports/drill-flagger-rollback-*.json'))
          if not files:
              print('ERROR: No report found'); sys.exit(1)
          report = json.load(open(files[-1]))
          result = report.get('gate_result', 'FAIL')
          duration = report.get('canary', {}).get('rollback_duration_s', 'unknown')
          print(f'Flagger rollback drill: {result} (rollback_duration_s={duration})')
          if result != 'PASS':
              sys.exit(1)
          "

  # ── Job 3: Drill Summary + Issue deduplication ───────────────────────────
  drill-summary:
    name: Weekly Drill Summary
    runs-on: ubuntu-latest
    needs: [eventbus-zone-drill, flagger-rollback-drill]
    if: always()
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Summarize results
        id: summary
        run: |
          EB="${{ needs.eventbus-zone-drill.result }}"
          FL="${{ needs.flagger-rollback-drill.result }}"
          echo "eventbus=$EB" >> $GITHUB_OUTPUT
          echo "flagger=$FL" >> $GITHUB_OUTPUT
          echo "=== Weekly Chaos Drill Summary ==="
          echo "Run: ${{ github.run_number }}"
          echo "Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "EventBus Zone Drill:    $EB"
          echo "Flagger Rollback Drill: $FL"
          if [[ "$EB" != "success" ]] || [[ "$FL" != "success" ]]; then
            echo "STATUS: DEGRADED"
            echo "degraded=true" >> $GITHUB_OUTPUT
          else
            echo "STATUS: ALL PASS"
            echo "degraded=false" >> $GITHUB_OUTPUT
          fi

      # Issue deduplication: search for open issue with same drill+label within 7 days
      - name: Create or update GitHub issue on failure (deduplicated)
        if: steps.summary.outputs.degraded == 'true'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
            const title = `[CHAOS DRILL FAILED] Weekly drill`;

            // Search for existing open issue with same title created in last 7 days
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'chaos-drill',
              since: sevenDaysAgo,
              per_page: 10
            });

            const match = existing.data.find(i => i.title.startsWith('[CHAOS DRILL FAILED]'));

            const body = `## Weekly Chaos Drill Failure\n\n` +
              `**Run**: ${context.runNumber}\n` +
              `**Date**: ${new Date().toISOString()}\n\n` +
              `### Results\n` +
              `- EventBus Zone Drill: ${{ needs.eventbus-zone-drill.result }}\n` +
              `- Flagger Rollback Drill: ${{ needs.flagger-rollback-drill.result }}\n\n` +
              `### Action Required\n` +
              `Review drill logs and remediate before next deployment window.\n\n` +
              `[View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            if (match) {
              // Append comment to existing issue (no new issue flood)
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: match.number,
                body: `### Recurrence — Run #${context.runNumber}\n\n${body}`
              });
              console.log(`Appended to existing issue #${match.number}`);
            } else {
              // Create new issue (first failure in 7-day window)
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `${title} — run #${context.runNumber}`,
                body: body,
                labels: ['chaos-drill', 'incident', 'priority:high']
              });
              console.log('Created new issue');
            }

      - name: Fail job if degraded
        if: steps.summary.outputs.degraded == 'true'
        run: exit 1
