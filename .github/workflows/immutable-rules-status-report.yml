name: Immutable Rules Status Report

# Periodically checks immutable-rules-gate.yml execution history via GitHub API
# and generates a structured compliance report.
#
# Schedule: Every day at 06:00 UTC (non-peak, after weekly drill window)
# Triggers: schedule | workflow_dispatch | push to report scripts

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      lookback_days:
        description: 'Days of history to analyze (default: 30)'
        required: false
        default: '30'
      force_issue:
        description: 'Force create issue even if all rules pass'
        required: false
        default: 'false'
  push:
    branches: [main]
    paths:
      - 'tests/generate-immutable-rules-report.py'
      - '.github/workflows/immutable-rules-status-report.yml'

permissions:
  contents: write
  issues: write
  pull-requests: read

env:
  REPO: ${{ github.repository }}
  LOOKBACK_DAYS: ${{ github.event.inputs.lookback_days || '30' }}

jobs:
  generate-report:
    name: Generate Immutable Rules Compliance Report
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests python-dateutil

      - name: Record scheduled vs actual execution time
        id: timing
        run: |
          ACTUAL=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          # Expected: 06:00 UTC daily
          EXPECTED=$(date -u +%Y-%m-%dT06:00:00Z)
          ACTUAL_EPOCH=$(date -u -d "$ACTUAL" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$ACTUAL" +%s 2>/dev/null || echo 0)
          EXPECTED_EPOCH=$(date -u -d "$EXPECTED" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$EXPECTED" +%s 2>/dev/null || echo 0)
          DRIFT_S=$(( ACTUAL_EPOCH - EXPECTED_EPOCH ))
          DRIFT_ABS=${DRIFT_S#-}
          echo "actual_time=$ACTUAL" >> $GITHUB_OUTPUT
          echo "expected_time=$EXPECTED" >> $GITHUB_OUTPUT
          echo "drift_seconds=$DRIFT_S" >> $GITHUB_OUTPUT
          if [ "$DRIFT_ABS" -gt 3600 ]; then
            echo "::warning::Cron drift detected: ${DRIFT_S}s from expected 06:00 UTC"
          fi
          echo "drift_ok=$([ $DRIFT_ABS -le 3600 ] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Fetch immutable-rules-gate workflow runs
        id: fetch-runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 tests/generate-immutable-rules-report.py \
            --repo "$REPO" \
            --token "$GH_TOKEN" \
            --lookback-days "$LOOKBACK_DAYS" \
            --output-dir tests/reports \
            --actual-time "${{ steps.timing.outputs.actual_time }}" \
            --expected-time "${{ steps.timing.outputs.expected_time }}" \
            --drift-seconds "${{ steps.timing.outputs.drift_seconds }}"

      - name: Read report summary
        id: report
        run: |
          SUMMARY=$(cat tests/reports/immutable-rules-report-latest.json)
          python3 << 'PYEOF'
                    import sys,json; d=json.load(sys.stdin); print(d['summary']['overall_status'])
          PYEOF
          python3 << 'PYEOF'
                    import sys,json; d=json.load(sys.stdin); print(d['summary']['total_failures'])
          PYEOF
          python3 << 'PYEOF'
                    import sys,json; d=json.load(sys.stdin); print(d['summary']['pass_rate_pct'])
          PYEOF
          TOTAL_RUNS=$(echo "$SUMMARY" | python3 << 'PYEOF'
          TOTAL_RUNS=$(echo "$SUMMARY" |           TOTAL_RUNS=$(echo "$SUMMARY" |   import sys,json; d=json.load(sys.stdin); print(d['summary']['total_runs_analyzed'])
          TOTAL_RUNS=$(echo "$SUMMARY" |           TOTAL_RUNS=$(echo "$SUMMARY" | PYEOF
          TOTAL_RUNS=$(echo "$SUMMARY" |           )
          TOTAL_RUNS=$(echo "$SUMMARY" |           echo "overall=$OVERALL" >> $GITHUB_OUTPUT
          TOTAL_RUNS=$(echo "$SUMMARY" |           echo "fail_count=$FAIL_COUNT" >> $GITHUB_OUTPUT
          TOTAL_RUNS=$(echo "$SUMMARY" |           echo "pass_rate=$PASS_RATE" >> $GITHUB_OUTPUT
          TOTAL_RUNS=$(echo "$SUMMARY" |           echo "total_runs=$TOTAL_RUNS" >> $GITHUB_OUTPUT

          TOTAL_RUNS=$(echo "$SUMMARY" |           - name: Upload report as artifact
          TOTAL_RUNS=$(echo "$SUMMARY" |           uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
          TOTAL_RUNS=$(echo "$SUMMARY" |           with:
          TOTAL_RUNS=$(echo "$SUMMARY" |           name: immutable-rules-report-${{ steps.timing.outputs.actual_time }}
          TOTAL_RUNS=$(echo "$SUMMARY" |           path: tests/reports/immutable-rules-report-latest.json
          TOTAL_RUNS=$(echo "$SUMMARY" |           retention-days: 90

          TOTAL_RUNS=$(echo "$SUMMARY" |           - name: Commit updated report summary to repo
          TOTAL_RUNS=$(echo "$SUMMARY" |           run: |
          TOTAL_RUNS=$(echo "$SUMMARY" |           git config user.name "eco-ops-bot"
          TOTAL_RUNS=$(echo "$SUMMARY" |           git config user.email "eco-ops-bot@users.noreply.github.com"
          TOTAL_RUNS=$(echo "$SUMMARY" |           # Only commit the summary (not full timestamped report — kept as artifact)
          TOTAL_RUNS=$(echo "$SUMMARY" |           git add tests/reports/immutable-rules-summary.json || true
          TOTAL_RUNS=$(echo "$SUMMARY" |           git diff --staged --quiet || git commit -m "chore(report): update immutable-rules-summary [skip ci]"
          TOTAL_RUNS=$(echo "$SUMMARY" |           git push origin main || true

          TOTAL_RUNS=$(echo "$SUMMARY" |           - name: Create or update tracking issue on failure
          TOTAL_RUNS=$(echo "$SUMMARY" |           if: steps.report.outputs.overall == 'FAIL'
          TOTAL_RUNS=$(echo "$SUMMARY" |           uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7
          TOTAL_RUNS=$(echo "$SUMMARY" |           env:
          TOTAL_RUNS=$(echo "$SUMMARY" |           FAIL_COUNT: ${{ steps.report.outputs.fail_count }}
          TOTAL_RUNS=$(echo "$SUMMARY" |           PASS_RATE: ${{ steps.report.outputs.pass_rate }}
          TOTAL_RUNS=$(echo "$SUMMARY" |           TOTAL_RUNS: ${{ steps.report.outputs.total_runs }}
          TOTAL_RUNS=$(echo "$SUMMARY" |           ACTUAL_TIME: ${{ steps.timing.outputs.actual_time }}
          TOTAL_RUNS=$(echo "$SUMMARY" |           LOOKBACK: ${{ env.LOOKBACK_DAYS }}
          TOTAL_RUNS=$(echo "$SUMMARY" |           with:
          TOTAL_RUNS=$(echo "$SUMMARY" |           script: |
          TOTAL_RUNS=$(echo "$SUMMARY" |           const failCount = process.env.FAIL_COUNT;
          TOTAL_RUNS=$(echo "$SUMMARY" |           const passRate = process.env.PASS_RATE;
          TOTAL_RUNS=$(echo "$SUMMARY" |           const totalRuns = process.env.TOTAL_RUNS;
          TOTAL_RUNS=$(echo "$SUMMARY" |           const actualTime = process.env.ACTUAL_TIME;
          TOTAL_RUNS=$(echo "$SUMMARY" |           const lookback = process.env.LOOKBACK;

          TOTAL_RUNS=$(echo "$SUMMARY" |           // Dedup: search for open issue with same label within 7 days
          TOTAL_RUNS=$(echo "$SUMMARY" |           const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
          TOTAL_RUNS=$(echo "$SUMMARY" |           const existing = await github.rest.issues.listForRepo({
          TOTAL_RUNS=$(echo "$SUMMARY" |           owner: context.repo.owner,
          TOTAL_RUNS=$(echo "$SUMMARY" |           repo: context.repo.repo,
          TOTAL_RUNS=$(echo "$SUMMARY" |           labels: 'immutable-rules-failure,automated-report',
          TOTAL_RUNS=$(echo "$SUMMARY" |           state: 'open',
          TOTAL_RUNS=$(echo "$SUMMARY" |           since: sevenDaysAgo,
          TOTAL_RUNS=$(echo "$SUMMARY" |           });

          TOTAL_RUNS=$(echo "$SUMMARY" |           const body = `## Immutable Rules Gate — Compliance Report FAIL

          TOTAL_RUNS=$(echo "$SUMMARY" |           **Report generated:** ${actualTime}
          TOTAL_RUNS=$(echo "$SUMMARY" |           **Lookback period:** ${lookback} days
          TOTAL_RUNS=$(echo "$SUMMARY" |           **Total runs analyzed:** ${totalRuns}
          TOTAL_RUNS=$(echo "$SUMMARY" |           **Pass rate:** ${passRate}%
          TOTAL_RUNS=$(echo "$SUMMARY" |           **Failure count:** ${failCount}

          TOTAL_RUNS=$(echo "$SUMMARY" |           ### Action Required

          TOTAL_RUNS=$(echo "$SUMMARY" |           One or more \`immutable-rules-gate.yml\` jobs failed within the lookback period.
          TOTAL_RUNS=$(echo "$SUMMARY" |           Review the [workflow run history](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/immutable-rules-gate.yml) for details.

          TOTAL_RUNS=$(echo "$SUMMARY" |           ### Rules Reference

          TOTAL_RUNS=$(echo "$SUMMARY" |           | Rule | Description | Remediation |
          TOTAL_RUNS=$(echo "$SUMMARY" |           |------|-------------|-------------|
          TOTAL_RUNS=$(echo "$SUMMARY" |           | Rule-01 | EventBus zone resilience | Restore topologySpreadConstraints + zone affinity |
          TOTAL_RUNS=$(echo "$SUMMARY" |           | Rule-02 | PVC zone binding explicit | Pre-create PV with nodeAffinity before PVC |
          TOTAL_RUNS=$(echo "$SUMMARY" |           | Rule-03 | PolicyException expiry | Renew or remove expired exceptions |
          TOTAL_RUNS=$(echo "$SUMMARY" |           | Rule-04 | Flagger SLI thresholds | Revert threshold changes + attach drill report |
          TOTAL_RUNS=$(echo "$SUMMARY" |           | Rule-05 | Chaos drill cron active | Restore weekly-chaos-drill.yml cron schedule |

          TOTAL_RUNS=$(echo "$SUMMARY" |           > This issue is auto-managed. New failures within 7 days will append a comment instead of opening a new issue.`;

          TOTAL_RUNS=$(echo "$SUMMARY" |           if (existing.data.length > 0) {
          TOTAL_RUNS=$(echo "$SUMMARY" |           // Append comment to existing issue
          TOTAL_RUNS=$(echo "$SUMMARY" |           await github.rest.issues.createComment({
          TOTAL_RUNS=$(echo "$SUMMARY" |           owner: context.repo.owner,
          TOTAL_RUNS=$(echo "$SUMMARY" |           repo: context.repo.repo,
          TOTAL_RUNS=$(echo "$SUMMARY" |           issue_number: existing.data[0].number,
          TOTAL_RUNS=$(echo "$SUMMARY" |           body: `### Follow-up Failure — ${actualTime}\n\nPass rate: **${passRate}%** | Failures: **${failCount}** | Runs analyzed: **${totalRuns}**\n\nSee [workflow history](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/immutable-rules-gate.yml) for details.`,
          TOTAL_RUNS=$(echo "$SUMMARY" |           });
          TOTAL_RUNS=$(echo "$SUMMARY" |           } else {
          TOTAL_RUNS=$(echo "$SUMMARY" |           // Open new issue
          TOTAL_RUNS=$(echo "$SUMMARY" |           await github.rest.issues.create({
          TOTAL_RUNS=$(echo "$SUMMARY" |           owner: context.repo.owner,
          TOTAL_RUNS=$(echo "$SUMMARY" |           repo: context.repo.repo,
          TOTAL_RUNS=$(echo "$SUMMARY" |           title: `[AUTO] Immutable Rules Gate failures detected (${actualTime})`,
          TOTAL_RUNS=$(echo "$SUMMARY" |           body: body,
          TOTAL_RUNS=$(echo "$SUMMARY" |           labels: ['immutable-rules-failure', 'automated-report', 'priority:high'],
          TOTAL_RUNS=$(echo "$SUMMARY" |           });
          TOTAL_RUNS=$(echo "$SUMMARY" |           }

          TOTAL_RUNS=$(echo "$SUMMARY" |           - name: Post pass summary as workflow annotation
          TOTAL_RUNS=$(echo "$SUMMARY" |           if: steps.report.outputs.overall == 'PASS'
          TOTAL_RUNS=$(echo "$SUMMARY" |           run: |
          TOTAL_RUNS=$(echo "$SUMMARY" |           echo "::notice title=Immutable Rules Gate PASS::Pass rate: ${{ steps.report.outputs.pass_rate }}% | Runs: ${{ steps.report.outputs.total_runs }} | Failures: ${{ steps.report.outputs.fail_count }} | Period: ${LOOKBACK_DAYS}d"

          TOTAL_RUNS=$(echo "$SUMMARY" |           - name: Fail workflow if overall status is FAIL
          TOTAL_RUNS=$(echo "$SUMMARY" |           if: steps.report.outputs.overall == 'FAIL'
          TOTAL_RUNS=$(echo "$SUMMARY" |           run: |
          TOTAL_RUNS=$(echo "$SUMMARY" |           echo "ERROR: Immutable Rules Gate compliance report — FAIL"
          TOTAL_RUNS=$(echo "$SUMMARY" |           echo "Pass rate: ${{ steps.report.outputs.pass_rate }}%"
          TOTAL_RUNS=$(echo "$SUMMARY" |           echo "Failures: ${{ steps.report.outputs.fail_count }} in last ${LOOKBACK_DAYS} days"
          TOTAL_RUNS=$(echo "$SUMMARY" |           exit 1
