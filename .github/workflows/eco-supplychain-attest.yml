name: eco-supplychain-attest

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: write
  id-token: write

jobs:
  attest:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Install cosign
        uses: sigstore/cosign-installer@053f9b74638557590800a301da1ba82351507e2c # v3.8.1

      - name: Setup Python
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 # v5.4.0
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Regenerate hashlock (authoritative on main)
        run: |
          python tools/eco-supplychain/hashlock.py \
            --mode update \
            --paths platforms k8s manifests \
            --hashlock supplychain/hashlock.json

      - name: Keyless sign hashlock.json (cosign sign-blob) -> hashlock.sig + hashlock.pem
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          set -euo pipefail
          cosign version
          mkdir -p supplychain
          # Keyless signing via GitHub OIDC (no private key in repo)
          cosign sign-blob \
            --yes \
            --output-signature supplychain/hashlock.sig \
            --output-certificate supplychain/hashlock.pem \
            supplychain/hashlock.json

      - name: Generate in-toto attestation for hashlock.json
        env:
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
        run: |
          python tools/eco-supplychain/attest.py \
            --hashlock supplychain/hashlock.json \
            --out supplychain/hashlock.attestation.intoto.json

      - name: Verify cosign signature (verify-blob gate)
        env:
          COSIGN_EXPERIMENTAL: "true"
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          # Expected identity binds signature to THIS workflow on main branch
          IDENTITY="https://github.com/${GITHUB_REPOSITORY}/.github/workflows/eco-supplychain-attest.yml@refs/heads/main"
          cosign verify-blob \
            --certificate supplychain/hashlock.pem \
            --signature supplychain/hashlock.sig \
            --certificate-identity "${IDENTITY}" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            supplychain/hashlock.json

      - name: Verify attestation binds to hashlock
        run: |
          python tools/eco-supplychain/verify_attestation.py \
            --hashlock supplychain/hashlock.json \
            --attestation supplychain/hashlock.attestation.intoto.json

      - name: Commit attestation + hashlock (if changed)
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name  "eco-supplychain-bot"
          git config user.email "eco-supplychain-bot@users.noreply.github.com"
          git add -A
          git commit -m "chore(eco): update hashlock + attestation + signature [ci]"
          git push

      - name: Upload supplychain evidence
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: eco-supplychain-evidence
          path: |
            supplychain/hashlock.json
            supplychain/hashlock.attestation.intoto.json
            supplychain/hashlock.sig
            supplychain/hashlock.pem
