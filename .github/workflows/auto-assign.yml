name: Auto Assign 2.0 Â· è‡ªä¸»æ¼”åŒ–æ±ºç­–ç‰ˆ
on:
  issues:
    types: [opened]
  pull_request_target:
    types: [opened]

jobs:
  intelligent-assign:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      # æ­¥é©Ÿ1ï¼šæ“·å– Issue/PR çš„ä¸Šä¸‹æ–‡ï¼ˆæ¨™é¡Œã€å…§å®¹ã€æ¨™ç±¤ã€æª”æ¡ˆè®Šæ›´ç­‰ï¼‰
      - name: å–å¾— Issue/PR å…ƒè³‡æ–™
        id: context
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const payload = context.payload;
            let assignContext = {};
            if (payload.issue) {
              assignContext.type = 'issue';
              assignContext.number = payload.issue.number;
              assignContext.title = payload.issue.title;
              assignContext.body = payload.issue.body;
              assignContext.labels = payload.issue.labels.map(l => l.name);
              assignContext.author = payload.issue.user.login;
            } else if (payload.pull_request) {
              assignContext.type = 'pull_request';
              assignContext.number = payload.pull_request.number;
              assignContext.title = payload.pull_request.title;
              assignContext.body = payload.pull_request.body;
              assignContext.labels = payload.pull_request.labels.map(l => l.name);
              assignContext.author = payload.pull_request.user.login;
              
              // ç‰¹åˆ¥ç‚º PR å–å¾—ä¿®æ”¹çš„æª”æ¡ˆæ¸…å–®ï¼ˆåˆ©æ–¼ CODEOWNERS æŒ‡æ´¾ï¼‰
              const files = await github.paginate(github.rest.pulls.listFiles, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: assignContext.number,
                per_page: 100
              });
              assignContext.files = files.map(f => f.filename);
            }
            core.setOutput('payload', JSON.stringify(assignContext));

      # æ­¥é©Ÿ2ï¼šæ™ºèƒ½æ±ºç­–æŒ‡æ´¾äººé¸ï¼ˆåŸºæ–¼è¦å‰‡çš„è‡ªå‹•åˆ†é…ï¼‰
      - name: æ±ºå®šæœ€ä½³æŒ‡æ´¾äººé¸
        id: decision
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          ASSIGN_CONTEXT: ${{ steps.context.outputs.payload }}
        with:
          script: |
            const payload = context.payload;
            const assignContext = JSON.parse(process.env.ASSIGN_CONTEXT);
            
            // å®šç¾©é è¨­ç¶­è­·è€…
            const defaultMaintainer = 'IndestructibleAutoOps';
            
            let assignee = '';
            let reason = '';
            
            // è¦å‰‡1: åŸºæ–¼æ¨™ç±¤çš„æŒ‡æ´¾
            if (assignContext.labels && assignContext.labels.length > 0) {
              const labelMap = {
                'bug': defaultMaintainer,
                'enhancement': defaultMaintainer,
                'documentation': defaultMaintainer,
                'question': defaultMaintainer
              };
              
              for (const label of assignContext.labels) {
                if (labelMap[label]) {
                  assignee = labelMap[label];
                  reason = `æ ¹æ“šæ¨™ç±¤ã€Œ${label}ã€è‡ªå‹•æŒ‡æ´¾çµ¦å°ˆè²¬æˆå“¡`;
                  break;
                }
              }
            }
            
            // è¦å‰‡2: åŸºæ–¼æª”æ¡ˆè®Šæ›´çš„æŒ‡æ´¾ (for PRs)
            if (!assignee && assignContext.type === 'pull_request' && assignContext.files) {
              const filePatterns = [
                { pattern: /\.github\/workflows\//, reason: 'æ­¤ PR æ¶‰åŠå·¥ä½œæµç¨‹è®Šæ›´ï¼Œç”±ç¶­è­·è€…å¯©æ ¸' },
                { pattern: /\.(json|yml|yaml)$/i, reason: 'æ­¤ PR åŒ…å«è¨­å®šæª”è®Šæ›´' },
                { pattern: /\.(md|txt)$/i, reason: 'æ­¤ PR åŒ…å«æ–‡ä»¶è®Šæ›´' },
                { pattern: /\.(js|ts|py|java|go)$/i, reason: 'æ­¤ PR åŒ…å«ç¨‹å¼ç¢¼è®Šæ›´' }
              ];
              
              for (const file of assignContext.files) {
                for (const { pattern, reason: fileReason } of filePatterns) {
                  if (pattern.test(file)) {
                    assignee = defaultMaintainer;
                    reason = fileReason;
                    break;
                  }
                }
                if (assignee) break;
              }
            }
            
            // è¦å‰‡3: åŸºæ–¼é—œéµå­—çš„æŒ‡æ´¾
            if (!assignee) {
              const title = assignContext.title.toLowerCase();
              const body = (assignContext.body || '').toLowerCase();
              const content = title + ' ' + body;
              
              if (content.includes('urgent') || content.includes('ç·Šæ€¥') || content.includes('critical')) {
                assignee = defaultMaintainer;
                reason = 'ç·Šæ€¥äº‹é …ï¼Œå„ªå…ˆæŒ‡æ´¾çµ¦æ ¸å¿ƒç¶­è­·è€…';
              } else if (content.includes('@indestructibleautoops')) {
                assignee = defaultMaintainer;
                reason = 'æ˜ç¢ºæåŠç¶­è­·è€…';
              }
            }
            
            // é è¨­è¦å‰‡ï¼šæŒ‡æ´¾çµ¦é è¨­ç¶­è­·è€…
            if (!assignee) {
              assignee = defaultMaintainer;
              reason = 'æ ¹æ“šé è¨­è¦å‰‡æŒ‡æ´¾çµ¦æ ¸å¿ƒç¶­è­·è€…';
            }
            
            core.setOutput('assignees', assignee);
            core.setOutput('reason', reason);

      # æ­¥é©Ÿ3ï¼šåŸ·è¡ŒæŒ‡æ´¾
      - name: 'è‡ªå‹•æŒ‡æ´¾ Issue/PR'
        uses: pozil/auto-assign-issue@39c06395cbac76e79afc4ad4e5c5c6db6ecfdd2e # v2.2.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          assignees: ${{ steps.decision.outputs.assignees }}
          numOfAssignee: 1

      # æ­¥é©Ÿ4ï¼šç•™ä¸‹æ±ºç­–è¨»è§£ï¼ˆå¢åŠ é€æ˜åº¦ï¼‰
      - name: ç•™è¨€èªªæ˜æŒ‡æ´¾åŸå› 
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const reason = '${{ steps.decision.outputs.reason }}';
            const assignee = '${{ steps.decision.outputs.assignees }}';
            
            let commentBody = `ğŸ¤– **AutoEcoOps è‡ªå‹•æŒ‡æ´¾**\n\n`;
            commentBody += `æ ¹æ“šæœ¬æ¬¡ ${context.payload.issue ? 'Issue' : 'Pull Request'} çš„åˆ†æï¼Œ`;
            commentBody += `æœ€ä½³æŒ‡æ´¾äººç‚º **@${assignee}**ã€‚\n\n`;
            commentBody += `**æ±ºç­–åŸå› **ï¼š${reason}\n\n`;
            commentBody += `> è‹¥æŒ‡æ´¾ä¸æ­£ç¢ºï¼Œè«‹ç•™è¨€ @IndestructibleAutoOps é‡æ–°è©•ä¼°ã€‚`;
            
            if (context.payload.issue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentBody
              });
            }

