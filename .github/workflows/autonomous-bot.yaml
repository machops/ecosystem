name: Autonomous Bot — Detect → Issue → Branch → Fix → PR → Merge
on:
  workflow_run:
    workflows: ["eco-base CI/CD"]
    types: [completed]
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no branch/PR/merge created)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: read

concurrency:
  group: autonomous-bot-${{ github.ref }}
  cancel-in-progress: false

env:
  DRY_RUN: ${{ inputs.dry_run || 'false' }}

jobs:
  detect:
    name: Detect All Actionable Problems
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      has_problems: ${{ steps.scan.outputs.has_problems }}
      problems_json: ${{ steps.scan.outputs.problems_json }}
      problem_count: ${{ steps.scan.outputs.problem_count }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 10

      - name: Scan for all problems
        id: scan
        env:
          GITHUB_TOKEN: ${{ github.token }}
          CI_CONCLUSION: ${{ github.event.workflow_run.conclusion }}
        run: python3 tools/autonomous-bot/detect.py

  create-issues:
    name: Create GitHub Issues
    needs: detect
    if: needs.detect.outputs.has_problems == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      issues_created: ${{ steps.create.outputs.issues_created }}
      issue_map_json: ${{ steps.create.outputs.issue_map_json }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Create issues (deduplicated)
        id: create
        env:
          GITHUB_TOKEN: ${{ github.token }}
          PROBLEMS_JSON: ${{ needs.detect.outputs.problems_json }}
          DRY_RUN: ${{ env.DRY_RUN }}
        run: python3 tools/autonomous-bot/create_issues.py

  fix-and-branch:
    name: Create Fix Branch and Apply Fixes
    needs: [detect, create-issues]
    if: needs.detect.outputs.has_problems == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      branch_name: ${{ steps.fix.outputs.branch_name }}
      has_fixes: ${{ steps.fix.outputs.has_fixes }}
      fixes_summary: ${{ steps.fix.outputs.fixes_summary }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 5
          token: ${{ secrets.AUTO_FIX_TOKEN || github.token }}

      - name: Apply fixes on new branch
        id: fix
        env:
          GITHUB_TOKEN: ${{ secrets.AUTO_FIX_TOKEN || github.token }}
          PROBLEMS_JSON: ${{ needs.detect.outputs.problems_json }}
          DRY_RUN: ${{ env.DRY_RUN }}
        run: python3 tools/autonomous-bot/fix_and_branch.py

  open-pr:
    name: Open Pull Request
    needs: [detect, create-issues, fix-and-branch]
    if: needs.fix-and-branch.outputs.has_fixes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      pr_number: ${{ steps.pr.outputs.pr_number }}
      pr_url: ${{ steps.pr.outputs.pr_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Create PR with best-practice description
        id: pr
        env:
          GITHUB_TOKEN: ${{ github.token }}
          BRANCH_NAME: ${{ needs.fix-and-branch.outputs.branch_name }}
          FIXES_SUMMARY: ${{ needs.fix-and-branch.outputs.fixes_summary }}
          PROBLEM_COUNT: ${{ needs.detect.outputs.problem_count }}
          ISSUE_MAP_JSON: ${{ needs.create-issues.outputs.issue_map_json }}
          DRY_RUN: ${{ env.DRY_RUN }}
        run: python3 tools/autonomous-bot/open_pr.py

  auto-merge:
    name: Auto-Merge PR When CI Passes
    needs: [open-pr]
    if: |
      needs.open-pr.outputs.pr_number != '' &&
      needs.open-pr.outputs.pr_number != '0'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Wait for CI and auto-merge
        env:
          GITHUB_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ needs.open-pr.outputs.pr_number }}
          PROBLEMS_JSON: ${{ needs.detect.outputs.problems_json }}
          DRY_RUN: ${{ env.DRY_RUN }}
        run: python3 tools/autonomous-bot/auto_merge.py

  audit-log:
    name: Write Audit Log
    needs: [detect, create-issues, fix-and-branch, open-pr, auto-merge]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Write audit entry
        env:
          PROBLEM_COUNT: ${{ needs.detect.outputs.problem_count }}
          ISSUES_CREATED: ${{ needs.create-issues.outputs.issues_created }}
          HAS_FIXES: ${{ needs.fix-and-branch.outputs.has_fixes }}
          PR_NUMBER: ${{ needs.open-pr.outputs.pr_number }}
          PR_URL: ${{ needs.open-pr.outputs.pr_url }}
        run: |
          python3 -c '
          import json, os
          from datetime import datetime, timezone
          entry = {
              "timestamp": datetime.now(timezone.utc).isoformat(),
              "run_id": os.environ.get("GITHUB_RUN_ID", ""),
              "trigger": os.environ.get("GITHUB_EVENT_NAME", ""),
              "problems_detected": int(os.environ.get("PROBLEM_COUNT", "0") or "0"),
              "issues_created": int(os.environ.get("ISSUES_CREATED", "0") or "0"),
              "fixes_applied": os.environ.get("HAS_FIXES", "false") == "true",
              "pr_number": os.environ.get("PR_NUMBER", ""),
              "pr_url": os.environ.get("PR_URL", ""),
              "actor": "autonomous-bot",
              "compliance_tags": ["SOC2", "ISO27001", "audit-trail"],
          }
          print(json.dumps(entry, indent=2))
          '
