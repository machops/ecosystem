name: Dependabot Auto-Merge
# Automatically merges Dependabot PRs when all required CI checks pass.
# Delegates to the unified autonomous PR engine (diagnose.py) for all decisions.
# External checks (Codacy/SonarCloud/CodeQL/Trivy/Copilot) are IGNORED.
# Only internal checks matter: validate/lint/test/build/opa-policy/supply-chain
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_run:
    workflows: ["eco-base CI/CD"]
    types: [completed]
  schedule:
    - cron: "*/15 * * * *"
permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read
  statuses: read
  actions: read
concurrency:
  group: dependabot-auto-merge-${{ github.ref || github.run_id }}
  cancel-in-progress: false
jobs:
  auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          token: ${{ secrets.AUTO_FIX_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.13"

      - name: Label major Dependabot updates for human review
        if: |
          github.event_name == 'pull_request' &&
          github.actor == 'dependabot[bot]'
        run: |
          python3 - << 'PYEOF'
          import subprocess, os, json

          pr_num = os.environ.get("PR_NUMBER", "")
          repo   = os.environ.get("REPO", "")
          if not pr_num or not repo:
              exit(0)

          # Check if this is a major version bump via dependabot metadata
          r = subprocess.run(
              ["gh", "pr", "view", pr_num, "--repo", repo,
               "--json", "title,labels"],
              capture_output=True, text=True
          )
          if r.returncode != 0:
              exit(0)
          pr = json.loads(r.stdout)
          title = pr.get("title", "").lower()
          labels = [l["name"] for l in pr.get("labels", [])]

          # Major bumps: title contains "bump X from Y to Z" where major version changes
          # Simple heuristic: if "from 1." to "2." etc.
          import re
          m = re.search(r"from (\d+)\.\S+ to (\d+)\.", title)
          if m and m.group(1) != m.group(2):
              if "human-review-required" not in labels:
                  subprocess.run(["gh", "pr", "edit", pr_num, "--repo", repo,
                                  "--add-label", "human-review-required"],
                                 capture_output=True)
                  print(f"Labeled PR #{pr_num} as human-review-required (major bump)")
          PYEOF
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.AUTO_FIX_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Run autonomous PR engine
        env:
          GH_TOKEN: ${{ secrets.AUTO_FIX_TOKEN || secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          SPECIFIC_PR: ${{ github.event.pull_request.number || '' }}
        run: python3 tools/pr-blocked-response/diagnose.py
