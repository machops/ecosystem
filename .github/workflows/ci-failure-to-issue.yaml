name: Centralized CI Failure Diagnostics

on:
  workflow_run:
    workflows: ["eco-base CI/CD"]
    types: [completed]

permissions:
  contents: read
  issues: write
  actions: read

jobs:
  on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Aggregate Failures and Create Centralized Report
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.event.workflow_run.id }}
        run: |
          PR_NUMBER=$(gh api /repos/$REPO/actions/runs/$RUN_ID --jq '.pull_requests[0].number // "main"')
          FAILED_JOBS=$(gh api /repos/$REPO/actions/runs/$RUN_ID/jobs --jq '[.jobs[] | select(.conclusion=="failure") | {name: .name, id: .id, url: .html_url}]')

          if [ "$(echo "$FAILED_JOBS" | jq '. | length')" -eq 0 ]; then
            echo "No failed jobs found in metadata. Exiting."
            exit 0
          fi

          REPORT_TITLE="[CI Health Report] Failures in Run for PR #${PR_NUMBER}"
          REPORT_BODY="## 集中化 CI 失敗診斷報告\n\n- **觸發來源**: PR #${PR_NUMBER}\n- **Workflow Run**: [View Run](https://github.com/$REPO/actions/runs/$RUN_ID)\n- **診斷時間**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")\n\n### 失敗閘門摘要\n\n| Gate Name | Status | View Logs |\n|---|---|---|"

          FAILURE_DETAILS=""

          echo "$FAILED_JOBS" | jq -c '.[]' | while read -r job; do
            JOB_NAME=$(echo "$job" | jq -r '.name')
            JOB_ID=$(echo "$job" | jq -r '.id')
            JOB_URL=$(echo "$job" | jq -r '.url')

            REPORT_BODY+="\n| **${JOB_NAME}** | ❌ Failed | [Link](${JOB_URL}) |"

            LOGS=$(gh api /repos/$REPO/actions/jobs/$JOB_ID/logs | tail -n 50)
            FAILURE_DETAILS+="\n\n---\n\n### 閘門: ${JOB_NAME}\n\n**錯誤日誌 (最後 50 行):**\n\`\`\`\n${LOGS}\n\`\`\`"
          done

          FINAL_BODY="${REPORT_BODY}${FAILURE_DETAILS}"

          # 使用 Run ID 進行重複數據刪除
          EXISTING_ISSUE=$(gh issue list --repo $REPO --label "ci-health-report" --search "in:title ${RUN_ID}" --state open --json number --jq '.[0].number')

          if [ -n "$EXISTING_ISSUE" ]; then
            echo "Updating existing health report: #$EXISTING_ISSUE"
            gh issue comment $EXISTING_ISSUE --repo $REPO --body "**Update**: New failures detected in the same run.\n\n${FINAL_BODY}"
          else
            echo "Creating new centralized health report."
            gh issue create --repo $REPO \
              --title "$REPORT_TITLE" \
              --body "$FINAL_BODY" \
              --label "ci-health-report,bug,needs-attention" \
              --assignee "AutoEcoOps-Bot"
          fi
