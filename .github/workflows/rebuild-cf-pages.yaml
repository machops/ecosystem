name: Rebuild Cloudflare Pages
# Verifies the eco-base Pages project exists and reports its status.
on:
  workflow_dispatch:
permissions:
  contents: read
jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Verify eco-base Pages project
        run: |
          curl -s \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/eco-base" \
            -o /tmp/cf_result.json
          python3 << 'PY'
          import json, sys
          with open('/tmp/cf_result.json') as f:
              d = json.load(f)
          if d.get('success'):
              p = d['result']
              print('Project:  ', p.get('name'))
              print('Subdomain:', p.get('subdomain'))
              print('Branch:   ', p.get('production_branch'))
              print('Status:    OK')
          else:
              print('ERROR:', d.get('errors'))
              sys.exit(1)
          PY


      - name: List recent deployments
        run: |
          curl -s \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/eco-base/deployments?per_page=3" \
            -o /tmp/deployments.json
          python3 << 'PY'
          import json
          with open('/tmp/deployments.json') as f:
              d = json.load(f)
          for dep in d.get('result', []):
              status = dep.get('latest_stage', {}).get('status', 'unknown')
              print(f"  {status:10} {dep.get('url')} ({dep.get('created_on','')[:10]})")
          PY
