name: eco-supplychain-hashlock

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

permissions:
  contents: write
  pull-requests: write

jobs:
  supply-chain-governance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # 如果是 PR，則切換到 PR 的 head 分支以利回寫
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || github.ref }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Block manual edits of eco-base/urn and eco-base/uri
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          git fetch origin ${{ github.base_ref }} --depth=1
          # 找出 PR 相對 base 的變更，若直接改 urn/uri，先標記
          if git diff origin/${{ github.base_ref }}...HEAD -U0 | grep -E '^\+.*eco-base/(urn|uri):|^-.*eco-base/(urn|uri):' >/dev/null; then
            # 若這次 commit 作者不是 bot，就 fail（防手填）
            AUTHOR="$(git log -1 --pretty=format:'%an <%ae>')"
            if echo "$AUTHOR" | grep -qi 'eco-supplychain-bot'; then
              echo "OK: urn/uri change authored by supplychain bot."
            else
              echo "ERROR: manual edits to eco-base/urn or eco-base/uri are forbidden. Run hashlock update (CI/bot) instead."
              exit 1
            fi
          fi

      - name: Update URN/URI and Hashlock (PR only)
        if: github.event_name == 'pull_request'
        run: |
          python tools/eco-supplychain/hashlock.py --mode update --paths platforms/ k8s/ manifests/
          
          # 檢查是否有變更並自動 commit 回 PR 分支
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "eco-supplychain-bot"
            git config user.email "eco-supplychain-bot@users.noreply.github.com"
            git add .
            git commit -m "chore(supplychain): auto-update URN/URI and hashlock.json"
            git push
          else
            echo "No supply chain drift detected."
          fi

      - name: Verify Hashlock (Push to main or PR check)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          python tools/eco-supplychain/hashlock.py --mode verify --paths platforms/ k8s/ manifests/
