name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      run: |
        git clone --depth 1 https://github.com/${{ github.repository }}.git .
        git fetch --tags
        git checkout ${{ github.ref_name }}

    - name: Extract version from tag
      id: version
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        VERSION="${TAG#v}"
        echo "tag=$TAG" >> "$GITHUB_OUTPUT"
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"

    - name: Extract changelog for this version
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        awk '/^## \['"$VERSION"'\]/{found=1; next} /^## \[/{if(found) exit} found{print}' CHANGELOG.md > /tmp/release-notes.md
        if [ ! -s /tmp/release-notes.md ]; then
          echo "Release ${{ steps.version.outputs.tag }}" > /tmp/release-notes.md
        fi
        cat /tmp/release-notes.md

    - name: Generate SBOM artifact
      run: |
        cp sbom.json indestructibleeco-sbom-${{ steps.version.outputs.version }}.json

    - name: Create GitHub Release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create "${{ steps.version.outputs.tag }}" \
          --title "IndestructibleEco ${{ steps.version.outputs.tag }}" \
          --notes-file /tmp/release-notes.md \
          indestructibleeco-sbom-${{ steps.version.outputs.version }}.json
