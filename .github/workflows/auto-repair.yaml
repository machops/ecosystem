# IndestructibleEco v1.0 — Auto-Repair Workflow
# URI: indestructibleeco://workflows/auto-repair
#
# Triggered when CI/CD pipeline fails. Runs diagnostic analysis,
# identifies auto-fixable issues, and generates repair reports.
#
# GitOps integration: Argo CD picks up any committed fixes automatically.
name: Auto-Repair

on:
  workflow_run:
    workflows: ["IndestructibleEco CI/CD"]
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  diagnose:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.workflow_run.conclusion == 'failure'
    steps:
    - name: Checkout (failed commit)
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      with:
        ref: ${{ github.event.workflow_run.head_sha }}
        fetch-depth: 5

    - name: Collect failure context
      id: context
      run: |
        echo "=== Failure Context ==="
        echo "Run ID: ${{ github.event.workflow_run.id }}"
        echo "Commit: ${{ github.event.workflow_run.head_sha }}"
        echo "Branch: ${{ github.event.workflow_run.head_branch }}"
        echo "Trigger: ${{ github.event.workflow_run.event }}"
        echo ""
        echo "commit_sha=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"
        echo "run_id=${{ github.event.workflow_run.id }}" >> "$GITHUB_OUTPUT"

    - name: Run CI Validator Engine (diagnostic)
      id: validator
      run: |
        echo "=== CI Validator Diagnostic ==="
        python3 tools/ci-validator/validate.py --report=/tmp/validator-report.json || true
        if [ -f /tmp/validator-report.json ]; then
          cat /tmp/validator-report.json | python3 -m json.tool
        fi

    - name: Run Auto-Fix Engine (analysis)
      id: autofix
      run: |
        echo "=== Auto-Fix Analysis ==="
        python3 tools/ci-validator/auto-fix.py --dry-run --report=/tmp/autofix-report.json || true
        if [ -f /tmp/autofix-report.json ]; then
          cat /tmp/autofix-report.json | python3 -m json.tool
        fi

    - name: Fetch failed job logs
      run: |
        echo "=== Failed Job Logs ==="
        RUN_ID="${{ steps.context.outputs.run_id }}" \
        GITHUB_TOKEN="${{ github.token }}" \
        python3 - << 'PYEOF'
        import json, os, urllib.request
        run_id = os.environ.get("RUN_ID", "")
        repo = os.environ.get("GITHUB_REPOSITORY", "")
        token = os.environ.get("GITHUB_TOKEN", "")
        if not all([run_id, repo, token]):
            print("Missing environment variables for log fetch")
            exit(0)
        url = f"https://api.github.com/repos/{repo}/actions/runs/{run_id}/jobs"
        req = urllib.request.Request(url, headers={
            "Authorization": f"token {token}",
            "Accept": "application/vnd.github.v3+json",
        })
        try:
            with urllib.request.urlopen(req) as resp:
                data = json.loads(resp.read())
                failed_jobs = [j for j in data.get("jobs", []) if j.get("conclusion") == "failure"]
                for job in failed_jobs:
                    print(f"\n--- Failed Job: {job['name']} ---")
                    for step in job.get("steps", []):
                        if step.get("conclusion") == "failure":
                            print(f"  Failed Step: {step['name']}")
                            print(f"  Started: {step.get('started_at', 'N/A')}")
                            print(f"  Completed: {step.get('completed_at', 'N/A')}")
                if not failed_jobs:
                    print("No failed jobs found in this run")
        except Exception as e:
            print(f"Could not fetch logs: {e}")
        PYEOF

    - name: Generate repair report
      run: |
        RUN_ID="${{ steps.context.outputs.run_id }}" \
        COMMIT_SHA="${{ steps.context.outputs.commit_sha }}" \
        python3 - << 'PYEOF'
        import json, os
        from datetime import datetime, timezone
        report = {
            "timestamp": datetime.now(timezone.utc).isoformat(),
            "trigger": {
                "run_id": os.environ.get("RUN_ID", ""),
                "commit": os.environ.get("COMMIT_SHA", ""),
                "repository": os.environ.get("GITHUB_REPOSITORY", ""),
            },
            "validator": {},
            "autofix": {},
            "recommendations": [],
        }
        try:
            with open("/tmp/validator-report.json") as f:
                report["validator"] = json.load(f)
        except Exception:
            report["validator"] = {"error": "Report not available"}
        try:
            with open("/tmp/autofix-report.json") as f:
                af = json.load(f)
                report["autofix"] = af
                if af.get("auto_fixable", 0) > 0:
                    report["recommendations"].append(
                        "Run 'python3 tools/ci-validator/auto-fix.py' locally to apply automatic fixes"
                    )
                if af.get("manual_required", 0) > 0:
                    report["recommendations"].append(
                        "Manual review required for some issues — see autofix report details"
                    )
        except Exception:
            report["autofix"] = {"error": "Report not available"}
        if not report["recommendations"]:
            report["recommendations"].append(
                "No auto-fixable issues detected — review CI logs for root cause"
            )
        print("=== Consolidated Repair Report ===")
        print(json.dumps(report, indent=2))
        with open("/tmp/repair-report.json", "w") as f:
            json.dump(report, f, indent=2)
        PYEOF
