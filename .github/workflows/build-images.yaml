name: Build and Push Docker Images to GCP Artifact Registry
# Builds and pushes Docker images to GCP Artifact Registry (asia-east1).
# Triggered manually via workflow_dispatch only.
# Auth: GCP Service Account Key (secrets.GCP_SA_KEY)
on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to build (web, api, ai, gateway, or all)'
        required: true
        default: 'all'
        type: choice
        options:
          - web
          - api
          - ai
          - gateway
          - all
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

env:
  PROJECT_ID: my-project-ops-1991
  REGION: asia-east1
  REGISTRY: asia-east1-docker.pkg.dev/my-project-ops-1991/indestructibleeco
  VERSION: v1.0.0

permissions:
  contents: read

jobs:
  validate-input:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.set-services.outputs.services }}
    steps:
      - name: Set services to build
        id: set-services
        run: |
          SERVICE="${{ github.event.inputs.service }}"
          case "$SERVICE" in
            web)     echo "services=web"                    >> $GITHUB_OUTPUT ;;
            api)     echo "services=api"                    >> $GITHUB_OUTPUT ;;
            ai)      echo "services=ai"                     >> $GITHUB_OUTPUT ;;
            gateway) echo "services=gateway"                >> $GITHUB_OUTPUT ;;
            all)     echo "services=web,api,ai,gateway"     >> $GITHUB_OUTPUT ;;
          esac

  build-web:
    if: contains(needs.validate-input.outputs.services, 'web')
    needs: validate-input
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Install gcloud CLI
        run: |
          curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get update -y && sudo apt-get install -y google-cloud-cli
          echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

      - name: Authenticate to GCP
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          TMP_KEY=$(mktemp)
          echo "$GCP_SA_KEY" > "$TMP_KEY"
          gcloud auth activate-service-account --key-file="$TMP_KEY"
          gcloud config set project ${{ env.PROJECT_ID }}
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
          rm -f "$TMP_KEY"

      - name: Build and push Web image
        run: |
          docker build -t ${{ env.REGISTRY }}/web:${{ github.sha }} \
                       -t ${{ env.REGISTRY }}/web:${{ env.VERSION }} \
                       -t ${{ env.REGISTRY }}/web:latest \
                       -f platforms/web/Dockerfile \
                       platforms/web/
          docker push ${{ env.REGISTRY }}/web:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/web:${{ env.VERSION }}
          docker push ${{ env.REGISTRY }}/web:latest

  build-api:
    if: contains(needs.validate-input.outputs.services, 'api')
    needs: validate-input
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Install gcloud CLI
        run: |
          curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get update -y && sudo apt-get install -y google-cloud-cli
          echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

      - name: Authenticate to GCP
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          TMP_KEY=$(mktemp)
          echo "$GCP_SA_KEY" > "$TMP_KEY"
          gcloud auth activate-service-account --key-file="$TMP_KEY"
          gcloud config set project ${{ env.PROJECT_ID }}
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
          rm -f "$TMP_KEY"

      - name: Build and push API image
        run: |
          docker build -t ${{ env.REGISTRY }}/api:${{ github.sha }} \
                       -t ${{ env.REGISTRY }}/api:${{ env.VERSION }} \
                       -t ${{ env.REGISTRY }}/api:latest \
                       -f backend/api/Dockerfile backend/api/
          docker push ${{ env.REGISTRY }}/api:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/api:${{ env.VERSION }}
          docker push ${{ env.REGISTRY }}/api:latest

  build-ai:
    if: contains(needs.validate-input.outputs.services, 'ai')
    needs: validate-input
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Install gcloud CLI
        run: |
          curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get update -y && sudo apt-get install -y google-cloud-cli
          echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

      - name: Authenticate to GCP
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          TMP_KEY=$(mktemp)
          echo "$GCP_SA_KEY" > "$TMP_KEY"
          gcloud auth activate-service-account --key-file="$TMP_KEY"
          gcloud config set project ${{ env.PROJECT_ID }}
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
          rm -f "$TMP_KEY"

      - name: Build and push AI image
        run: |
          docker build -t ${{ env.REGISTRY }}/ai:${{ github.sha }} \
                       -t ${{ env.REGISTRY }}/ai:${{ env.VERSION }} \
                       -t ${{ env.REGISTRY }}/ai:latest \
                       backend/ai/
          docker push ${{ env.REGISTRY }}/ai:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/ai:${{ env.VERSION }}
          docker push ${{ env.REGISTRY }}/ai:latest

  build-gateway:
    if: contains(needs.validate-input.outputs.services, 'gateway')
    needs: validate-input
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Install gcloud CLI
        run: |
          curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get update -y && sudo apt-get install -y google-cloud-cli
          echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

      - name: Authenticate to GCP
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          TMP_KEY=$(mktemp)
          echo "$GCP_SA_KEY" > "$TMP_KEY"
          gcloud auth activate-service-account --key-file="$TMP_KEY"
          gcloud config set project ${{ env.PROJECT_ID }}
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
          rm -f "$TMP_KEY"

      - name: Build and push Gateway image
        run: |
          docker build -t ${{ env.REGISTRY }}/gateway:${{ github.sha }} \
                       -t ${{ env.REGISTRY }}/gateway:${{ env.VERSION }} \
                       -t ${{ env.REGISTRY }}/gateway:latest \
                       -f docker/Dockerfile .
          docker push ${{ env.REGISTRY }}/gateway:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/gateway:${{ env.VERSION }}
          docker push ${{ env.REGISTRY }}/gateway:latest
