name: Build and Push Docker Images to GCP Artifact Registry
# Builds and pushes Docker images to GCP Artifact Registry (asia-east1).
# Triggered manually via workflow_dispatch only.
# Auth: GCP Service Account Key (secrets.GCP_SA_KEY)
on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to build (web, api, ai, gateway, or all)'
        required: true
        default: 'all'
        type: choice
        options:
          - web
          - api
          - ai
          - gateway
          - all
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

env:
  PROJECT_ID: my-project-ops-1991
  REGION: asia-east1
  REGISTRY: asia-east1-docker.pkg.dev/my-project-ops-1991/eco-base
  VERSION: v1.0.0

permissions:
  contents: read

concurrency:
  group: build-images-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-input:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      services: ${{ steps.set-services.outputs.services }}
    steps:
      - name: Set services to build
        id: set-services
        run: |
          SERVICE="${{ github.event.inputs.service }}"
          case "$SERVICE" in
            web)     echo "services=web"                    >> $GITHUB_OUTPUT ;;
            api)     echo "services=api"                    >> $GITHUB_OUTPUT ;;
            ai)      echo "services=ai"                     >> $GITHUB_OUTPUT ;;
            gateway) echo "services=gateway"                >> $GITHUB_OUTPUT ;;
            all)     echo "services=web,api,ai,gateway"     >> $GITHUB_OUTPUT ;;
          esac

  build-web:
    if: contains(needs.validate-input.outputs.services, 'web')
    needs: validate-input
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Authenticate to GCP
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          USE_GKE_GCLOUD_AUTH_PLUGIN: "True"
        run: |
          TMP_DIR="$(mktemp -d)"
          chmod 700 "$TMP_DIR"
          TMP_KEY="$TMP_DIR/gcp-sa-key.json"
          echo "$GCP_SA_KEY" > "$TMP_KEY"
          chmod 600 "$TMP_KEY"
          gcloud auth activate-service-account --key-file="$TMP_KEY"
          gcloud config set project ${{ env.PROJECT_ID }}
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
          rm -rf "$TMP_DIR"

      - name: Build and push Web image
        run: |
          docker build -t ${{ env.REGISTRY }}/web:${{ github.sha }} \
                       -t ${{ env.REGISTRY }}/web:${{ env.VERSION }} \
                       -t ${{ env.REGISTRY }}/web:latest \
                       -f platforms/web/Dockerfile \
                       platforms/web/
          docker push ${{ env.REGISTRY }}/web:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/web:${{ env.VERSION }}
          docker push ${{ env.REGISTRY }}/web:latest

  build-api:
    if: contains(needs.validate-input.outputs.services, 'api')
    needs: validate-input
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Authenticate to GCP
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          USE_GKE_GCLOUD_AUTH_PLUGIN: "True"
        run: |
          TMP_DIR="$(mktemp -d)"
          chmod 700 "$TMP_DIR"
          TMP_KEY="$TMP_DIR/gcp-sa-key.json"
          echo "$GCP_SA_KEY" > "$TMP_KEY"
          chmod 600 "$TMP_KEY"
          gcloud auth activate-service-account --key-file="$TMP_KEY"
          gcloud config set project ${{ env.PROJECT_ID }}
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
          rm -rf "$TMP_DIR"

      - name: Build and push API image
        run: |
          docker build -t ${{ env.REGISTRY }}/api:${{ github.sha }} \
                       -t ${{ env.REGISTRY }}/api:${{ env.VERSION }} \
                       -t ${{ env.REGISTRY }}/api:latest \
                       -f backend/api/Dockerfile backend/api/
          docker push ${{ env.REGISTRY }}/api:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/api:${{ env.VERSION }}
          docker push ${{ env.REGISTRY }}/api:latest

  build-ai:
    if: contains(needs.validate-input.outputs.services, 'ai')
    needs: validate-input
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Authenticate to GCP
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          USE_GKE_GCLOUD_AUTH_PLUGIN: "True"
        run: |
          TMP_DIR="$(mktemp -d)"
          chmod 700 "$TMP_DIR"
          TMP_KEY="$TMP_DIR/gcp-sa-key.json"
          echo "$GCP_SA_KEY" > "$TMP_KEY"
          chmod 600 "$TMP_KEY"
          gcloud auth activate-service-account --key-file="$TMP_KEY"
          gcloud config set project ${{ env.PROJECT_ID }}
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
          rm -rf "$TMP_DIR"

      - name: Build and push AI image
        run: |
          docker build -t ${{ env.REGISTRY }}/ai:${{ github.sha }} \
                       -t ${{ env.REGISTRY }}/ai:${{ env.VERSION }} \
                       -t ${{ env.REGISTRY }}/ai:latest \
                       backend/ai/
          docker push ${{ env.REGISTRY }}/ai:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/ai:${{ env.VERSION }}
          docker push ${{ env.REGISTRY }}/ai:latest

  build-gateway:
    if: contains(needs.validate-input.outputs.services, 'gateway')
    needs: validate-input
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Authenticate to GCP
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          USE_GKE_GCLOUD_AUTH_PLUGIN: "True"
        run: |
          TMP_DIR="$(mktemp -d)"
          chmod 700 "$TMP_DIR"
          TMP_KEY="$TMP_DIR/gcp-sa-key.json"
          echo "$GCP_SA_KEY" > "$TMP_KEY"
          chmod 600 "$TMP_KEY"
          gcloud auth activate-service-account --key-file="$TMP_KEY"
          gcloud config set project ${{ env.PROJECT_ID }}
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
          rm -rf "$TMP_DIR"

      - name: Build and push Gateway image
        run: |
          docker build -t ${{ env.REGISTRY }}/gateway:${{ github.sha }} \
                       -t ${{ env.REGISTRY }}/gateway:${{ env.VERSION }} \
                       -t ${{ env.REGISTRY }}/gateway:latest \
                       -f docker/Dockerfile .
          docker push ${{ env.REGISTRY }}/gateway:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/gateway:${{ env.VERSION }}
          docker push ${{ env.REGISTRY }}/gateway:latest
