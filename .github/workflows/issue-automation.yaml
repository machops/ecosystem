name: Issue & PR Automation

on:
  schedule:
    # Run daily at 02:00 UTC to manage stale issues
    - cron: '0 2 * * *'
  issues:
    types: [opened, labeled]
  pull_request:
    types: [opened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  stale-management:
    name: Manage Stale Issues & PRs
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Stale issue management
      uses: actions/stale@5bef64f19d7facfb25b37b414482c7164d639639  # v9.1.0
      with:
        repo-token: ${{ github.token }}
        stale-issue-message: |
          This issue has been automatically marked as stale because it has not had
          recent activity. It will be closed in 14 days if no further activity occurs.
          Please comment or update the issue to keep it open.
        stale-pr-message: |
          This PR has been automatically marked as stale because it has not had
          recent activity. It will be closed in 7 days if no further activity occurs.
          Please update the PR or comment to keep it open.
        close-issue-message: |
          This issue was automatically closed due to inactivity.
          Please reopen if this is still relevant.
        close-pr-message: |
          This PR was automatically closed due to inactivity.
          Please reopen if you want to continue working on this.
        days-before-stale: 30
        days-before-close: 14
        days-before-pr-stale: 14
        days-before-pr-close: 7
        stale-issue-label: 'stale'
        stale-pr-label: 'stale'
        exempt-issue-labels: 'pinned,security,critical,in-progress'
        exempt-pr-labels: 'pinned,security,critical,in-progress'
        operations-per-run: 100

  auto-label-issues:
    name: Auto-label New Issues
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
    - name: Auto-label based on title/body
      env:
        GH_TOKEN: ${{ github.token }}
        ISSUE_TITLE: ${{ github.event.issue.title }}
        ISSUE_BODY: ${{ github.event.issue.body }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
      run: |
        python3 - << 'PYEOF'
        import os, json, urllib.request

        title = os.environ.get("ISSUE_TITLE", "").lower()
        body = os.environ.get("ISSUE_BODY", "").lower()
        issue_number = os.environ.get("ISSUE_NUMBER", "")
        token = os.environ.get("GH_TOKEN", "")
        repo = os.environ.get("GITHUB_REPOSITORY", "")
        text = title + " " + body

        labels = []

        # Security-related
        if any(k in text for k in ["security", "vulnerability", "cve", "secret", "leak", "exploit"]):
            labels.append("security")

        # CI/CD related
        if any(k in text for k in ["ci", "cd", "workflow", "action", "pipeline", "deploy"]):
            labels.append("ci/cd")

        # Bug
        if any(k in text for k in ["bug", "error", "fail", "broken", "crash", "exception"]):
            labels.append("bug")

        # Documentation
        if any(k in text for k in ["doc", "readme", "documentation", "typo", "spelling"]):
            labels.append("documentation")

        # Enhancement
        if any(k in text for k in ["feature", "enhance", "improve", "add", "request"]):
            labels.append("enhancement")

        if not labels:
            labels.append("needs-triage")

        if not labels or not token or not repo or not issue_number:
            print(f"Skipping label assignment: labels={labels}, issue={issue_number}")
            exit(0)

        url = f"https://api.github.com/repos/{repo}/issues/{issue_number}/labels"
        data = json.dumps({"labels": labels}).encode()
        req = urllib.request.Request(url, data=data, method="POST", headers={
            "Authorization": f"token {token}",
            "Accept": "application/vnd.github.v3+json",
            "Content-Type": "application/json",
        })
        try:
            with urllib.request.urlopen(req) as resp:
                print(f"Applied labels: {labels} to issue #{issue_number}")
        except Exception as e:
            print(f"Could not apply labels: {e}")
        PYEOF

  pr-auto-assign:
    name: Auto-assign PR Reviewers
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
    - name: Request review from CODEOWNERS
      env:
        GH_TOKEN: ${{ github.token }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        PR_AUTHOR: ${{ github.event.pull_request.user.login }}
      run: |
        echo "PR #$PR_NUMBER opened by $PR_AUTHOR"
        echo "Auto-review request would be configured via CODEOWNERS file"
        # Add auto-merge label for bot PRs
        if [[ "$PR_AUTHOR" == *"[bot]"* ]] || [[ "$PR_AUTHOR" == *"bot"* ]]; then
          gh pr edit "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --add-label "automated" 2>/dev/null || echo "Could not add label"
        fi
