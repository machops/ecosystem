# policies/kyverno/eco-namespace-enforce.yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: eco-namespace-enforce
  annotations:
    policies.kyverno.io/title: "Enforce ECO Namespace Specification"
    policies.kyverno.io/category: "ECO Governance"
    policies.kyverno.io/severity: "critical"
    policies.kyverno.io/description: "Ensures all resources comply with the ECO namespace, labeling, and annotation standards."
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: require-mandatory-labels
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
                - Job
                - CronJob
                - Service
                - Ingress
                - ConfigMap
                - Secret
      validate:
        message: "ECO namespace spec violation: missing mandatory labels. Refer to ECO_NAMESPACE_SPEC.md"
        pattern:
          metadata:
  labels:
    app.kubernetes.io/name: "?*"
    app.kubernetes.io/instance: "?*"
    app.kubernetes.io/version: "?*"
    app.kubernetes.io/component: "?*"
    app.kubernetes.io/part-of: "eco-base"
    eco-base/platform: "?*"
    eco-base/environment: "?*"
    eco-base/owner: "?*"

      - name: restrict-environment-values
  match:
  any:
      - resources:
  kinds:
      - Deployment
      - StatefulSet
      - DaemonSet
      - Job
      - CronJob
      - Service
      - Ingress
  validate:
  message: "eco-base/environment must be one of: production|staging|development"
  deny:
  conditions:
  any:
      - key: "{{ request.object.metadata.labels.\"eco-base/environment\" }}"
  operator: AnyNotIn
  value:
      - production
      - staging
      - development

      - name: require-mandatory-annotations
  match:
  any:
      - resources:
  kinds:
      - Deployment
      - StatefulSet
      - DaemonSet
      - Job
      - CronJob
      - Service
      - Ingress
  validate:
  message: "ECO namespace spec violation: missing mandatory annotations. Refer to ECO_NAMESPACE_SPEC.md"
  pattern:
          metadata:
  annotations:
    eco-base/uri: "?*"
    eco-base/urn: "?*"
    eco-base/governance-policy: "?*"
    eco-base/audit-log-level: "?*"

      - name: restrict-audit-log-level
  match:
  any:
      - resources:
  kinds:
      - Deployment
      - StatefulSet
      - DaemonSet
      - Job
      - CronJob
  validate:
  message: "eco-base/audit-log-level must be full|minimal"
  deny:
  conditions:
  any:
      - key: "{{ request.object.metadata.annotations.\"eco-base/audit-log-level\" }}"
  operator: AnyNotIn
  value:
      - full
      - minimal

      - name: enforce-urn-format
  match:
  any:
      - resources:
  kinds:
      - Deployment
      - StatefulSet
      - DaemonSet
      - Job
      - CronJob
      - Service
      - Ingress
  validate:
  message: "eco-base/urn must match: urn:eco-base:<type>:<platform>:<component>:<resource>:<uuidv1|sha256-...>"
  deny:
  conditions:
  any:
      - key: "{{ request.object.metadata.annotations.\"eco-base/urn\" }}"
  operator: NotMatches
  value: "^urn:eco-base:[a-z0-9-]+:[a-z0-9-]+:[a-z0-9-]+:[a-z0-9-]+:((?:[0-9a-f]{8}-[0-9a-f]{4}-1[0-9a-f]{3}-[0-9a-f]{4}-[0-9a-f]{12})|(?:sha256-[0-9a-f]{8,}))$"

      - name: enforce-uri-format
  match:
  any:
      - resources:
  kinds:
      - Deployment
      - StatefulSet
      - DaemonSet
      - Job
      - CronJob
      - Service
      - Ingress
  validate:
  message: "eco-base/uri must match: eco-base://<type>/<platform>/<component>/<resource>[?...]."
  deny:
  conditions:
  any:
      - key: "{{ request.object.metadata.annotations.\"eco-base/uri\" }}"
  operator: NotMatches
  value: "^eco-base://[a-z0-9-]+/[a-z0-9-]+/[a-z0-9-]+/.+(\\?.*)?$"
